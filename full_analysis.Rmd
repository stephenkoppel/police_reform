---
title: "Disparity Report"
author: "Stephen Koppel"
date: "`r Sys.Date()`"
output:
  
  pdf_document: default
  html_document: default
  toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r}

setwd("C:/R Projects/Police Reform/Analysis")

```

```{r}


library(tidyverse)
library(janitor)
library(lubridate)
library(ggthemes)
library(ggeasy)
library(sjmisc)
library(weights)
library(scales)
library(ggh4x)
library(showtext)
library(extrafont)
library(tidytext)
library(signs)



```

```{r}

setwd("C:/R Projects/Police Reform/Analysis")


```



```{r}

census_PD_projected <- read_csv("PD_census_with_projection.csv")

```

```{r}

PD_census_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  group_by(year, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

census_OCA_projected <- read_csv("OCA_census_with_projection.csv")

```

```{r}

OCA_census_race <- census_OCA_projected %>% 
  filter(age_group > 2) %>% 
  group_by(year, race) %>% 
  summarise(total_pop = sum(value))

```




```{r}

sqf_2013 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2013.csv") 


sqf_2013 <- sqf_2013 %>% 
  mutate(hit = if_else(arstmade == "Y"| sumissue == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(arstmade == "Y", "Y","N")) %>% 
  mutate(datestop = mdy(datestop)) %>% 
  select(date = datestop, sex, age, race, boro = city, crimsusp, frisked, searched, hit, arrest_hit, pct) 

sqf_2013 <- sqf_2013 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))


```



```{r}

sqf_2014 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2014.csv") 

sqf_2014 <- sqf_2014 %>% 
  mutate(hit = if_else(arstmade == "Y"| sumissue == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(arstmade == "Y", "Y","N")) %>% 
  mutate(datestop = mdy(datestop)) %>% 
  select(date = datestop, sex, age, race, boro = city, crimsusp, frisked, searched, hit, arrest_hit, pct) 

sqf_2014 <- sqf_2014 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))


```

```{r}

sqf_2015 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2015.csv") 

sqf_2015 <- sqf_2015 %>% 
  mutate(hit = if_else(arstmade == "Y"| sumissue == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(arstmade == "Y", "Y","N")) %>% 
  mutate(datestop = mdy(datestop)) %>% 
  select(date = datestop, sex, age, race, boro = city, crimsusp, frisked, searched, hit, arrest_hit, pct)

sqf_2015 <- sqf_2015 %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))


```

```{r}

sqf_2016 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2016.csv") 

sqf_2016 <- sqf_2016 %>% 
  mutate(hit = if_else(arstmade == "Y"| sumissue == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(arstmade == "Y", "Y","N")) %>% 
  mutate(datestop = mdy(datestop)) %>% 
  select(date = datestop, sex, age, race, boro = city, crimsusp, frisked, searched, hit, arrest_hit, pct)

sqf_2016 <- sqf_2016 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))

```


```{r}

sqf_2017 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2017.csv") 


sqf_2017 <- sqf_2017 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct) 

sqf_2017 <- sqf_2017 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(pct = as.integer(pct))

```

```{r}

sqf_2018 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2018.csv") 

sqf_2018 <- sqf_2018 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>%
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2018 <- sqf_2018 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date, format="%m/%d/%Y")) %>% 
  mutate(date = as.Date(date, format = "%Y/%m/%d")) %>% 
  mutate(pct = as.integer(pct))

```

```{r}

sqf_2019 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2019.csv") 

sqf_2019 <- sqf_2019 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2019 <- sqf_2019 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date, format="%m/%d/%Y")) %>% 
  mutate(date = as.Date(date, format = "%Y/%m/%d")) %>% 
  mutate(pct = as.integer(pct))

```

```{r}

sqf_2020 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2020.csv") 

sqf_2020 <- sqf_2020 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2020 <- sqf_2020 %>% 
  mutate(date = as.Date(date, format="%m/%d/%Y")) %>% 
  mutate(date = as.Date(date, format = "%Y/%m/%d")) %>% 
  mutate(pct = as.integer(pct))


```

```{r}

sqf_2021 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2021.csv") 

sqf_2021 <- sqf_2021 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2021 <- sqf_2021 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))

```

```{r}

sqf_2022 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2022.csv") 

sqf_2022 <- sqf_2022 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2022 <- sqf_2022 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date, format="%m/%d/%Y")) %>% 
  mutate(date = as.Date(date, format = "%Y/%m/%d")) %>% 
  mutate(pct = as.integer(pct))

```


```{r}

full_sqf <- bind_rows(sqf_2013, sqf_2014, sqf_2015, sqf_2016, sqf_2017, sqf_2018, sqf_2019, sqf_2020, sqf_2021, sqf_2022)

rm(sqf_2013, sqf_2014, sqf_2015, sqf_2016, sqf_2017, sqf_2018, sqf_2019, sqf_2020, sqf_2021, sqf_2022)

```


```{r}

full_sqf <- full_sqf %>% 
  mutate(year = year(date)) %>% 
  mutate(race = case_when(race %in% c("B", "BLACK") ~ "nhblack",
                          race %in% c("P","Q", "WHITE HISPANIC", "BLACK HISPANIC") ~ "hispanic",
                          race %in% c("W", "WHITE") ~ "nhwhite",
                          TRUE ~ "Other")) %>% 
  mutate(boro = case_when(boro == "BRONX" ~ "Bronx",
                          boro == "BROOKLYN" ~ "Brooklyn",
                          boro == "MANHATTAN" ~ "Manhattan",
                          boro == "QUEENS" ~ "Queens",
                          boro %in% c("STATEN IS", "STATEN ISLAND") ~ "Staten Island")) 

```

### Acknowledegments



### About this project




### Measuring disparities



### Data and code



### Key findings



### Pedestrian Stops by Race, 2013-2022

**Total pedestrian stops**

```{r}


full_sqf %>%
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>%
  group_by(year, race) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n)) %>% 
  mutate(race = fct_reorder(race, n)) %>%
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic()+
  theme(legend.background = element_rect(fill = "white"),
        legend.position = "top",
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        legend.key=element_blank())+
  scale_y_continuous(labels = comma)+
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = 2013: 2022) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  geom_text(aes(y = sum, label = comma(sum)), vjust = -.85, size = 2.8,  format = comma, check_overlap = TRUE) +
  expand_limits(y = 205000)





```



**Total pedestrian stops, %**

```{r}


full_sqf %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(year, percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  geom_text(aes(label = ifelse(percent > 3, paste0(percent, "%"), "")), size = 3.5, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  geom_text(aes(label = ifelse(percent < 3, paste0(percent, "%"), "")), size = 2.6, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  theme_classic() +
  theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_x_continuous(breaks = 2013: 2022)  +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks"))
```


**Pedestrian stops resulting in arrest/summons, %**

```{r}

full_sqf %>% 
  filter(!race == "Other") %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  group_by(year, race, hit) %>% 
  summarise(n = n()) %>% 
  mutate(hit_percent = n/sum(n)) %>% 
  filter(hit == "Y") %>% 
  mutate(hit_percent = as.numeric(hit_percent)) %>% 
  ggplot(aes(year, hit_percent, color = race)) +
  geom_point(size = 3) +
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent, breaks = seq(0,.5,.1)) +
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  xlab("") +
  expand_limits(y = c(0.5)) +
  labs(y = '', x = '', color = '') +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))

```




```{r}

sqf_yearly_race <- full_sqf %>% 
  filter(race != "Other",
         age > 9) %>% 
  count(year, race)

```

**Pedestrian stop rate per 100,000 people**

```{r}

left_join(sqf_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  select(year, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3)+
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,6000, 1000)) +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))



```

```{r}

# heatmap 

left_join(sqf_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1, 6:9) %>% 
  rotate_df() %>% 
  relocate(V2, .before = V1) %>% 
  write.csv(., file = "stops_rate_all.csv")



stop_rate_all <- left_join(sqf_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1, 6:9) %>% 
  rotate_df() %>% 
  rownames_to_column(var = "period") %>% 
  filter(!row_number() %in% c(1)) %>% 
  relocate(V2, .before = V1) %>% 
  rename(Black = V2, Hispanic = V1, White = V3) %>% 
  mutate_at(c("Black", "Hispanic", "White"), as.numeric) %>% 
  mutate(enforcement = "stop", .before = period) %>% 
  mutate(variable = "all", .after = enforcement)
```


**Pedestrian stop rate per 100,000 people**   
Compared to historic (2013) and recent (2019) baseline, % change


```{r}


left_join(sqf_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1, 5:6) %>% 
  pivot_longer(!race, names_to = "period", values_to = "percent") %>% 
  mutate(percent = as.numeric(percent),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  mutate(vert_just = ifelse(percent > 0, -1, 1.8)) %>% 
  ggplot(aes(percent, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = percent, color = race),
                 height = 0,
                 position = position_dodge(width = .7),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .7), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  coord_flip()+
  scale_x_continuous(labels = NULL) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1,1)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs((percent), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .7),
            size = 3)




```

**Pedestrian stop racial disparity rate ratio**


```{r}

left_join(sqf_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(nhblack/nhwhite,1),
         `Hispanic/White` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  ggplot(aes(year, value, color = race)) +
  geom_line(size = 1, key_glyph = draw_key_point) +
  geom_point(size = 2.5)+
  # geom_text(aes(label = value), position = position_nudge(y = .6), size = 3, color = "black")+
  theme_classic() +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5), 
        legend.key=element_blank()) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,12,3)) +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))

```

```{r}

# heatmap 


stop_ratio_all <- left_join(sqf_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = nhblack/nhwhite,
         `Hispanic/White` = hispanic/nhwhite) %>% 
  filter(year %in% c(2013,2019,2021,2022)) %>% 
  select(1,5:6) %>% 
  rotate_df() %>% 
  rownames_to_column(var = "race") %>% 
  mutate_at(c('V1', 'V2', 'V3', 'V4'), as.numeric) %>% 
  filter(!row_number() %in% c(1)) %>% 
  mutate(`'21 vs '13`=  V3-V1,
         `'21 vs '19` = V3-V2,
         `'22 vs '13` = V4-V1,
         `'22 vs '19` = V4-V2) %>% 
  select(1, 6:9) %>% 
  rotate_df() %>% 
  rownames_to_column(var = "period") %>% 
  filter(!row_number() %in% c(1)) %>% 
  rename(`Black/White` = V1, `Hispanic/White` = V2) %>% 
  mutate(enforcement = "stop", .before = period) %>% 
  mutate(variable = "all", .after = enforcement)


```



**Pedestrian stop racial disparity rate ratio**    
Compared to historic (2013) and recent (2019) baseline, absolute change

```{r}


left_join(sqf_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(nhblack/nhwhite,1),
         `Hispanic/White` = round(hispanic/nhwhite,1)) %>% 
  filter(year %in% c(2013, 2019, 2022)) %>% 
  select(1,5:6) %>% 
  rotate_df() %>% 
  rownames_to_column(var = "race") %>% 
  mutate_at(c('V1', 'V2', 'V3'), as.numeric) %>% 
  filter(!row_number() %in% c(1)) %>% 
  mutate(`'22 vs '13` = round(V3-V1,1),
         `'22 vs '19` = round(V3-V2,1)) %>% 
  select(1, 5:6) %>% 
  pivot_longer(!race, names_to = "period", values_to = "change") %>% 
  mutate(period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(change, period)) +
  coord_flip() +
  geom_errorbarh(aes(xmin = 0, xmax = change, color = race),
                 height = 0,
                 position = position_dodge(width = .7),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .7), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = 4.5) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(change, add_plusses = TRUE), group = race), 
            position = position_dodge(width = .7),
            size = 3,
            vjust = -1) +
  scale_x_continuous(labels = NULL)

```


### Borough breakdown

**Total pedestrian stops**  
*By borough*

```{r}

full_sqf %>%
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>%
  filter(!is.na(boro)) %>%
  group_by(year, boro, race) %>%
  summarise(n = n()) %>%
  mutate(race = fct_reorder(race, n)) %>%
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma, breaks = seq(0,80000,20000)) +
  expand_limits(y= 80000)+
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(boro), axes = "x", nrow = 2)


```


**Total pedestrian stops, %**  
*By borough*

```{r}

full_sqf %>% 
  filter(!is.na(boro)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, boro, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(boro), axes = "x", nrow = 2) 


```

**Pedestrian stops resulting in arrest/summons, %**  
*By borough*


```{r}

full_sqf %>% 
  filter(!race == "Other",
         !boro == "NA") %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  group_by(year, boro, race, hit) %>% 
  summarise(n = n()) %>% 
  mutate(hit_percent = n/sum(n)) %>% 
  filter(hit == "Y") %>% 
  mutate(hit_percent = as.numeric(hit_percent)) %>% 
  ggplot(aes(year, hit_percent, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = percent, breaks = c(0,.10,.20,.30,.40,.50))+
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(boro), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 

```


```{r}

PD_census_boro_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  mutate(boro = case_when(borough == "bronx" ~ "Bronx",
                          borough == "kings" ~ "Brooklyn",
                          borough == "manhattan" ~ "Manhattan",
                          borough == "queens" ~ "Queens",
                          borough == "si" ~ "Staten Island")) %>% 
  group_by(year, boro, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

sqf_yearly_boro_race <- full_sqf %>% 
  filter(race != "Other",
         !is.na(boro),
         age > 9) %>% 
  count(year, boro, race)

```

**Pedestrian stop rate per 100,000 people**  
*By borough*

```{r}

left_join(sqf_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, boro, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = c(0, 2500,5000,7500,10000)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(boro), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 

```

```{r}

# heatmap


stop_rate_boro <- left_join(sqf_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>%   pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
  mutate_at(c("Black", "Hispanic", "White"), as.numeric) %>%
  mutate(enforcement = "stop", .before = boro) %>% 
  rename(variable = boro)



```


**Pedestrian stop rate per 100,000 people**    
Compared to historic (2013) and recent baseline (2019), % change         
*By borough*

```{r}

left_join(sqf_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.75)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  expand_limits(x = c(-1.2,1.1)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(boro), axes = "x") +
      geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.5) 

```

**Pedestrian stop racial disparity rate ratio**  
*By borough*

```{r}

left_join(sqf_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, boro, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = nhblack/nhwhite,
         `Hispanic/White` = hispanic/nhwhite) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, boro, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3, key_glyph = draw_key_point)+
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(boro), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 



```


```{r}

# heatmap



stop_ratio_boro <- left_join(sqf_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = nhblack/nhwhite,
         `Hispanic/White` = hispanic/nhwhite) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  mutate(period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  mutate(enforcement = "stop", .before = boro) %>% 
  rename(variable = boro)
  


```


**Pedestrian stop racial disparity rate ratio**  
Compared to historic (2013) and recent (2019) baseline, absolute change  
*By borough*


```{r}

left_join(sqf_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(nhblack/nhwhite,1),
         `Hispanic/White` = round(hispanic/nhwhite,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .7),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .7), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, accuracy = .1, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .7),
            size = 3) +
  expand_limits(x = c(-2.5,7))+
  scale_x_continuous(labels = NULL) +
  facet_wrap2(vars(boro), axes = "x")


```


### Age breakdown

**Total pedestrian stops**  
*By age*

```{r}

full_sqf %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 & age <= 98 ~ "45+")) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!is.na(age_cat)) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma, breaks = seq(25000,100000, 25000)) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  expand_limits(y = 100000)


```

**Total pedestrian stops, %**  
*By age*

```{r}

full_sqf %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 & age <= 98 ~ "45+")) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!is.na(age_cat)) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))  +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) 

```

**Pedestrian stops resulting in arrest/summons, %**    
*By age*

```{r}


full_sqf %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 & age <= 98 ~ "45+")) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!race == "Other",
         !is.na(age_cat)) %>% 
  group_by(year, age_cat, race, hit) %>% 
  summarise(n = n()) %>% 
  mutate(hit_percent = n/sum(n)) %>% 
  filter(hit == "Y") %>% 
  mutate(hit_percent = as.numeric(hit_percent)) %>% 
  ggplot(aes(year, hit_percent, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  xlab("") +
  expand_limits(y = c(0,.5)) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = percent, breaks = c(0,.10,.20,.30,.40,.50))+
  
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 


```


```{r}

PD_census_age_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  mutate(age_cat = case_when(age_group >= 3 & age_group <= 5 ~ "<25",
                             age_group >= 6 & age_group <= 9 ~ "25-44",
                             age_group >= 10 ~ "45+")) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

sqf_yearly_age_race <- full_sqf %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 & age <= 98 ~ "45+")) %>% 
  filter(race != "Other",
         !is.na(age_cat)) %>% 
  count(year, age_cat, race)


```

**Pedestrian stop rate per 100,000 people**    
*By age*

```{r}

left_join(sqf_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, age_cat, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma, breaks = seq(0,15000, 5000)) + 
  xlab("") +
  expand_limits(y = c(0,15000)) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 

```

```{r}

# heatmap


stop_rate_age <- left_join(sqf_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
  mutate(enforcement = "stop", .before = age_cat) %>% 
  rename(variable = age_cat)


```



**Pedestrian stop rate per 100,000 people**  
Compared to historic (2013) and recent (2019) baseline, % change   
*By age*

```{r}

left_join(sqf_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.75)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.5) +
  expand_limits(x = c(-1.2, 1))

```

**Pedestrian stop racial disparity rate ratio**  
*By age*

```{r}

left_join(sqf_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, age_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, age_cat, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = c(0,20)) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,20,5)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 



```

```{r}

# heatmap


stop_ratio_age <- left_join(sqf_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  mutate(enforcement = "stop", .before = age_cat) %>% 
  rename(variable = age_cat)


```


**Pedestrian stop racial disparity rate ratio**  
Compared to historic (2013) and recent (2019) baseline, absolute change   
*By age*

```{r}

left_join(sqf_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(Black/White,1),
         `Hispanic/White` = round(Hispanic/White,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, accuracy = .1, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  expand_limits(x = c(-3,15))+
  scale_x_continuous(labels = NULL)+
  facet_wrap2(vars(age_cat), axes = "all", nrow = 2)


```



```{r}

violent <- c(
  'fe;/aslt',
  '1601',
  '12111',
  '16005',
  '12112 strangulation',
  'aasault',
  'abduction',
  'agg har',
  'agg har - misd',
  'agg harass',
  'agg harassment',
  'agg harr',
  'agg harrasment',
  'agg harrasmetn',
  'agg harrassment',
  'aggravated harassment',
  'aggravated harassment m',
  'aggravated harrassment',
  'asaault',
  'asault',
  'asault 3',
  'asault e',
  'aslt',
  'ass',
  'ass 3',
  'ass2',
  'ass3',
  'assaault',
  'assalt 3',
  'assaltl',
  'assalult',
  'assalut',
  'assasult',
  'assau;t',
  'assauklt',
  'assauklt 3',
  'assaukt',
  'assaul',
  'assaulat',
  'assauly',
  'assauslt female shot',
  'assaut',
  'assautl',
  'asslt',
  'asslt 2',
  'asssault',
  'asssault misd',
  'asssult 3',
  'assualt',
  'assualt 1',
  'assualt 2',
  'assualt 3',
  'assualt avenue',
  'assualt1',
  'assualt3',
  'assult',
  'assult 1/tos',
  'assult 3',
  'assult/misd',
  'att abduction',
  'attemoted robbert',
  'attempted kidnapping',
  'attempted rob',
  'child abductin/kidnapping',
  'child abduction',
  'child abduction (poss)',
  'com rob',
  'crim ob breathe / menacing',
  'fel  / rob',
  'fel / rob',
  'fel ass',
  'fel glfa',
  'fel menacing w/knife',
  'fel possible kidnapping',
  'fel ro',
  'fel/16015',
  'fel/aslt',
  'fel/assualt',
  'fel/att robb',
  'fel/kidnapping',
  'fel/rob',
  'fel/robb',
  'fel/robb (patt #90)',
  'fel/rpobbery',
  'felony- (menacing)',
  'felony/assult',
  'felony/reckless endangerment',
  'felony/robb',
  'felony/robbedry',
  'felony/robber',
  'felony/robberey',
  'felony/robberfy',
  'felony/robberty',
  'felony/robberu',
  'felony/robbry',
  'g/l jostling',
  'gang asault',
  'gang assualt',
  'gang/kidnapping',
  'harasment',
  'harassment',
  'harassment (misd)',
  'harassment (radio run)',
  'harassment/stalking',
  'harr',
  'harrasment',
  'harrasment 1',
  'harrasment 1st',
  'harrassment',
  'inciting riot',
  'jostling',
  'jostling/forcible touching',
  'kiddnapping',
  'kidnap',
  'kidnapping',
  'kidnapping misd',
  'kidnapping/ child abduction',
  'meanacing',
  'meancing',
  'menacing',
  'menacing (criminal mischief',
  'menacing misd',
  'menacing with a dog',
  'menacing/ misdemeanor',
  'menancing',
  'mencaing',
  'mienacing',
  'mis/agg harassment',
  'mis/assaulr',
  'mis/asssault',
  'mis/assualt',
  'mis/assult',
  'mis/menacing',
  'mis/reckless endanger',
  'mis/reckless endangerment',
  'mis/reckless endangermet',
  'mis/recklessvend',
  'misd - (menacing)',
  'misd - (stalking)',
  'misd  / reckless endagerment',
  'misd  / reckless endangerment',
  'misd (stalking)',
  'misd/agg harass',
  'misd/aslt',
  'misd/menacing',
  'misd/reckless',
  'misd/reckless endan',
  'misd/reckless endangerment',
  'misdemeanor crim obstruct bre',
  'mva fatal left scene',
  'obstruction of breathin',
  'phisical fight',
  'physical fight',
  'pl 12000 aslt',
  'pl 160',
  'pl 16015 sub 2',
  'poss asssault',
  'possible child abductio',
  'rbbery',
  'reck',
  'reck end',
  'reck endanger',
  'reckeless endangerment',
  'recklass endangerment',
  'reckless enagerment',
  'reckless endagerment',
  'reckless endanderment felon',
  'reckless endangement',
  'reckless endanger',
  'reckless endangermen',
  'reckless endangerment',
  'reckless endangerment /',
  'reckless endangerment / shots',
  'reckless endangerment misd',
  'reckless endargment',
  'reckless endeangerment',
  'reckless endengerment',
  'recklessendangerment',
  'recless endag',
  'recless endangerment',
  'redkess endangerment',
  'rel/robb',
  'resisting',
  'resisting arrest',
  'rib',
  'riobbery',
  'riot',
  'ro bbery',
  'rob',
  'rob - fel',
  'rob 3 16000',
  'rob pattern',
  'rob/cscs',
  'rob/gl',
  'rob/gun',
  'rob`',
  'robb',
  'robb (fel)',
  'robb/',
  'robbary',
  'robbbery',
  'robber',
  'robber y',
  'robber/gl',
  'robberey',
  'robberies',
  'robberry',
  'robbert',
  'robberty',
  'robberuy',
  'robbety',
  'robbey',
  'robbey (fel)',
  'robbrer',
  'robbrery',
  'robbrey',
  'robbrry',
  'robbry',
  'robbwey',
  'robbwry',
  'robby',
  'robebry',
  'robeery (fel)',
  'roberry',
  'roberry (felony)',
  'robery',
  'robery /w knife',
  'rob-fel',
  'ron',
  'ronnery',
  'roobery',
  'ropb',
  'ropbery',
  'stabbing',
  'stalking',
  'stalking (misd)',
  'stalking (misdemeanor)',
  'stalking/harassment',
  'stalking/sexual abuse',
  'stragulation',
  'strangulation',
  'strangulation-felony',
  'unlawful imprisoment (f)',
  'unlawful imprisonmen',
  'unlawful imprisonment',
  'unlawful imprisonment misd',
  'unlawful imprsonment',
  'unlawfull imprisonment',
  'unlunlawful imprison',
  'vehicular manslaughter',
  'violation oop/menacing w/ w',
  'wanted for menacing po')

```


```{r}

weapon <- c(
  'gravity knife',
  'gun',
  'gun possession',
  'gun run',
  '10-10 man w/a gun',
  '10-10 shots fired',
  '1034 (shooting)',
  '10-34 male shot',
  '34-52 w/knife',
  'c pw',
  'c[w',
  'cpe shots fired',
  'crim poss of wpn',
  'crim poss wpn',
  'crim possession of a w',
  'criminal posession of a weapo',
  'criminal poss wpn',
  'criminal possesion or a wea',
  'criminal possesion weap',
  'criminal possession of a fire',
  'criminal possession of a we',
  'criminal possession of a weap',
  'criminal possession of a weapo',
  'criminal possession of w',
  'criminal possession of weap',
  'criminal possession w',
  'criminal possession wea',
  'criminal possession weaon',
  'crimnal possession of weapo',
  'cw',
  'cwp',
  'cwp (fel)',
  'cwp/robb',
  'fekl',
  'fel   /c pw',
  'fel  /c pw',
  'fel (shots fired)',
  'fel shots fired',
  'fel/cpfi',
  'fel/radio run shots f',
  'felony (shots fired)',
  'felony gun possession',
  'felony gun run',
  'felony/shooting',
  'felony-investigate shots fired',
  'fire arm',
  'investigation in shooting /',
  'male with gun',
  'man w/gun',
  'menacing w/ knife',
  'menacing w/a knife',
  'menacing with gun',
  'menacing with knife',
  'misd/unlawfully dealing w/f',
  'poss fire arm',
  'possession of exposive device',
  'possession of knife',
  'possesssion of explosive devic',
  'pw',
  'shooting',
  'shots fired',
  'shots fired 10-10'
)

```

```{r}

property <- c(
  '1402',
  '1553',
  '1703',
  '14020',
  '14025',
  '15525',
  '15530',
  '16516',
  '16515 (3)',
  '16515(3) misd',
  'arson',
  'birg;aru',
  'bnurg',
  'brug',
  'bug',
  'bugrlary',
  'bur',
  'burb',
  'burblary',
  'burlargy',
  'burlary',
  'burlgary',
  'c/ mischief',
  'chain snatch',
  'check fraud',
  'ciminal mischief',
  'com',
  'counterfeit currency',
  'countifeit currency',
  'cp of stolen property',
  'cpfi',
  'cpfi / cpm',
  'cpfi/gl',
  'cpforged instrument',
  'cpsm',
  'cpsp',
  'cpsp  pl 16540',
  'cpsp (bike)',
  'cpsp(5)',
  'cpsp/bicycle',
  'cpsp/crim mis',
  'cpsp/pet l',
  'cpsp/pl',
  'cpsp`',
  'cpsp5',
  'criiminal mischief',
  'crim  mis',
  'crim  mischief',
  'crim imis',
  'crim mis',
  'crim mis  mis',
  'crim mis  misd',
  'crim mis (felony)',
  'crim mis (misd)',
  'crim mis /felony',
  'crim mis fel',
  'crim mis misd',
  'crim mis misdemeanor petit lar',
  'crim mis misdemenor',
  'crim misachief',
  'crim misc',
  'crim misch',
  'crim mischeif',
  'crim mischief',
  'crim mischief felony',
  'crim mischief/ petit',
  'crim misf',
  'crim misq',
  'crim mmis',
  'crim mtress',
  'crim pos  of stolen p',
  'crim pos stolen property',
  'crim poss forg inst',
  'crim poss forge instrument',
  'crim poss forged inst',
  'crim poss forged instru',
  'crim poss forged instrument',
  'crim poss of a forged i',
  'crim poss of forged inst',
  'crim poss of forged instrum',
  'crim poss of stolen pro',
  'crim poss of stolen prop',
  'crim poss of stolen propert',
  'crim poss of stolen property',
  'crim poss prop',
  'crim poss stolen pro',
  'crim poss stolen prop',
  'crim poss stolen proper',
  'crim poss stolen propert',
  'crim poss stolen property',
  'crim possesion of stolen pr',
  'crim tamp',
  'crim tamper',
  'crim tampering',
  'crim/mis',
  'crimial mischief',
  'crimianal mischief',
  'crimianl mischief',
  'criminal cischief',
  'criminal michief',
  'criminal micshief',
  'criminal miischief',
  'criminal mis',
  'criminal mis/ rec',
  'criminal mis/ reckles',
  'criminal misc',
  'criminal misch',
  'criminal mischeif',
  'criminal mischied (m',
  'criminal mischief',
  'criminal mischief (m',
  'criminal mischief (misd)',
  'criminal mischief / cpcs',
  'criminal mischief 3',
  'criminal mischief felony r',
  'criminal mischief gl',
  'criminal mischief mi',
  'criminal mischief mis',
  'criminal mischief pl',
  'criminal mischief to au',
  'criminal mischief/ass',
  'criminal mischief/petit',
  'criminal mischief/petit lar',
  'criminal mischieff',
  'criminal mischief-mis',
  'criminal mischieft',
  'criminal mischieg',
  'criminal mischif',
  'criminal mischifef',
  'criminal miscief',
  'criminal misf',
  'criminal mishchief',
  'criminal mishcief',
  'criminal msi',
  'criminal poss of forged',
  'criminal poss of forged inst',
  'criminal poss of stolen prop',
  'criminal poss of stolen prope',
  'criminal poss stolen p',
  'criminal poss stolen property',
  'criminal possesion of stole',
  'criminal possession  of stolen',
  'criminal possession forged in',
  'criminal possession of forged',
  'criminal possession of forged instrument',
  'criminal possession of stolen',
  'criminal possession sto',
  'criminal tamp',
  'criminal tampering',
  'criminalmischief',
  'criminial mischief',
  'crimmis',
  'crimmisc',
  'crimnal mis',
  'crimnal mischief',
  'crimnal tampering',
  'crimonal mischielf',
  'crimpossstolen prop',
  'crimtamp',
  'crininal mischief',
  'crm mis',
  'crminal mischief',
  'crom poss stolen property',
  'fel  glfa',
  'fel / forgery',
  'fel glfp',
  'fel plfa',
  'fel/arson',
  'fel/cpsp',
  'fel/crim mis',
  'fel/forgery',
  'fel/g/l',
  'fel/gl',
  'fel/glfa',
  'fel/glfp',
  'felgl',
  'felglfa',
  'felony - lushworker',
  'felony (glfa)',
  'felony (rims)',
  'felony -(rims)',
  'felony cpsp',
  'felony glfa',
  'felony grand from au',
  'felony/buyrg',
  'felony/byrg',
  'felony/cpsp',
  'felony/home invasion',
  'fgrand',
  'forge instrument',
  'forged document',
  'forged instrument',
  'forged instrumnet',
  'forged intrument',
  'forgeed instrument',
  'forgery',
  'forgery of vin',
  'forgery plate',
  'forgery/cpsp',
  'fraud',
  'fraudulent instruments',
  'g l',
  'g/',
  'g/l',
  'g/lg',
  'gal (fel)',
  'garnd',
  'gl',
  'gl (fel)',
  'gl / cpsp',
  'gl lushworker',
  'gl/ cpsp',
  'glla',
  'gls',
  'gpa',
  'gran',
  'gran l;arc',
  'grand',
  'grand alrceny',
  'grand l;arceny',
  'grand la rc',
  'grand laerc',
  'grand lafceny',
  'grand lanceny',
  'grand lar',
  'grand lardceny',
  'grand lareceny',
  'grand larecny',
  'grand lareny',
  'grand larfceny',
  'grand largency',
  'grand lrceny',
  'grand lsarceny',
  'grla',
  'gta',
  'high incident gl & p/c (cas',
  'high incident of g/l  & p/l',
  'high incident of gl & p/l(c',
  'id theft',
  'identity theft',
  'illegal vin possession',
  'jump turnstile - crim t',
  'largeny',
  'larrceny',
  'lushworker',
  'mim mischief',
  'mis tos',
  'mis/cpfi',
  'mis/cpsp',
  'mis/crim  mis',
  'mis/crim mis',
  'mis/plfa',
  'mis/tos',
  'misd  / crim mischief',
  'misd  / theft of service',
  'misd  / theft of sevice',
  'misd - selling swipe',
  'misd (glfa)',
  'misd (plfa)',
  'misd /  poss stolen prop',
  'misd / cpsp',
  'misd / crim mis',
  'misd / criminal misch',
  'misd / criminal mischief',
  'misd / theft of services',
  'misd / tos',
  'misd 16515(3)',
  'misd- 16516 swiping',
  'misd crim mis',
  'misd criminal mischief',
  'misd glfa',
  'misd p/l',
  'misd plfa',
  'misd -swiping 16516',
  'misd(scrap metal)',
  'misd/ theft of service',
  'misd/(scrap metal)',
  'misd/arson',
  'misd/cpsp',
  'misd/crim mis',
  'misd/pl',
  'misd/plfa',
  'misd/tos',
  'misd/unlaw sale fare me',
  'misdemeanor- 16516',
  'misdemeanor cpm',
  'misdemeanor/cpsp',
  'misdemeanor-16516 swiping',
  'misdemeanor-swiping 16516',
  'misd-selling swipes',
  'misd-swiping',
  'misd-swiping 16516',
  'p/l',
  'p/l   swipes',
  'p/l  160',
  'p/l  17025',
  'p/l  swipes',
  'p/l 12015',
  'p/l swipes',
  'p/lp',
  'petit',
  'petit  larfceny',
  'petit ;arceny',
  'petit laceny',
  'petit lafceny',
  'petit lar',
  'petit lardceny',
  'petit larecny',
  'petit larxc',
  'petot',
  'petpt',
  'petti',
  'pl',
  'pl 15525',
  'pl 16515',
  'pl 16515 (3)',
  'pl 16515(3)',
  'pl 16516',
  'pl 17020',
  'pl 47010',
  'pl17030',
  'plfa',
  'plfel',
  'poss forg inst 17025',
  'poss forged inst',
  'poss forged instrument',
  'poss of forged instrument',
  'poss of stolen property',
  'possession of a forge',
  'possession of forged ins',
  'possession of forged instru',
  'possession of forged instrumen',
  'possession of stolen',
  'possession of stolen party',
  'possession of stolen prop',
  'sale of transportation',
  'selling swipe',
  'selling swipes',
  'selling swipes 16516',
  'sellling swipe',
  'spsp',
  'stolen license plate',
  'stolen m/v plate reader',
  'stolen property',
  'suto dtripping',
  'swipe',
  'swiper',
  'swiping',
  'swiping 16515',
  'swiping fare media',
  'swipping',
  'theft  of  service',
  'theft of service',
  'theft of service (cab)',
  'theft of service (mis',
  'theft of services',
  'theft of services(pl 16',
  'theft ofservices',
  'theftt of service',
  'thefty of service',
  'tire/rims',
  'tires/rims',
  'tos',
  'tos / 16515',
  'tos/ criminal tresspass',
  'transit theft of services',
  'unauthorize sale of fare me',
  'unauthorized sale  of f',
  'unauthorized sale fare',
  'unauthorized sale of',
  'unauthorized sale of fa',
  'unauthorized sale of far',
  'unauthorized sale of fare c',
  'unauthorized saqle of fare',
  'usf  / 16516',
  'usfm/crim misc',
  'usfm/gl',
  'misd - 15525'
)

```


```{r}

drug <- c(
  '2203',
  '2211',
  '2214',
  '22003',
  '22006',
  '22010',
  '22016',
  '22039',
  '22105',
  '22110',
  '22135',
  '22140',
  '22039 / 22140',
  '22039 felony',
  '22039 pl',
  '221-10',
  '22110 cpm',
  '22110 misd',
  '22140 misd',
  'ccrim sale cont subs',
  'ciminal sale controlled sub',
  'cp/cs',
  'cpccs',
  'cpcp',
  'cpcs',
  'cpcs  misd',
  'cpcs & cpm',
  'cpcs / cpm',
  'cpcs / cscs',
  'cpcs /cscs',
  'cpcs 5',
  'cpcs 7',
  'cpcs 7 (misd)',
  'cpcs 7 degree',
  'cpcs 7th',
  'cpcs 7th (misd)',
  'cpcs cpm',
  'cpcs fel',
  'cpcs felony',
  'cpcs misd',
  'cpcs misd 22003',
  'cpcs row',
  'cpcs sale',
  'cpcs/cpm',
  'cpcs/cpm misd',
  'cpcs/cscs',
  'cpcs/ct',
  'cpcs/misd',
  'cpcs5',
  'cpcs7',
  'cpcs-7',
  'cpcs7 (misd)',
  'cpcscscs',
  'cpcss/cscs',
  'cpcs-sale',
  'cpcst',
  'cpm',
  'cpm  / csm',
  'cpm  misd',
  'cpm - misd',
  'cpm (misd)',
  'cpm (misdemeanor)',
  'cpm / cpcs',
  'cpm / crim mischief',
  'cpm / criminal mischief',
  'cpm / cscs',
  'cpm / csm',
  'cpm / endanger child',
  'cpm / robber',
  'cpm /cpcs',
  'cpm /misd',
  'cpm 22110',
  'cpm 3',
  'cpm 5',
  'cpm 5 degree',
  'cpm 5 misd',
  'cpm 5th',
  'cpm ct',
  'cpm mis',
  'cpm misd',
  'cpm sale',
  'cpm(plain view)',
  'cpm/ cpcs',
  'cpm/ ct',
  'cpm/ radio run',
  'cpm/c/t',
  'cpm/cpcs',
  'cpm/cpcs misd',
  'cpm/cpfi',
  'cpm/criminal tres',
  'cpm/cscs',
  'cpm/csm',
  'cpm/ct',
  'cpm/graffiti',
  'cpm/oga',
  'cpm/row',
  'cpm/sale',
  'cpm/tamp w/phys evidence',
  'cpm/upm',
  'cpm5',
  'cpm5 m',
  'cpm5/ct',
  'cpmc',
  'cpmcpfi',
  'cpmcpn',
  'cpm-mis',
  'cpm-sale',
  'cpm-tresspass(crim)',
  'cri sale cont sub',
  'crim cont sub',
  'crim poss cont sub',
  'crim poss cont subs1/money ln',
  'crim poss contr sub',
  'crim poss contr subtanc',
  'crim poss control sub',
  'crim poss controlled',
  'crim poss controlled su',
  'crim poss cpn',
  'crim poss marj',
  'crim poss of a controlld su',
  'crim poss of control substa',
  'crim poss of controlled',
  'crim poss of controlled subs',
  'crim poss of mari',
  'crim poss scontr sub',
  'crim possesion of contr',
  'crim sale',
  'crim sale con sub',
  'crim sale con subs',
  'crim sale cont sub',
  'crim sale cont sub/crim',
  'crim sale cont subst',
  'crim sale control sub',
  'crim sale control subst',
  'crim sale controll subs',
  'crim sale controlled',
  'crim sale controlled su',
  'crim sale controlled substa',
  'crim sale cpnt sub',
  'crim sale cs',
  'crim sale dont sub',
  'crim sale marj',
  'crim sale marjuana',
  'crim sale of control',
  'crim sale of controlled',
  'crim sale of controlled sub',
  'crim sale of cs',
  'criminal  possession ma',
  'criminal diversion',
  'criminal diversion sale',
  'criminal poss control subst',
  'criminal poss controlled su',
  'criminal poss of a contr su',
  'criminal poss of contro',
  'criminal possession con',
  'criminal possession control',
  'criminal possession mar',
  'criminal possession of mari',
  'criminal sale',
  'criminal sale  contro',
  'criminal sale  of ma',
  'criminal sale control',
  'criminal sale control s',
  'criminal sale control subst',
  'criminal sale controlle',
  'criminal sale controlled su',
  'criminal sale controlled subst',
  'criminal sale cs',
  'criminal sale of a con-substn',
  'criminal sale of c s',
  'criminal sale of cont',
  'criminal sale of contro',
  'criminal sale of control su',
  'criminal sale of control sub',
  'criminal sale of controlled',
  'criminal sale of controlled su',
  'criminal sale of mar',
  'criminal sale of mari',
  'criminal sell of crimin',
  'crimposs contrl sub fel',
  'crm sale of control s',
  'crp',
  'crpm',
  'crug sales',
  'csc',
  'cscs',
  'cscs  (felony)',
  'cscs  / csm',
  'cscs (felony)',
  'cscs / cpcs',
  'cscs 3',
  'cscs 7',
  'cscs csm',
  'cscs ct',
  'cscs fel',
  'cscs misd',
  'cscs sales',
  'cscs/cpc',
  'cscs/cpcs',
  'cscs/cpm',
  'cscs/ct',
  'cscs/graffiti',
  'cscs`',
  'cscscpcscpm',
  'csm',
  'csm / cpm',
  'csm/cpm',
  'csps',
  'cssp',
  'ct cpcs',
  'ct cpm',
  'ct/cpcs',
  'ct/cpcs7 (misd)',
  'ct/cpm',
  'ctcpcs',
  'ctcpcs 7',
  'ctcpcscscs',
  'ctcpm',
  'ctcscs',
  'cxcs',
  'dug sales',
  'fel  /  cpcs',
  'fel  / cpcs',
  'fel  / cpm5',
  'fel  / cscs',
  'fel/cpcs',
  'fel/cpm',
  'fel/cscs',
  'fel/csm',
  'fel0ny/csm',
  'felony 22039',
  'felony cscs',
  'felony cscs/cpcs',
  'felony/csm',
  'mids/cpm',
  'mis cpm',
  'mis/cpcs',
  'mis/cpm',
  'mis/cscs',
  'mis/csm',
  'miscpm',
  'misd     cpm',
  'misd   / cscs',
  'misd  / ccpm',
  'misd  / cpcs',
  'misd  / cpm',
  'misd  / cscs',
  'misd  // cscs',
  'misd -(cpsp)',
  'misd / 22110 crim pos m',
  'misd / cpcs',
  'misd / cpm',
  'misd / cpm (h2h)',
  'misd / cpm 5',
  'misd / cscs',
  'misd / csm',
  'misd // cscs',
  'misd /cpcs',
  'misd csm',
  'misd/ cpcs',
  'misd/ cpm 5',
  'misd/14015/cpm',
  'misd/cpcs',
  'misd/cpcs/cscs',
  'misd/cpm',
  'misd/cscs',
  'misd/csm',
  'misdemanor-cpm',
  'misdemeanor pl 22003 cpcs',
  'misdemeanor/511',
  'narc sales',
  'nis/cpcs',
  'pl 220',
  'pl 22003 crim poss contr s',
  'pl 22020(8)',
  'pl 22031',
  'pl 22039',
  'pl 22110',
  'pl 22135',
  'pl 22140',
  'pl 22o',
  'pl22020 (2)',
  'pl22031 crimsale of consub',
  'pl22031 cscs',
  'poss ct',
  'poss of controll substa',
  'poss of controlled subs',
  'reckless driving cpsp',
  'sale cpcs',
  'uuv/cpm')

```


```{r}

trespass <- c(
  'felony-(crimtres)',
  '1401',
  '14010',
  '14015',
  '14010 / 49010',
  'ciminal tresspass',
  'cri m tres',
  'cri m tress',
  'cri tres',
  'cri tress',
  'crim  tres',
  'crim  tress',
  'crim  tresss',
  'crim t ress',
  'crim tesspass',
  'crim tr es',
  'crim tre',
  'crim treapass',
  'crim treas',
  'crim treaspass',
  'crim trepass',
  'crim treps',
  'crim trew',
  'crim trews',
  'crim tris',
  'crim trs',
  'crim trses',
  'crim trss',
  'crim tyress',
  'crimal tresspass',
  'crime trepass',
  'crime tress',
  'crimi tress',
  'crimilal tress',
  'crimimnal tress',
  'crimina tres',
  'crimina tresspass / sxm',
  'criminal  tress pass',
  'criminal tespass',
  'criminal traspass',
  'criminal treapass',
  'criminal trepass',
  'criminal treprass',
  'criminal tres',
  'criminal tres misd',
  'criminal tres pass',
  'criminal tress',
  'criminal tress pass',
  'criminal tresspas',
  'criminal tresspass',
  'criminal tresspass cpcs',
  'criminal tresspass misd',
  'criminal tresspass/cp',
  'criminal tresspassing',
  'criminal tresspassing/',
  'criminal tresspasss',
  'criminal tressppass',
  'criminal trspass',
  'criminaltrepass',
  'criminaltresspass',
  'criminial tresspasas',
  'crimininal tresspass',
  'crimintal tresspass',
  'crimj tres',
  'crimnal tress',
  'crimnial tresspass',
  'crimtraps',
  'crimtres',
  'crim-tres',
  'crimtress',
  'crimtrss',
  'crinm tres',
  'crinminal trepass',
  'criom tres',
  'crm tres',
  'crm tress',
  'ct',
  'ct (misd)',
  'ct 14010',
  'ct misd',
  'ct pl 14010',
  'mis/crim tes',
  'misd  /criminal tresspa',
  'misd / criminal traspassing',
  'misd / criminal tres / cpm5',
  'misd / criminal tress',
  'misd / criminal tresspa',
  'misd / tresspassing',
  'misd ct',
  'misd/crim trea',
  'misd/trspass',
  'pl 14010',
  'pl 14010e',
  'pl 14015',
  'traspass',
  'trepass',
  'tres',
  'tres passing criminal',
  'tress',
  'tress pass',
  'tresspass',
  'tresspass criminal',
  'tresspass/cpm',
  'tresspass/graffiti',
  'tresspasscriminal',
  'tresspassing',
  'trspass',
  'trss'
)

```


```{r}

qol <- c(
  '270',
  '14560 making graffiti',
  'aggressive panhandlin',
  'counterfeit trademark',
  'counterfeit/piracy',
  'counterfiet merchandise',
  'crim mis graffiti',
  'crim mis pl 145o0',
  'crim mis/graffiti',
  'crim mis/poss of graffiti i',
  'crim misc/ graffiti',
  'criminal mis/makeing grafitti',
  'criminal mischief graffi',
  'criminal nuisance',
  'dis con',
  'dis con - fighting',
  'discon',
  'disorderly',
  'disorderly conduct',
  'felony/graffiti',
  'fireworks',
  'frad acosting',
  'fraud accosting',
  'fraudlent accosting',
  'fraudulant accosting',
  'fraudulent accostin',
  'fraudulent accosting',
  'fraudulent acosting',
  'gaffiti',
  'gambling',
  'gambling misd',
  'garfitti',
  'gmabling',
  'grafffiti',
  'graffit',
  'graffiti',
  'graffiti instrument',
  'graffiti making',
  'graffiti misd',
  'graffitii',
  'graffitit',
  'graffitt',
  'graffitti',
  'graffitti-felony',
  'graffti',
  'grafiti',
  'grafitti',
  'graggitti',
  'greafitti',
  'griffiti',
  'hnlawful sale of fare media',
  'loit for pros',
  'loitering',
  'loitering for prostitio',
  'loitering for prostitut',
  'make graffiti',
  'makeing graffiti',
  'makin graffitti',
  'making  graffiti',
  'making a false statement',
  'making fraffitti',
  'making graaffiti',
  'making graffit',
  'making graffiti',
  'making graffiti (mis',
  'making graffiti (misd)',
  'making graffiti misd',
  'making graffiti pl 145',
  'making graffitii',
  'making graffitti',
  'making grafifiti',
  'making grafitti',
  'making grafitti (misd',
  'making raffiti',
  'manking graffiti',
  'marking graffiti',
  'mis/frafitti',
  'mis/graffiti',
  'mis/graffitti',
  'mis/grafitti',
  'mis/making graffitti',
  'mis/trademark counterfe',
  'mis/unlawful assembly',
  'misd  / graffiti',
  'misd  / makin grafitti',
  'misd  / making graffiti',
  'misd / graffiti',
  'misd / making graffi',
  'misd / making graffiti',
  'misd / making grafitti',
  'misd / oga/discon',
  'misd 25045 unlawfull s',
  'misd graffiti',
  'misd/ dis con',
  'misd/graffit',
  'misd/graffiti',
  'misd/grafitti',
  'misd/making grafitti',
  'misd/ulw surveilance',
  'misd/unlaw surveilance',
  'misd/unlaw surveliance',
  'misd/unlawful survielance',
  'misd/unlw surveilance',
  'misd/usf media',
  'misd/usfc',
  'misd/usfm',
  'mmaking graffiti',
  'obscenity',
  'obstructing',
  'open container',
  'open container of alcoh',
  'other/unlawful surveillance',
  'pl 25045',
  'pl24020 (2)',
  'posession graffiti tool',
  'poss of graffiti instru',
  'possesion of fireworks',
  'possession of graffiti inst',
  'possession of graffiti instrum',
  'possgraffiti instruments',
  'prohibited sale of alco',
  'promote gambling',
  'promoting',
  'promoting gamblinb',
  'promoting gambling',
  'promotong gambling',
  'proposed gambling',
  'public intox / drinking',
  'sale of counterfeit dvd',
  'sale of fare media (mis',
  'sale of foreworks',
  'sale of untaxed cigarette',
  'sidewalk',
  'solicitation support',
  'trade mark counterfeit',
  'trade market counterf',
  'tradeamark counterfeit',
  'trademaek counterfit',
  'trademark countereiting',
  'trademark counterfei',
  'trademark counterfeit',
  'trademark counterfeitin',
  'trademark counterfeiting',
  'trademark counterffeit',
  'trademark counterfit',
  'trademark countergeiting',
  'tradmark counterfeiti',
  'unauthorized recording',
  'unauthorized recording/photos',
  'unauthorsale of fare m',
  'unlaeful sale of media',
  'unlawful assembley',
  'unlawful assembly',
  'unlawful assemly',
  'unlawful dealing with firework',
  'unlawful poss of fireworks',
  'unlawful possession of firewor',
  'unlawful sale  of fare medi',
  'unlawful sale of fare m',
  'unlawful sale of fare media',
  'unlawful solicitation',
  'unlawful survallance',
  'unlawful surveilance',
  'unlawful surveillanc',
  'unlawful surveillance',
  'unlawful surveillane',
  'unlawful surveillanve',
  'unlawful use fare media',
  'unlawfull surviellance',
  'unlawfully dealing with fir',
  'unlawfulof fare media',
  'unlic general vendor',
  'unlicensed general vending',
  'untaxed cigarette',
  'untaxed cigarettes',
  'unuahtorized sale of',
  'unuathorized sale of',
  'urinating in public',
  'usfc',
  'usfm',
  'usfm['
)


```

```{r}
other <- c(
  '490',
  '511',
  '1034',
  '4901',
  '31-Oct',
  '31-Oct',
  '49010',
  '(fel/misd',
  '(fel/misd)',
  '110 pattern 4l',
  '32 veh',
  '49025 fleony',
  'actual stop on w 154 st  f',
  'agg unlic oprt',
  'ah',
  'apw',
  'bail jumping',
  'c scs',
  'c/t',
  'c[',
  'casing',
  'castro',
  'cel',
  'cerim mis',
  'cfi',
  'child abuse',
  'child endangerment',
  'child neglection',
  'ci harassment',
  'cisd',
  'cla',
  'cmp',
  'coercion',
  'conspiracy',
  'contempt of court',
  'cow',
  'cp',
  'cpe',
  'cpncpm',
  'cppm',
  'cps',
  'cpsc',
  'cpsc7',
  'cpu',
  'crcs',
  'crim',
  'crim comptempt',
  'crim cont',
  'crim contemp',
  'crim contempt',
  'crim contempt court',
  'crim impersonation',
  'crim impersonation of a pol',
  'crim impersontation',
  'crim sex act felony',
  'crim-contempt',
  'crime contempt',
  'crimi',
  'crimial impersoantio',
  'criminal',
  'criminal conduct',
  'criminal contemopt',
  'criminal contempt',
  'criminal contempt / voop',
  'criminal impersination',
  'criminal impersonati',
  'criminal impersonatio',
  'criminal impersonation',
  'criminal impersonation of a p',
  'criminal inpersonati',
  'criminal justice',
  'criminal misd',
  'criminal obstruction of',
  'criminal personation',
  'criminal posession o',
  'criminal possesion o',
  'criminal possesion of a',
  'criminal possesion of g',
  'criminal possesion of s',
  'criminal possession',
  'criminal possession o',
  'criminal possession of',
  'criminal sexual act',
  'csca',
  'cscc',
  'cscp (felony)',
  'custodial interferance',
  'del',
  'delony',
  'destroy/ alter vin plat',
  'dfel',
  'disregarding crime scene',
  'domestic dispute',
  'dui',
  'dwi',
  'efl',
  'eflony',
  'el',
  'elony',
  'end welfare of a child',
  'endang welfare child',
  'endanger the welfare',
  'endanger the welfare of',
  'endanger the welfare of a c',
  'endanger the welfare of child',
  'endanger the welfare ofa ch',
  'endanger welfare',
  'endanger welfare chil',
  'endangering the welfare',
  'endangering the welfare child',
  'endangering welfare',
  'endangering welfare for',
  'endangering welfare of',
  'endangering welfare of a ch',
  'endangering welfare of a child',
  'endangerment of child',
  'escape',
  'escape 2',
  'escape prisoner',
  'escaped prisoner',
  'f',
  'false impersonation',
  'false impersontation',
  'false personation',
  'false report',
  'fe',
  'fe;',
  'fe;pmu',
  'fed',
  'fef',
  'fefl',
  'fek',
  'fekibt',
  'fel  / bench warrant',
  'fel  / fel',
  'fel  / vop',
  'fel ( criminal imperson',
  'fel / misd',
  'fel cp chemical/bio wea',
  'fel crim impersonation',
  'fel criminal impersonat',
  'fel/',
  'fel/ crim imperson of po',
  'fel/ misd',
  'fel/mis',
  'fel/misc',
  'fel/misd',
  'fel/misd)',
  'fel/terrorism',
  'fel;',
  'fel;ony',
  'fel0ny',
  'felc',
  'feld',
  'fele',
  'feleony',
  'feliny',
  'feliony',
  'felk',
  'fell',
  'fellny',
  'fellony',
  'fellury',
  'felm',
  'felnoy',
  'felny',
  'felo',
  'felo ny',
  'felo9ny',
  'felodny',
  'feloiny',
  'felolny',
  'feloly',
  'felomny',
  'felomy',
  'felon',
  'felon y',
  'felonay',
  'felone',
  'feloney',
  'felong',
  'felonhy',
  'felonly',
  'felonny',
  'felonp',
  'felont',
  'felonty',
  'felonu',
  'felonuy',
  'felony   psa #155',
  'felony   psa #156',
  'felony   psa #157',
  'felony - (dwi / lsa)',
  'felony - (rims)',
  'felony - gang',
  'felony  psa #0094',
  'felony  psa #0095',
  'felony -(gang)',
  'felony (impersonation o',
  'felony 49010',
  'felony dwi',
  'felony escape from pris',
  'felony stop',
  'felony suspect',
  'felony tampering with witne',
  'felony(32)',
  'felony-(contempt of court)',
  'felony-(criminal sex act)',
  'felony/crim contempt',
  'felony/dwi',
  'felony/fla',
  'felony/misd',
  'felony`',
  'felony1',
  'felony6',
  'felonyh',
  'felonyq',
  'felonyr',
  'felonyu',
  'felonyy',
  'feloony',
  'felopny',
  'feloy',
  'feloyn',
  'felpny',
  'felq',
  'felrobb',
  'fem',
  'fenoly',
  'feol',
  'feolny',
  'feolony',
  'feonly',
  'feony',
  'fep',
  'fewl',
  'ffel',
  'ffelony',
  'fflony',
  'fgelony',
  'fke',
  'fl',
  'fl;ony',
  'fl=el',
  'fla',
  'fld',
  'fle',
  'fle/glfa',
  'fled',
  'fleeing',
  'fleony',
  'flony',
  'flw',
  'for touch',
  'forc',
  'forc touch',
  'forcible touching',
  'forcible touching (mi',
  'forcible touching/sex a',
  'forcible touhing',
  'forcibly touching',
  'forcibvle touching',
  'foricble touching',
  'frel',
  'g;a',
  'g=fel',
  'ga',
  'gb089-g01a no sec lic (mi',
  'gel',
  'gelony',
  'hindering prostitution',
  'impersonating a po',
  'impersonating a police officer',
  'impersonating police of',
  'impersonation',
  'impersonation of officer',
  'impersonation of police',
  'impersonation ofan offi',
  'intimidating c/v',
  'investigating on a warrant',
  'isd',
  'jumping out of a window to',
  'leaving scene of accide',
  'leaving the scene of accident',
  'lewd conduct',
  'luring a child',
  'luring of a child',
  'm',
  'm/v',
  'matched wanted poster',
  'med',
  'mezz',
  'mfelony',
  'mi',
  'mi8sd',
  'miad',
  'mias',
  'mic',
  'mid',
  'midd',
  'midemeanor',
  'midemeaonr',
  'midf',
  'mids',
  'midsemeanor',
  'mied',
  'miid',
  'miisd',
  'mind',
  'mis',
  'mis sexual mis',
  'mis/animal cruelty',
  'mis/crim contempt',
  'mis/fel',
  'mis/felony',
  'mis/forcible touchin',
  'mis/forcible touching',
  'mis/official miscondu',
  'mis/public lewdness',
  'mis/pw',
  'mis/uuv',
  'misb',
  'misc',
  'misd   psa #0099',
  'misd   psa #158',
  'misd   psa #159',
  'misd - (animal cruel',
  'misd - (dwi)',
  'misd - dwi',
  'misd - leaving the s',
  'misd  psa #0096',
  'misd  psa #100',
  'misd  psa #101',
  'misd  psa 0097',
  'misd  vop criminal contempt',
  'misd ( unlawful evict',
  'misd -(animal cruelt',
  'misd -(violation order of p',
  'misd / vop',
  'misd /bail jumping',
  'misd `',
  'misd 3',
  'misd animal cruelty',
  'misd criminalties',
  'misd force touch',
  'misd- leaving the sc',
  'misd p',
  'misd-(unauthorized u',
  'misd/',
  'misd/ fel',
  'misd/com',
  'misd/crim cont',
  'misd/crim contempt',
  'misd/crim impersonation',
  'misd/fel',
  'misd/felony',
  'misd/forcible touchi',
  'misd/forcible touchin',
  'misd/forcible touching',
  'misd/foricble touchin',
  'misd/other',
  'misd/public lewdness',
  'misd/sexaul abuse',
  'misd/sexual abuse',
  'misd/vtl 511',
  'misd`',
  'misd1',
  'misdc',
  'misdd',
  'misde',
  'misde3meanor',
  'misdeameanor',
  'misdeamenaor',
  'misdeamenor',
  'misdeamer',
  'misdeamnor',
  'misdeamonor',
  'misdeamor',
  'misdeanor',
  'misdemaeanor',
  'misdemaenor',
  'misdemanor',
  'misdemeador',
  'misdemeamor',
  'misdemeandor',
  'misdemeaner',
  'misdemeano',
  'misdemeanoe',
  'misdemeanor- mta impersonation',
  'misdemeanorm',
  'misdemeanr',
  'misdemeaor',
  'misdememanor',
  'misdemenanor',
  'misdemenaor',
  'misdemenor',
  'misdeminor',
  'misdemneaor',
  'misdermeanor',
  'misdf',
  'misdh',
  'misdmeanor',
  'misdp',
  'misdq',
  'mise',
  'misedeamor',
  'misedemanor',
  'misedemeanor',
  'misemeanor',
  'misf',
  'misid',
  'mism',
  'misn',
  'miss',
  'missd',
  'missing',
  'mist',
  'misterminor',
  'mmisd',
  'molestation',
  'mos',
  'msd',
  'msd  psa #0098',
  'msdemeanor',
  'msi',
  'msid',
  'mvm fraud',
  'n/a',
  'NA',
  'nis',
  'nisd',
  'nurg',
  'oga',
  'old post',
  'oop violation',
  'open arest warrant',
  'open warrant',
  'order of protection',
  'osd',
  'othe felony',
  'other (identity theft)',
  'other /identity theft',
  'other felony',
  'other/criminal impersonatio',
  'other/identity theft',
  'parking lot',
  'pat prostitute',
  'patronize prostitution',
  'patronizing a prostit',
  'patronizing a prostitut',
  'patronizing a prostitute',
  'patronizing pros',
  'patronizing prostitu',
  'patronizing prostitut',
  'patronizing prostitute',
  'patronizing prostitution',
  'pcw',
  'penal law felony',
  'pl 21515 felony criminal con',
  'pl 245 endangering welfare',
  'pl 25517',
  'pl 49010',
  'pl 49037',
  'pl fel',
  'pl mis',
  'pl misd',
  'pl15525',
  'pl49010 soliciting',
  'po impersonation',
  'police imperson',
  'police impersonation',
  'possible warrant',
  'prd',
  'prd counter terroris',
  'promoting prostitutio',
  'pros',
  'prostition',
  'prostituion',
  'prostituting',
  'prostitution',
  'prostitution misd',
  'prostitutuion',
  'prostitutution',
  'pub lewd',
  'pubilc lewdness',
  'public lewd',
  'public lewd/sexual misconduct',
  'public lewdenss',
  'public lewdness',
  'public lewdness misd',
  'public lewdnwss',
  'public loudness',
  'publiclewdness',
  'queens transit pattern',
  'radiation detection',
  'raised rap level on prd',
  'reckless',
  'reckless driving',
  'rel',
  'residential',
  'rfelony',
  'row',
  'ses abuse',
  'sex abuse',
  'sex abuse/forcible t',
  'sex abuse/forcible touching',
  'sex/forcible touching',
  'sexual abuse',
  'sexual misconduct',
  'sexualt abuse',
  'solicitating pros',
  'soliciting a prostitute',
  'soliciting prostitution',
  'street',
  'suspected oga',
  'suspected terrorism',
  'suspended license',
  'tampering with evidence',
  'tampering with mvm',
  'tampering with nypd bar',
  'terroism',
  'terrorisim',
  'terrorism',
  'terrorism 49020',
  'terrorism fel',
  'terrorism/casing',
  'terrorism/cpcs',
  'terrorist activity',
  'terrorist threats',
  'terrrorism',
  'tmc',
  'ugv',
  'unat use',
  'unattended suitcases',
  'unauthorized use',
  'unauthorized use of',
  'unauthorized use of a',
  'unauthorized use of a v',
  'unauthorized use of a vehic',
  'unauthorized use of veh',
  'unk',
  'unk/10-85',
  'unlawful eviction',
  'unlawful fleeing pol',
  'unlawful wear bulletproof vest',
  'upm',
  'use of a child in sex perfor',
  'uumv',
  'uuv',
  'v',
  'vel',
  'viol',
  'viol order of protection',
  'violation',
  'violation of order of protect',
  'violation of order pf prot',
  'violation order of protecti',
  'violation order of protection',
  'violaton',
  'void dup',
  'voop',
  'voop-felony (',
  'vop',
  'vtl',
  'vtl 511',
  'vtl violation',
  'wanted on arrest warrant',
  'wanted suspect',
  'warrant',
  'white',
  'witness',
  'crim res',
  'frl',
  'frlony',
  'fwelony',
  'fwl',
  'fwlony'
)


```

```{r}

full_sqf <- full_sqf %>% 
  mutate(crimsusp = str_to_lower(crimsusp)) %>% 
  mutate(crimsusp = str_remove_all(crimsusp, "[.]|[,]|[']")) %>% 
  mutate(charge_cat = case_when(
    str_detect(crimsusp, "homicide") ~ "Violent",
    str_detect(crimsusp, "homocide") ~ "Violent",
    str_detect(crimsusp, "murder") ~ "Violent",
    str_detect(crimsusp, "rape") ~ "Violent",
    str_detect(crimsusp, "robbery") ~ "Violent",
    str_detect(crimsusp, "assault") ~ "Violent",
    crimsusp %in% violent ~ "Violent",
    str_detect(crimsusp, "cpw") ~ "Weapon",
    str_detect(crimsusp, "firearm") ~ "Weapon",
    str_detect(crimsusp, "265") ~ "Weapon",
    str_detect(crimsusp, "weapon") ~ "Weapon",
    crimsusp %in% weapon ~ "Weapon",
    str_detect(crimsusp, "burg") ~ "Property",
    str_detect(crimsusp, "larc") ~ "Property",
    str_detect(crimsusp, "gla") ~ "Property",
    str_detect(crimsusp, "auto") ~ "Property",
    str_detect(crimsusp, "car") ~ "Property",
    str_detect(crimsusp, "vehicle") ~ "Property",
    crimsusp %in% property ~ "Property",
    str_detect(crimsusp, "drug") ~ "Drug",
    str_detect(crimsusp, "marij") ~ "Drug",
    str_detect(crimsusp, "marih") ~ "Drug",
    str_detect(crimsusp, "narco") ~ "Drug",
    str_detect(crimsusp, "substance") ~ "Drug",
    crimsusp %in% drug ~ "Drug",
    str_detect(crimsusp, "trespass") ~ "Trespass/Public Order",
    str_detect(crimsusp, "crim tres") ~ "Trespass/Public Order",
    str_detect(crimsusp, "tresp") ~ "Trespass/Public Order",
    crimsusp %in% trespass ~ "Trespass/Public Order",
    crimsusp %in% qol ~ "Trespass/Public Order",
    crimsusp %in% c("misd", "fel", "felony", "misdemeanor", "other") ~ "Other",
    crimsusp %in% other ~ "Other",
    crimsusp %in% c("10-31", "31-oct", NA) ~ "Other"
  )) 

```


### Suspected crime breakdown
 
**Total pedestrian stops**    
*By suspected crime type*

```{r}

full_sqf %>% 
  mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  filter(charge_cat != "Other") %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma, breaks = seq(0,30000, 10000)) +
  expand_limits(y = 30000) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 2) 


```

**Total pedestrian stops, %**   
*By suspected crime type*

```{r}

full_sqf %>% 
     mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  filter(charge_cat != "Other") %>% 
    mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
         axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 2) 


```
**Pedestrian stops resulting in arrest/summons, %**    
*By suspected crime type*

```{r}

full_sqf %>% 
  filter(!race == "Other") %>% 
  mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%
  filter(charge_cat != "Other") %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  group_by(year, charge_cat, race, hit) %>% 
  summarise(n = n()) %>% 
  mutate(hit_percent = n/sum(n)) %>% 
  filter(hit == "Y") %>% 
  mutate(hit_percent = as.numeric(hit_percent)) %>% 
  ggplot(aes(year, hit_percent, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_y_continuous(labels = percent) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 

```

```{r}

sqf_yearly_charge_race <- full_sqf %>% 
  filter(race != "Other",
         age > 9) %>% 
  count(year, charge_cat, race)

```

**Pedestrian stop rate per 100,000 people**    
*By suspected crime type*

```{r}

left_join(sqf_yearly_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  filter(charge_cat != "Other") %>%
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma, breaks = seq(0,1000, 250))+
  expand_limits(y = 1000) +
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                      labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))



```


```{r}

# heatmap

stop_rate_charge <- left_join(sqf_yearly_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
  mutate(enforcement = "stop", .before = charge_cat) %>% 
  rename(variable = charge_cat)




```


**Pedestrian stop rate per 100,000 people**  
Compared to historic (2013) and recent baseline (2019), % change  
*By suspected crime type*

```{r}

left_join(sqf_yearly_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  filter(charge_cat != "Other") %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1.25, 1))+
  facet_wrap2(vars(charge_cat), axes = "x") +
  geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.5) 

```

**Pedestrian stop racial disparity rate ratio**  
*By suspected crime type*

```{r}

left_join(sqf_yearly_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  filter(charge_cat != "Other") %>% 
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 40) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0, 40, 10)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 2) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))




```


```{r}

# heatmap

stop_ratio_charge <- left_join(sqf_yearly_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  pivot_wider(names_from = race, values_from = value)  %>% 
  mutate(enforcement = "stop", .before = charge_cat) %>% 
  rename(variable = charge_cat)

```


**Pedestrian stop racial disparity rate ratio**    
Compared to historic (2013) and recent (2019) baseline, absolute change    
*By suspected crime type*

```{r}

left_join(sqf_yearly_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%
  filter(charge_cat != "Other") %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(Black/White,1),
         `Hispanic/White` = round(Hispanic/White,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, accuracy = .1, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  facet_wrap2(vars(charge_cat), axes = "all", 
              nrow = 2, 
              scales = "free")+
  expand_limits(x = c(-8,20))+
  scale_x_continuous(labels = NULL)


```



```{r}

stop_rates <- rbind(stop_rate_boro, 
                    stop_rate_age,
                    stop_rate_charge)


```


```{r}

stop_ratios <- rbind(stop_ratio_boro, 
                     stop_ratio_age,
                     stop_ratio_charge)


```



**Change in stop rate across subgroups, 2022 vs. 2013**

```{r}

stop_rates %>% 
  filter(period == "'22 vs '13",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black", "Hispanic", "White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free_y")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  scale_y_continuous(labels = percent_format(), breaks = c( -1, -.5,0)) +
  theme(axis.text.x = element_text(size = 6)) +
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) 


```


**Change in stop rate across subgroups, 2022 vs. 2019**

```{r}

stop_rates %>% 
  filter(period == "'22 vs '19",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black", "Hispanic", "White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free_y")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  scale_y_continuous(labels = percent_format(), breaks = c(-1,1)) +
  theme(axis.text.x = element_text(size = 6))+
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y = c(-1,1.2))


```


**Change in stop racial disparity rate ratio across subgroups, 2022 vs 2013**

```{r}

stop_ratios %>% 
  filter(period == "'22 vs '13",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         value = as.numeric(value),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  theme(axis.text.x = element_text(size = 6))+
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(breaks = seq(-6,12,3)) +
  expand_limits(y = c(-6,12))



```


**Change in stop racial disparity rate ratio across subgroups, 2022 vs 2019**

```{r}

stop_ratios %>% 
  filter(period == "'22 vs '19",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         value = as.numeric(value),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  theme(axis.text.x = element_text(size = 6)) +
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
    scale_y_continuous(breaks = seq(-3,18,3)) +
  expand_limits(y = c(-3,18))


```


```{r}

pd <- read_csv("historic_arrest.csv")

pd_2022 <- read_csv("arrest_2022.csv")


```


```{r}

pd <- pd %>% 
  clean_names %>% 
  select(arrest_date:perp_race)

pd_2022 <- pd_2022 %>% 
  clean_names %>% 
  select(arrest_date: perp_race)

full_pd <- bind_rows(pd, pd_2022)

rm(pd, pd_2022)

full_pd <- full_pd %>% 
  mutate(race = case_when(perp_race == "WHITE" ~ "nhwhite",
                          perp_race == "BLACK" ~ "nhblack",
                          perp_race %in% c("BLACK HISPANIC", "WHITE HISPANIC") ~ "hispanic")) %>% 
  mutate(arrest_date = mdy(arrest_date)) %>%
  mutate(year = year(arrest_date)) %>% 
  filter(year >= 2013)


```



### Arrests by Race, 2013-2022

**Total arrests**

```{r}

full_pd %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
 group_by(year, race) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n)) %>% 
  mutate(race = fct_reorder(race, n)) %>%
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic()+
  theme(legend.background = element_rect(fill = "white"),
        legend.position = "top",
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        legend.key=element_blank())+
  scale_y_continuous(labels = comma)+
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = 2013: 2022) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  geom_text(aes(y = sum, label = comma(sum)), vjust = -.85, size = 2.8,  format = comma, check_overlap = TRUE) +
  expand_limits(y = 400000)

```


**Total arrests, %**

```{r}


full_pd %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(year, percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  geom_text(aes(label = ifelse(percent > 3, paste0(percent, "%"), "")), size = 3.5, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  geom_text(aes(label = ifelse(percent < 3, paste0(percent, "%"), "")), size = 2.6, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  theme_classic() +
  theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_x_continuous(breaks = 2013: 2022)  +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks"))

```

```{r}

full_pros <- read_csv("prosecutions_decade.csv")


```


```{r}

full_pros <- full_pros %>% 
  mutate(year = year(date)) %>% 
  mutate(race = case_when((race == "Black" & hispanic == "FALSE") ~ "nhblack",
                          (race == "White" & hispanic == "FALSE") ~ "nhwhite",
                          hispanic == "TRUE" ~ "hispanic",
                          TRUE ~ "Other")) 

```



**Desk appearance tickets, as % of total arrests**

```{r}


full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!race == "Other") %>% 
  group_by(year, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat, color = race)) +
  geom_point(size = 3) +
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent) +
  scale_x_continuous(breaks = 2013: 2022) +
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  xlab("") +
  expand_limits(y = c(0,.35)) +
  labs(y = '', x = '', color = '') +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_y_continuous(breaks = seq(0,.35, .05), labels = percent)

```

```{r}

arrest_yearly_race <- full_pd  %>% 
  filter(!is.na(race), 
         year>=2013) %>% 
  count(year, race)


```


**Arrest rate per 100,000 people**

```{r}

left_join(arrest_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  select(year, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3)+
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  expand_limits(y = c(0,12000)) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,12000,3000)) +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))
  
   
```


```{r}

# heatmap

arrest_rate_all <- left_join(arrest_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1, 6:9) %>% 
  pivot_longer(!race, names_to = "period", values_to = "percent") %>% 
  mutate(percent = as.numeric(percent),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = percent) %>% 
  relocate(Black, .before = Hispanic) %>% 
  mutate(enforcement = "arrest", .before = period) %>% 
  mutate(variable = "all", .after = enforcement)



```


**Arrest rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change

```{r}


left_join(arrest_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1, 5:6) %>% 
  pivot_longer(!race, names_to = "period", values_to = "percent") %>% 
  mutate(percent = as.numeric(percent),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  mutate(vert_just = ifelse(percent > 0, -1, 1.7)) %>% 
  ggplot(aes(percent, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = percent, color = race),
                 height = 0,
                 position = position_dodge(width = .7),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .7), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  scale_x_continuous(labels = percent, breaks = c(-1,-.8,-.6,-.4,-.2,0,.2))  +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(x = c(-1,1)) +
  scale_x_continuous(labels = NULL) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = percent(percent, accuracy =1), vjust = vert_just, group = race), 
            position = position_dodge(width = .7),
            size = 3)


```


**Arrest racial disparity rate ratio**

```{r}

left_join(arrest_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(nhblack/nhwhite,1),
         `Hispanic/White` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  ggplot(aes(year, value, color = race)) +
  geom_line(size = 1, key_glyph = draw_key_point) +
  geom_point(size = 2.5)+
  # geom_text(aes(label = value), position = position_nudge(y = .6), size = 3, color = "black")+
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  scale_y_continuous(breaks = seq(0,8,2))+
  xlab("") +
  expand_limits(y = c(0,8)) +
  labs(y = '', x = '', color = '') +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) 



```

```{r}

# heatmap

arrest_ratio_all <- left_join(arrest_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = nhblack/nhwhite,
         `Hispanic/White` = hispanic/nhwhite) %>% 
  filter(year %in% c(2013,2019,2021,2022)) %>% 
  select(1,5:6) %>% 
  rotate_df() %>% 
  rownames_to_column(var = "race") %>% 
  mutate_at(c('V1', 'V2', 'V3', 'V4'), as.numeric) %>% 
  filter(!row_number() %in% c(1)) %>% 
  mutate(`'21 vs '13`=  V3-V1,
         `'21 vs '19` = V3-V2,
         `'22 vs '13` = V4-V1,
         `'22 vs '19` = V4-V2) %>% 
  select(1, 6:9) %>% 
  pivot_longer(!race, names_to = "period", values_to = "change") %>% 
  pivot_wider(names_from = race, values_from = change) %>% 
  mutate(enforcement = "arrest", .before = period) %>% 
  mutate(variable = "all", .after = enforcement)

```


**Arrest racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change

```{r}


left_join(arrest_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(nhblack/nhwhite,1),
         `Hispanic/White` = round(hispanic/nhwhite,1)) %>% 
  filter(year %in% c(2013,2019,2022)) %>% 
  select(1,5:6) %>% 
  rotate_df() %>% 
  rownames_to_column(var = "race") %>% 
  mutate_at(c('V1', 'V2', 'V3'), as.numeric) %>% 
  filter(!row_number() %in% c(1)) %>% 
  mutate(`'22 vs '13` = round(V3-V1,1),
         `'22 vs '19` = round(V3-V2,1)) %>% 
  select(1, 5:6) %>% 
  pivot_longer(!race, names_to = "period", values_to = "change") %>% 
  mutate(period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(change, period)) +
  coord_flip() +
  geom_errorbarh(aes(xmin = 0, xmax = change, color = race),
                 height = 0,
                 position = position_dodge(width = .7),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .7), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-0.25, 1.5)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_x_continuous(labels = NULL) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(change, accuracy = .1, add_plusses = TRUE), group = race), 
            position = position_dodge(width = .7),
            size = 3,
            vjust = -1)

```

### Borough breakdown

**Total arrests**  
*By borough*

```{r}
full_pd %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White",
                          TRUE ~ "Other")) %>% 
  rename(boro = arrest_boro) %>% 
  mutate(boro = case_when(boro == "K" ~ "Brooklyn",
                          boro == "B" ~ "Bronx",
                          boro == "M" ~ "Manhattan",
                          boro == "Q" ~ "Queens",
                          boro == "S" ~ "Staten Island")) %>% 
  group_by(year, boro, race) %>% 
  summarise(n = n()) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .95, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma, breaks = seq(0,120000, 20000)) +
  expand_limits(y = 120000)+
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(boro), axes = "x", nrow = 2)


```


**Total arrests, %**
*By borough*

```{r}

full_pd %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  rename(boro = arrest_boro) %>% 
  mutate(boro = case_when(boro == "K" ~ "Brooklyn",
                          boro == "B" ~ "Bronx",
                          boro == "M" ~ "Manhattan",
                          boro == "Q" ~ "Queens",
                          boro == "S" ~ "Staten Island")) %>% 
  group_by(year, boro, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(boro), axes = "x", nrow = 2) 


```

**Desk appearance tickets, as % of total arrests**  
*By borough*

```{r}


full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!race == "Other") %>% 
  mutate(county = case_when(county == "BRONX" ~ "Bronx",
                            county == "KINGS" ~ "Brooklyn",
                            county == "NEW YORK" ~ "Manhattan",
                            county == "QUEENS" ~ "Queens",
                            county == "RICHMOND" ~ "Staten Island")) %>% 
  group_by(year, county, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat, color = race)) +
  geom_point(size = 3) +
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent) +
  scale_x_continuous(breaks = 2013: 2022) +
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(county), axes = "x", nrow = 2) 


```


```{r}

arrest_yearly_boro_race <-
  full_pd %>% 
  rename(boro = arrest_boro) %>% 
    mutate(boro = case_when(boro == "K" ~ "Brooklyn",
                          boro == "B" ~ "Bronx",
                          boro == "M" ~ "Manhattan",
                          boro == "Q" ~ "Queens",
                          boro == "S" ~ "Staten Island")) %>% 
  filter(!is.na(race),
         !is.na(boro)) %>% 
  count(year, boro, race)

```

**Arrest rate per 100,000 people**  
*By borough*

```{r}

left_join(arrest_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, boro, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(boro), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  scale_y_continuous(breaks = seq(10000,30000,10000), labels = comma_format()) +
  expand_limits(y= 30000)

```



```{r}

# heatmap

arrest_rate_boro <- left_join(arrest_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
  mutate(enforcement = "arrest", .before = boro) %>% 
  rename(variable = boro)


```


**Arrests per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change  
*By borough*

```{r}

left_join(arrest_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  expand_limits(x = c(-1,1)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(boro), axes = "x") +
  geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.5) 

```

**Arrest racial disparity rate ratio**  
*By borough*

```{r}

left_join(arrest_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, boro, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = nhblack/nhwhite,
         `Hispanic/White` = hispanic/nhwhite) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, boro, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3)+
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 20) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,20,5)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(boro), axes = "x") +
   guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 



```



```{r}

# heatmap

arrest_ratio_boro <- left_join(arrest_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = nhblack/nhwhite,
         `Hispanic/White` = hispanic/nhwhite) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  mutate(enforcement = "arrest", .before = boro) %>% 
  rename(variable = boro)


```

**Arrest racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change  
*By borough*

```{r}

left_join(arrest_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(nhblack/nhwhite,1),
         `Hispanic/White` = round(hispanic/nhwhite,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, add_plusses = TRUE, accuracy = .1), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  expand_limits(x = c(-3,7))+
  scale_x_continuous(labels = NULL)+
  facet_wrap2(vars(boro), axes = "all")


```

### Age breakdown

**Total arrests**  
*By age*

```{r}

full_pd %>% 
  mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!is.na(age_cat)) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  scale_y_continuous(breaks = seq(50000,200000,50000), labels = comma_format()) +
  expand_limits(y = 200000)


```

**Total arrests, %**  
*By age*

```{r}

full_pd %>% 
  mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!is.na(age_cat)) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))  +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) 

```

**Desk appearance tickets, as % of total arrests**  
*By age*

```{r}


full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >= 25 & age <= 44 ~ "25-44",
                             age > 44 ~ "45+")) %>% 
  filter(!is.na(age_cat)) %>%
  filter(!race == "Other") %>% 
  group_by(year, age_cat, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat, color = race)) +
  geom_point(size = 3) +
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent) +
  scale_x_continuous(breaks = 2013: 2022) +
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) 


```

```{r}

arrest_yearly_age_race <- full_pd %>% 
  mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
  filter(race != "Other",
         !is.na(age_cat)) %>% 
  count(year, age_cat, race)


```


**Arrest rate per 100,000 people**  
*By age*

```{r}

left_join(arrest_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, age_cat, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma) + 
  xlab("") +
  expand_limits(y = 20000) +
  scale_y_continuous(breaks = seq(5000,20000,5000), labels = comma_format()) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 

```

```{r}

# heatmap

arrest_rate_age <- left_join(arrest_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black,.before = Hispanic) %>% 
  mutate(enforcement = "arrest", .before = age_cat) %>% 
  rename(variable = age_cat)

```


**Arrest rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change    
*By age*

```{r}

left_join(arrest_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  expand_limits(x = c(-1.2, 1)) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.5) 

```


**Arrest racial disparity rate ratio**  
*By age*

```{r}

left_join(arrest_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, age_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, age_cat, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma, breaks = seq(0, 12, 3)) +
  xlab("") +
  expand_limits(y = c(0,12.5)) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 



```


```{r}

# heatmap

arrest_ratio_age <- left_join(arrest_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  mutate(enforcement = "arrest", .before = age_cat) %>% 
  rename(variable = age_cat)


```


**Arrest racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change     
*By age*

```{r}

left_join(arrest_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(Black/White,1),
         `Hispanic/White` = round(Hispanic/White,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, accuracy = .1, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  expand_limits(x = c(-3, 9))+
  scale_x_continuous(labels = NULL)+
  facet_wrap2(vars(age_cat), axes = "all", nrow = 2)


```


### Charge severity breakdown

**Total arrests**  
*By charge severity*

```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, severity, race) %>% 
  summarise(n = n()) %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic()+
  theme(legend.background = element_rect(fill = "white"), 
        legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5), 
        legend.key=element_blank())+
  scale_y_continuous(labels = comma)+
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = 2013: 2022) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(severity), axes = "x")


```

**Total arrests, %**  
*By charge severity*

```{r}


full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, severity, race) %>%  
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(year, percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_y_continuous(labels = percent)  +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = percent_format()) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(severity), axes = "x")

```

**Desk appearance tickets, as % of total arrests**  
*By charge severity*

```{r}


full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(!is.na(severity)) %>% 
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!race == "Other") %>% 
  group_by(year, severity, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat, color = race)) +
  geom_point(size = 3) +
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent) +
  scale_x_continuous(breaks = 2013: 2022) +
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(severity), axes = "x") 


```


```{r}

arrest_yearly_severity_race <- full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(race != "Other",
         !is.na(severity)) %>% 
  count(year, severity, race)

```


**Arrest rate per 100,000 people**  
*By charge severity*

```{r}

left_join(arrest_yearly_severity_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, severity, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma, breaks = seq(0,9000,1000))+
  expand_limits(y=9000) +
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(severity), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                      labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))



```

```{r}

# heatmap

arrest_rate_severity <- left_join(arrest_yearly_severity_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, severity, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black,.before = Hispanic) %>% 
  mutate(enforcement = "arrest", .before = severity) %>% 
  rename(variable = severity)


```



**Arrest rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change  
*By age*


```{r}

left_join(arrest_yearly_severity_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, severity, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.75)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = 1)+
  facet_wrap2(vars(severity), axes = "x") +
    geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) 

```


**Arrest racial disparity rate ratio**  
*By charge severity*

```{r}

left_join(arrest_yearly_severity_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, severity, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, severity, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
    guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(severity), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 



```

```{r}

# heatmap

arrest_ratio_severity <- left_join(arrest_yearly_severity_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, severity, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  mutate(enforcement = "arrest", .before = severity) %>% 
  rename(variable = severity)

```


**Arrest racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change   
*By age*

```{r}

left_join(arrest_yearly_severity_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, severity, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(Black/White,1),
         `Hispanic/White` = round(Hispanic/White,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-.4, 2.3)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 6)) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  facet_wrap2(vars(severity), axes = "all") +
  scale_x_continuous(labels = NULL)


```




```{r}


# arrest_bribery <- c("BRIBERY,PUBLICADMINISTRATION")
# 
# arrest_controlled_substance <- c(
#   "CONTROLLEDSUBSTANCE,POSSESSION7",
#   "CONTROLLEDSUBSTANCE,INTENTTOSELL3",
#   "CONTROLLEDSUBSTANCE,SALE3",
#   "CONTROLLEDSUBSTANCE,POSSESSI",
#   "CONTROLLEDSUBSTANCE,INTENTTO",
#   "DRUGPARAPHERNALIA,POSSESSESORSELLS2",
#   "CONTROLLEDSUBSTANCE,INTENTTOSELL5",
#   "CONTROLLEDSUBSTANCE,POSSESSION5",
#   "CONTROLLEDSUBSTANCE,POSSESS.1",
#   "CONTROLLEDSUBSTANCE,POSSESS.",
#   "SALESCHOOLGROUNDS",
#   "CONTROLLEDSUBSTANCE,POSSESSION4",
#   "CONTROLLEDSUBSTANCE,POSSESS.2",
#   "CONTROLLEDSUBSTANCE,INTENTT",
#   "DRUGPARAPHERNALIA,POSSESSE",
#   "CONTROLLEDSUBSTANCE,SALE5",
#   "CONTROLLEDSUBSTANCE,SALE1",
#   "CONTROLLEDSUBSTANCE,SALE2",
#   "POSSESSIONHYPODERMICINSTRUMENT",
#   "CONTROLLEDSUBSTANCE,POSSESS.3",
#   "CONTROLLEDSUBSTANCE,SALE4",
#   "DRUGPARAPHERNALIA,POSSESSESORSELLS1",
#   "POSSESSIONHYPODERMICINSTRUME",
#   "SALESCHOOLGROUNDS4",
#   "SALESOFPRESCRIPTION",
#   "POSSMETHMANUFACTMATERIAL",
#   "CONTROLLEDSUBSTANCE,POSSESS.OFPROCURSERS",
#   "FORGERY,PRESCRIPTION",
#   "DRUG,INJECTIONOF")
# 
# 
# arrest_dv_child <- c("CONTEMPT,CRIMINAL",
#     "CHILD,ENDANGERINGWELFARE",
#     "CRIMINALCONTEMPT1",
#     "AGGRAVATEDCRIMINALCONTEMPT",
#     "CHILD,OFFENSESAGAINST,UNCLASSIFIED",
#     "CHILDABANDONMENT",
#     "CHILD,OFFENSESAGAINST,UNCLASS",
#     "CUSTODIALINTERFERENCE2",
#     "CUSTODIALINTERFERENCE1",
#     "CHILD,LICENSEDPREMISES",
#     "LURINGACHILD",
#     "VIOLATIONOFORDEROFPROTECTI",
#     "F.C.A.ORDEROFPROTECTION",
#     "USECHILDTOCOMMITCONTSUBOFF")
# 
# arrest_fraud <- c("FORGERY,ETC.,UNCLASSIFIED-FELONY",
#   "FORGERY,ETC.-MISD.",
#   "FORGERY,ETC.,UNCLASSIFIED-FELO",
#   "FRAUD,UNCLASSIFIED-FELONY",
#   "ACCOSTING,FRAUDULENT",
#   "IDENTITYTHFT-1",
#   "FRAUD,UNCLASSIFIED-MISDEMEANOR,PART1",
#   "FORGERY-ILLEGALPOSSESSION,VEH",
#   "FORGERY,M.V.REGISTRATION",
#   "FORGERY-ILLEGALPOSSESSION,VEHICLEIDENT.NU",
#   "FRAUD,UNCLASSIFIED-MISDEMEANOR",
#   "IDENTITYTHFT-2",
#   "RECORDS,FALSIFY-TAMPER",
#   "CREDITCARD,UNLAWFULUSEOF",
#   "CHECK,BAD",
#   "FRAUD,UNCLASSIFIED-MISDEMEANOR-PART2")
# 
# arrest_marijuana <- c("MARIJUANA,POSSESSION4&5",
#   "MARIJUANA,SALE4&5",
#   "MARIJUANA,POSSESSION",
#   "MARIJUANA,POSSESSION1,2&3",
#   "MARIJUANA,SALE1,2&3",
#   "UNLAWFULSALESYNTHETICMARIJUANA",
#   "CANNABISPOSSESSION,3",
#   "CANNABISPOSSESSION,2&1",
#   "CANNABISSALE,2&1",
#   "CANNABISSALE,3",
#   "CANNABISSALE",
#   "CANNABISPOSSESSION",
#   "CANNABISSALE,AGGRAVATED")
# 
# arrest_minor_property <- c("THEFTOFSERVICES,UNCLASSIFIED",
#   "LARCENY,PETITFROMOPENAREAS,UNCLASSIFIED",
#   "LARCENY,PETITFROMOPENAREAS,",
#   "MISCHIEF,CRIMINALUNCLASSIFIED4THDEG",
#   "STOLENPROPERTY3,POSSESSION",
#   "MISCHIEF,CRIMINAL,UNCL2ND",
#   "CRIMINALMISCHIEF,UNCLASSIFIED4",
#   "CRIMINALMIS2&3",
#   "THEFTOFSERVICES,UNCLASSIFIE",
#   "MISCHIEF,CRIMINAL,UNCL2NDDEG3RDDEG",
#   "UNAUTHORIZEDUSEVEHICLE3",
#   "TAMPERING1,CRIMINAL",
#   "BURGLARSTOOLS,UNCLASSIFIED",
#   "STOLENPROPERTY2,1,POSSESSION,UNCLASSIFIED",
#   "STOLENPROPERTY2,1,POSSESSION",
#   "UNAUTHORIZEDUSEVEHICLE2",
#   "UNAUTH.SALEOFTRANS.SERVICE",
#   "STOLENPROPERTY-MOTORVEH2ND,",
#   "STOLENPROPERTY-MOTORVEH2ND,1STPOSSESS",
#   "TAMPERING3,2,CRIMINAL",
#   "THEFT,RELATEDOFFENSES,UNCLASSIFIED",
#   "MISCHIEF,CRIMINAL3&2,OFMOTORVEHICLE",
#   "THEFT,RELATEDOFFENSES,UNCLASS",
#   "MISCHIEF1,CRIMINAL,EXPLOSIVE",
#   "LARCENY,PETITBYACQUIRINGLOS",
#   "THEFTOFSERVICES-CABLETVSERVICE",
#   "MISCHIEF,CRIMINAL4,BYFIRE",
#   "MISCHIEF,CRIMINAL4,OFMOTORVEHICLE",
#   "RECKLESSENDANGERMENTOFPROPERTY",
#   "COMPUTERTAMPER/TRESSPASS",
#   "MISCHIEF,CRIMINAL3&2,OFM",
#   "STOLENPROPERTY2,POSSESSIONBYLICENSEDDEA",
#   "RECKLESSENDANGERMENTOFPROPE",
#   "MISCHIEF,CRIMINAL4,OFMOTOR",
#   "THEFTOFSERVICES-CABLETVSE",
#   "COMPUTERUNAUTH.USE/TAMPER",
#   "STOLENPROPERTY2,POSSESSIONB",
#   "BRIBERY,COMMERCIAL",
#   "BRIBERY,FRAUD")
# 
# arrest_minor_violent <- c("MENACING,UNCLASSIFIED",
#     "OBSTRBREATH/CIRCUL",
#     "RESISTINGARREST",
#     "STRANGULATION1ST",
#     "RECKLESSENDANGERMENT2",
#     "RECKLESSENDANGERMENT1",
#     "RECKLESSDRIVING",
#     "IMPRISONMENT2,UNLAWFUL",
#     "MENACING1STDEGREE(VICTNOT",
#     "RIOT2/INCITING",
#     "MENACING1STDEGREE(VICTNOTPEACEOFFICER)",
#     "VEHICULARASSAULT(INTOXDRIVE",
#     "IMPRISONMENT1,UNLAWFUL",
#     "HARASSMENT,SUBD3,4,5",
#     "HARASSMENT,SUBD1,CIVILIAN",
#     "INCOMPETENTPERSON,RECKLESSYENDANGERING",
#     "JOSTLING",
#     "RIOT1",
#     "INCOMPETENTPERSON,KNOWINGLYENDANGERING",
#     "ENDANGERINGVULNERABLEELDERLY",
#     "ENDWELFAREVULNERABLEELDERLYPERSON",
#     "INCOMPETENTPERSON,ENDANGERINGWELFARE",
#     "VEHICULARASSAULT(INTOXDRIVER)")
# 
# arrest_murder <- c("HOMICIDE,NEGLIGENT,VEHICLE,",
#     "MURDER,UNCLASSIFIED",
#     "HOMICIDE,NEGLIGENT,UNCLASSIFIED",
#     "HOMICIDE,NEGLIGENT,UNCLASSIFIE",
#     "HOMICIDE,NEGLIGENT,VEHICLE,INTOXDRIVER")
# 
# arrest_nyslaw_admin <- c("ADM.CODE,UNCLASSIFIEDVIOLATION",
#     "ADM.CODE,UNCLASSIFIEDVIOLATIO",
#     "ADM.CODE,UNCLASSIFIEDMISDEMEA",
#     "NYSTATELAWS,UNCLASSIFIEDVIOLATION",
#     "PUBLICADMINISTRATION,UNCLASSIFIEDFELONY",
#     "PUBLICADMINISTRATION,UNCLASSI",
#     "NYSTATELAWS,UNCLASSIFIEDMISDEMEANOR",
#     "PUBLICADMINISTATION,UNCLASSMISDEMEAN4",
#     "NYSTATELAWS,UNCLASSIFIEDFELONY",
#     "PUBLICADMINISTATION,UNCLASSM",
#     "NYSTATELAWS,UNCLASSIFIEDFEL",
#     "NYSTATELAWS,UNCLASSIFIEDMIS",
#     "NYSTATELAWS,UNCLASSIFIEDVIO",
#     "NYSTATE,UNCLASSIFIED",
#     "NYSUNCLASSIFIED")
# 
# arrest_other <- c("USURY,CRIMINAL",
#     "IMPERSONATION2,PUBLICSERVANT",
#     "IMPERSONATION2,PUBLICSERVAN",
#     "IMPERSONATION1,POLICEOFFICER",
#     "USCODE,UNCLASSIFIED",
#     "U.S.CODEUNCLASSIFIED",
#     "TAXLAW",
#     "BAILJUMPING3",
#     "BAILJUMPING1&2",
#     "FUGITIVE,FROMOTHERSTATES",
#     "CONSPIRACY2,1",
#     "PARKR&R,UNCLASSIFIEDVIOLATION",
#     "IMPERSONATION1,POLICEOFFICE",
#     "PERJURY3,ETC.",
#     "FUGITIVE/OTHERSTATES",
#     "CONSPIRACY4,3",
#     "HEALTHCODE,VIOLATION",
#     "AGRICULTURE&MARKETSLAW,UNCLASSIFIED",
#     "TERRORISTTHREAT",
#     "MAKINGTERRORISTICTHREAT",
#     "PUBLICSAFETY,UNCLASSIFIEDMIS",
#     "ENTERPRISECORRUPTION",
#     "MATERIALOFFENSIV",
#     "PUBLICHEALTHLAW,UNCLASSIFIEDMISDEMEANOR",
#     "FACILITATION4,CRIMINAL",
#     "APPEARANCETICKETFAILTORESPOND",
#     "TORTURE/INJUREANIMALCRUELTY",
#     "FUGITIVE/OTHERJURISDICTIONNYS",
#     "POSSESSIONANTI-SECURITYITEM",
#     "FUGITIVE,FROMOTHERJURISDICTIONINNYSTATE",
#     "GENERALBUSINESSLAW/UNCLASSIFIED",
#     "PERJURY2,1,ETC",
#     "UNLAWFULDISCLOSUREOFANINTIMATEIMAGE",
#     "GENERALBUSINESSLAW,UNCLASSIFIED",
#     "PUBLICSAFETY,UNCLASSIFIEDMISDEMEANOR",
#     "PUBLICHEALTHLAW,UNCLASSIFIED",
#     "TAMPERINGWITHAWITNESS",
#     "CAUSESPI/KILLANIMAL",
#     "CONSPIRACY6,5",
#     "NYSTATE,PAROLE",
#     "HEALTHCARE/RENT.REG.",
#     "FACILITATION3,2,1,CRIMINAL",
#     "NYCITY,UNCLASSIFIEDWARRANT",
#     "MONEYLAUNDERING3",
#     "NYSPAROLEVIOLATION",
#     "SOLICITATION4,CRIMINAL",
#     "UNCLASSIFIED",
#     "AGRICULTURE&MARKETSLAW,UNCL",
#     "SPILLBACK",
#     "SOLICITATION5,CRIMINAL",
#     "SOLICITATION3,2,1,CRIMINAL",
#     "SUPP.ACTTERRORISM2ND",
#     "NEGLECT/POISONANIMAL",
#     "NYSTATE,PROBATION",
#     "PRIVACY,OFFENSESAGAINST,UNCLASSIFIED",
#     "ABANDONANIMAL",
#     "F.O.A.NON-SUPPORT",
#     "NAVIGATIONLAW",
#     "TERRORISMPROVIDESUPPORT",
#     "CONFININGANIMALINVEHICLE/SHELTER",
#     "F.C.A.NONSUPPORT",
#     "LABORTRAFFICKING",
#     "PROMOTINGSUICIDEATTEMPT",
#     "SUPP.ACTTERR2ND",
#     "F.C.A.P.I.N.O.S.",
#     "F.C.A.UNCLASSIFIED",
#     "FAC.SEXUALOFFENSEW/CONTROLL",
#     "FAC.SEXUALOFFENSEW/CONTROLLEDSUBSTANCE",
#     "HINDPROSEC.TERR2",
#     "INAPPROPIATESHELTERDOGLEFT",
#     "NYCUNCLASSIFIEDWARRANT",
#     "NYSPROBATION",
#     "SUPPACTTERRORISM1",
#     "WOUNDS,REPORTINGOF",
#     "ESCAPE2,1",
#     "ESCAPE3",
#     "COERCION1",
#     "COERCION2",
#     "RADIODEVICES,UNLAWFULPOSSESSION",
#     "RADIODEVICES,UNLAWFULPOSSESS",
#     "ABSCONDINGFROMWORKRELEASE2",
#     "MONEYLAUNDERING1&2")
# 
# arrest_part1_prop <- c("LARCENY,GRANDFROMOPENAREAS,UNCLASSIFIED",
#     "LARCENY,GRANDFROMOPENAREAS,UNATTENDED",
#     "BURGLARY,UNCLASSIFIED,UNKNOWNTIME",
#     "BURGLARY,UNCLASSIFIED,UNKNOWN",
#     "LARCENY,GRANDOFAUTO",
#     "LARCENY,GRANDFROMPERSON,UNCLASSIFIED",
#     "BURGLARY,RESIDENCE,NIGHT",
#     "LARCENY,GRANDFROMPERSON,UNCL",
#     "LARCENY,GRANDFROMOPENAREAS,",
#     "ARSON2,3,4",
#     "LARCENY,GRANDBYEXTORTION",
#     "AGGRAVATEDGRANDLARCENYOFATM",
#     "LARCENY,GRANDBYCREDITCARDUSE",
#     "LARCENY,GRANDBYACQUIRINGLOS",
#     "ARSON1",
#     "BURGLARY,COMMERCIAL,DAY",
#     "LARCENY,GRANDBYTHEFTOFCREDITCARD",
#     "LARCENY,GRANDFROMBUILDING,UNCLASSIFIED",
#     "LARCENY,GRANDFROMBUILDING(NON-RESIDENCE)UNATTENDED")
# 
# arrest_prostitution <- c("PROSTITUTION",
#     "PROSTITUTION,PATRONIZING4,3",
#     "PROSTITUTION4,PROMOTING&SECURING",
#     "PROSTITUTION3,PROMOTINGBUSINESS",
#     "PROSTITUTION4,PROMOTING&SECUR",
#     "SEXTRAFFICKING",
#     "PROSTITUTION3,PROMOTINGUNDER19",
#     "PROSTITUTION,PERMITTING",
#     "PROSTITUTION3,PROMOTINGBUSIN",
#     "PROSTITUTION2,UNDER16",
#     "PROSTITUTION3,PROMOTINGUNDE",
#     "PROSTITUTION2,COMPULSORY",
#     "PROSTITUTION,PATRONIZING2,1",
#     "PROSTITUTION1,UNDER11")
# 
# arrest_qol <- c("CRIMINALMISCHIEF4TH,GRAFFITI",
#     "DISORDERLYCONDUCTSUBD1,2,3,4,5,6,7",
#     "CRIMINALMISCHIEF4TH,GRAFFIT",
#     "ALCOHOLICBEVERAGECONTROLLAW",
#     "GAMBLING2,PROMOTING,UNCLASSIFIED",
#     "FALSEREPORTUNCLASSIFIED",
#     "ASSEMBLY,UNLAWFUL",
#     "GAMBLING,DEVICE,POSSESSION",
#     "LOITERINGFORPROSTITUTIONORTOPATRONIZE",
#     "GAMBLING2,PROMOTING,UNCLASSIF",
#     "DISORDERLYCONDUCT",
#     "PEDDLING,UNLAWFUL",
#     "ALCOHOLICBEVERAGES,PUBLICCON",
#     "FIREWORKS,SALE",
#     "GAMBLING1,PROMOTING,POLICY",
#     "SALEOFUNAUTHORIZEDRECORDINGS",
#     "GAMBLING2,PROMOTING,POLICY-LOTTERY",
#     "NUISANCE,CRIMINAL,UNCLASSIFIED",
#     "OBSCENITY1",
#     "GAMBLING1,PROMOTING,BOOKMAKING",
#     "FALSEALARMFIRE",
#     "NOISE,UNECESSARY",
#     "MANUFACTUREUNAUTHORIZEDRECORDINGS",
#     "LOITERING,GAMBLING,OTHER",
#     "MANUFACTUREUNAUTHORIZEDRECOR",
#     "A.B.C.,FALSEPROOFOFAGE",
#     "LOITERING,TRANSPORTATIONFACILITY",
#     "GAMBLING2,PROMOTING,BOOKMAKING",
#     "FIREWORKS,POSSESS/USE",
#     "BICYCLE(TRAF.INFRAC.UNCLASS.)",
#     "FALSEREPORT1,FIRE",
#     "LOITERING1STDEGREEFORDRUGPURPOSES",
#     "GAMBLING1,PROMOTING,BOOKMAKIN",
#     "OBSCENITY,PERFORMANCE3",
#     "NUISANCE,CRIMINAL",
#     "DIS.CON.,AGGRAVATED",
#     "EAVESDROPPING",
#     "MATERIALOFFENSIVEDISPLAY",
#     "OBSCENITY,MATERIAL3",
#     "LOITERING,SCHOOL",
#     "LOITERING,MASQUERADING",
#     "POSTINGADVERTISEMENTS",
#     "FALSEREPORTBOMB",
#     "SALEOFUNAUTHORIZEDRECORDING",
#     "FIREWORKSPREVCONV5YEARS",
#     "GAMBLING2,PROMOTING,POLICY-",
#     "PEDESTRIAN,WALK/DONTWALK",
#     "PEDESTRIAN/UNCLASSIDIED",
#     "PEDESTRIAN,UNCLASSIFIED",
#     "GAMBLING2,PROMOTING,BOOKMAK",
#     "PLACEFALSEBOMB",
#     "ALCOHOLICBEVERAGECONTROL",
#     "ANARCHY,CRIMINAL",
#     "BICYCLETRAFFICINFRACTIONUNCLASSIFIED",
#     "LOITERING1STDEGREEFORDRUG",
#     "LOITERINGFORPROSTITUTIONOR",
#     "PEDESTRIAN-WALK/DONOTWALK")
# 
# arrest_sex <- c("SEXUALABUSE3,2",
#     "LEWDNESS,PUBLIC",
#     "SEXUALABUSE1",
#     "SODOMY1",
#     "SEXUALABUSE",
#     "OBSCENEMATERIAL-UNDER17YEARSOFAGE",
#     "SEXUALMISCONDUCT,INTERCOURSE",
#     "SODOMY3",
#     "COURSEOFSEXUALCONDUCTAGAINSTACHILD",
#     "OBSCENEMATERIAL-UNDER17YE",
#     "FORCIBLETOUCHING",
#     "PROMOTINGASEXUALPERFORMANCEBYACHILD",
#     "SODOMY2",
#     "COURSEOFSEXUALCONDUCTAGAIN",
#     "PROMOTINGASEXUALPERFORMANCE",
#     "SEXUALMISCONDUCT,DEVIATE",
#     "USEOFACHILDINASEXUALPER",
#     "SEXCRIMES",
#     "USEOFACHILDINASEXUALPERFORMANCE",
#     "EXPOSUREOFAPERSON",
#     "ABORTION1",
#     "INCEST3",
#     "INCEST",
#     "STALKINGCOMMITSEXOFFENSE",
#     "BIGAMY",
#     "EXHIBITION,OFFENSIVE")
# 
# arrest_trespass <- c("TRESPASS3,CRIMINAL",
#     "TRESPASS2,CRIMINAL",
#     "TRESPASS4,CRIMINAL",
#     "TRESPASS1,CRIMINAL",
#     "TRESPASS4,CRIMINALSUB2")
# 
# arrest_violent_crime <- c("ASSAULT3",
#     "ASSAULT2,1,UNCLASSIFIED",
#     "ROBBERY,UNCLASSIFIED,OPENAREAS",
#     "AGGRAVATEDHARASSMENT2",
#     "ROBBERY,OPENAREAUNCLASSIFIED",
#     "ASSAULT2,1,PEACEOFFICER",
#     "ASSAULTPOLICE/PEACEOFFICER",
#     "RAPE1",
#     "RAPE3",
#     "RAPE2",
#     "AGGRAVATEDHARASSMENT1",
#     "KIDNAPPING2",
#     "MANSLAUGHTER,UNCLASSIFIED-NONNEGLIGENT",
#     "ROBBERY,UNCLASSIFIED,OPENAREA",
#     "MANSLAUGHTER,UNCLASSIFIED-NO",
#     "ROBBERY,CARJACKINGOFMVOTHERTHANTRUCK",
#     "ROBBERY,CARJACKING",
#     "KIDNAPPING1",
#     "AGGRAVATEDSEXUALASBUSE",
#     "ROBBERY,GASSTATION")
# 
# arrest_VTL <- c("TRAFFIC,UNCLASSIFIEDMISDEMEAN",
#          "INTOXICATEDDRIVING,ALCOHOL",
#          "TRAFFIC,UNCLASSIFIEDINFRACTION",
#          "TRAFFIC,UNCLASSIFIEDMISDEMEANOR",
#          "TRAFFIC,UNCLASSIFIEDINFRACTIO",
#          "LEAVINGSCENE-ACCIDENT-PERSONA",
#          "IMPAIREDDRIVING,DRUG",
#          "UNLICENSEDOPERATOR",
#          "LIGHTS,IMPROPER",
#          "LEAVINGSCENE-ACCIDENT-PROP.DAMAGE",
#          "LEAVINGTHESCENE/PROPERTYDAMAGE/INJUREDANIMAL",
#          "SIGNAL,FAILTO",
#          "IMPAIREDDRIVING,ALCOHOL",
#          "STOP,FAILTO,ONSIGNAL",
#          "IMPAIREDDRIVING,DRUGS",
#          "ONE-WAYSTREET",
#          "USEOFCELLULARTELEPHONEWHILEDRIVING",
#          "PARKING,UNCLASSIFIED",
#          "SAFETYBELTS",
#          "IMPROPERLIGHTS",
#          "SPEEDING",
#          "IMPAIREDDRIVING/ALCOHOL",
#          "RIGHTOFWAY,VEHICLE",
#          "MANUFATURE,TRANSPORT,DEFACE,ETC...",
#          "FAILTOSIGNAL",
#          "IMPROPERPASSING",
#          "FAILTOSTOPONSIGNAL",
#          "FOLLOWINGTOOCLOSELY",
#          "SEATBELTS",
#          "USECELLPHONEWHILEDRIVING",
#          "ONEWAYSTREET",
#          "TURN,IMPROPER",
#          "FOLLOWINGCLOSELY",
#          "ROGHTOFWAY/VEHICLE",
#          "NYCITY,TRAFFICSUMMONSWARRANT",
#          "RIGHTOFWAY,PEDESTRIAN",
#          "UNDERTHEINFLUENCE,DRUGS")
# 
# arrest_weapon <- c("WEAPONS,POSSESSION,ETC",
#             "WEAPONSPOSSESSION1&2",
#             "WEAPONSPOSSESSION3",
#             "CRIMINALPOSSESSIONWEAPON",
#             "CRIMINALDISPOSALFIREARM1&",
#             "WEAPONS,MFR,TRANSPORT,ETC.",
#             "CRIMINALDISPOSALFIREARM1&2",
#             "CRIMINALDISPOSALFIREARM1",
#             "WEAPONS,PROHIBITEDUSE",
#             "WEAPONS,DISPOSITIONOF",
#             "UNLAWFULPOSS.WEAPONUPONSCHOOLGROUNDS",
#             "LICENSINGFIREARMS",
#             "FIREARMSLICENSINGLAWS",
#             "WEAPONSDISPOSITIONOF",
#             "WEAPONS,PROHIBITEDUSEIMITATI",
#             "WEAPONS,PROHIBITEDUSEIMITATIONPISTOL",
#             "UNLAWFULPOSS.WEAPONUPONSCH",
#             "USINGSLUGS,2ND")

```

```{r}


# full_pd <- full_pd %>% 
#   mutate(pd_desc = str_replace_all(pd_desc, " ","")) %>% 
#   mutate(pd_desc = na_if(pd_desc, "(null)")) %>% 
#   mutate(charge_cat = case_when(pd_desc %in% arrest_bribery ~ "Bribery",
#                             pd_desc %in% arrest_controlled_substance ~ "Controlled Substance",
#                             pd_desc %in% arrest_dv_child ~ "DV/Child",
#                             pd_desc %in% arrest_fraud ~ "Fraud",
#                             pd_desc %in% arrest_marijuana ~ "Marijuana",
#                             pd_desc %in% arrest_minor_property ~ "Minor Property",
#                             pd_desc %in% arrest_minor_violent ~ "Minor Violent",
#                             pd_desc %in% arrest_murder ~ "Murder",
#                             pd_desc %in% arrest_nyslaw_admin ~ "NY Law/Admin",
#                             pd_desc %in% arrest_other ~ "Other",
#                             pd_desc %in% arrest_part1_prop ~ "Major Property",
#                             pd_desc %in% arrest_prostitution ~ "Prostitution",
#                             pd_desc %in% arrest_qol ~ "QOL",
#                             pd_desc %in% arrest_sex ~ "Sex",
#                             pd_desc %in% arrest_trespass ~ "Trespass",
#                             pd_desc %in% arrest_violent_crime ~ "Violent Crime",
#                             pd_desc %in% arrest_VTL ~ "VTL",
#                             pd_desc %in% arrest_weapon ~ "Weapon")) 



```


```{r}

# # sort into Fagan's seven crime types
# 
# full_pd <- full_pd %>% 
#   mutate(charge_cat = case_when(charge_cat %in% c("Murder", "Violent Crime", "Minor Violent") ~ "Violent",
#                                   charge_cat == "Weapon" ~ "Weapon",
#                                   charge_cat %in% c("Major Property", "Minor Property", "Fraud") ~ "Property",
#                                   charge_cat %in% c("Controlled Substance", "Marijuana") ~ "Drug",
#                                   charge_cat %in% c("Trespass", "QOL") ~ "Trespass/Public Order",
#                                   charge_cat %in% c("Prostitution", "Sex","VTL", "Other", "NY Law/Admin", "Bribery", "DV/Child") ~ "Other")) 


# sort into rempel's charge categories


```


### Misdemeanor charge type breakdown

**Total misdemeanor arrests**  
*By select charge types*

```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Misdemeanor or less") %>% 
  mutate(charge_cat = case_when(str_detect(law_code, "PL 15525") ~ "Petit larceny",
                                       str_detect(law_code, "PL 16515") ~ "Theft of services",
                                       str_detect(law_code, "PL 22003") ~ "Misd drug possession",
                                       str_detect(law_code, "PL 220|PL 221|PL 222") ~ "Marijuana",
                                       str_detect(law_code, "PL 120") & !str_detect(law_code, "PL 12045|PL 12055") ~ "Misd assault & related",
                                       str_detect(law_code, "PL 145") ~ "Criminal mischief",
                                       str_detect(law_code, "VTL0511") ~ "Unlicensed driving",
                                       str_detect(law_code, "PL 26501") ~ "Misd weapon",
                                       str_detect(law_code, "PL 14005|PL 14010|PL 14015") ~ "Trespass")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
    mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .95, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma, breaks = seq(0,40000,10000)) +
  expand_limits(y = 40000) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) 


```


**Total misdemeanor arrests, %**  
*By charge type*

```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Misdemeanor or less") %>% 
  mutate(charge_cat = case_when(str_detect(law_code, "PL 15525") ~ "Petit larceny",
                                       str_detect(law_code, "PL 16515") ~ "Theft of services",
                                       str_detect(law_code, "PL 22003") ~ "Misd drug possession",
                                       str_detect(law_code, "PL 220|PL 221|PL 222") ~ "Marijuana",
                                       str_detect(law_code, "PL 120") & !str_detect(law_code, "PL 12045|PL 12055") ~ "Misd assault & related",
                                       str_detect(law_code, "PL 145") ~ "Criminal mischief",
                                       str_detect(law_code, "VTL0511") ~ "Unlicensed driving",
                                       str_detect(law_code, "PL 26501") ~ "Misd weapon",
                                       str_detect(law_code, "PL 14005|PL 14010|PL 14015") ~ "Trespass")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", 
           position = "fill", 
           width = 0.85, 
           key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
         axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), 
                    name = "", 
                    guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, 
                             override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) 


```


```{r}

# sort prosecuted charges into charge categories

full_pros <- full_pros %>% 
  mutate(law_charge = str_replace(law_charge, '`', '')) %>% 
  mutate(law_charge = str_replace(law_charge, ' ', '')) %>% 
  mutate(law_charge = str_replace(law_charge, "'", '')) %>% 
  mutate(law_charge = str_replace(law_charge, '[.]', '')) 

```


**Desk appearance tickets, as % of total arrests**  
*By misdemeanor charge type*

```{r}


full_pros %>% 
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
  mutate(charge_cat = case_when(str_detect(law_charge, "PL15525") ~ "Petit larceny",
                                       str_detect(law_charge, "PL16515") ~ "Theft of services",
                                       str_detect(law_charge, "PL22003") ~ "Misd drug possession",
                                       str_detect(law_charge, "PL220|PL221|PL222") ~ "Marijuana",
                                       str_detect(law_charge, "PL120") & !str_detect(law_charge, "PL12045|PL12055") ~ "Misd assault & related",
                                       str_detect(law_charge, "PL145") ~ "Criminal mischief",
                                       str_detect(law_charge, "VTL511") ~ "Unlicensed driving",
                                       str_detect(law_charge, "PL26501") ~ "Misd weapon",
                                       str_detect(law_charge, "PL14005|PL14010|PL14015") ~ "Trespass")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  filter(!race == "Other") %>% 
  group_by(year, charge_cat, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat, color = race)) +
  geom_point(size = 3) +
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent) +
  scale_x_continuous(breaks = 2013: 2022) +
  theme_classic() +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5), 
        legend.key=element_blank(),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x") 



```




```{r}

arrest_yearly_misd_charge_race <- 
  full_pd %>% 
   mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Misdemeanor or less") %>% 
  mutate(charge_cat = case_when(str_detect(law_code, "PL 15525") ~ "Petit larceny",
                                       str_detect(law_code, "PL 16515") ~ "Theft of services",
                                       str_detect(law_code, "PL 22003") ~ "Misd drug possession",
                                       str_detect(law_code, "PL 220|PL 221|PL 222") ~ "Marijuana",
                                       str_detect(law_code, "PL 120") & !str_detect(law_code, "PL 12045|PL 12055") ~ "Misd assault & related",
                                       str_detect(law_code, "PL 145") ~ "Criminal mischief",
                                       str_detect(law_code, "VTL0511") ~ "Unlicensed driving",
                                       str_detect(law_code, "PL 26501") ~ "Misd weapon",
                                       str_detect(law_code, "PL 14005|PL 14010|PL 14015") ~ "Trespass")) %>% 
  filter(race != "Other") %>% 
  count(year, charge_cat, race)

```


**Arrest rate per 100,000 people**  
*By misdemeanor charge type*

```{r}

left_join(arrest_yearly_misd_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                      labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  scale_y_continuous(breaks = seq(200, 1200, 200), labels = comma_format()) +
  expand_limits(y = 1300)



```

```{r}

# heatmap

arrest_rate_misd_charge <- left_join(arrest_yearly_misd_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%  
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
  mutate(enforcement = "arrest", .before = charge_cat) %>% 
  rename(variable = charge_cat)


```



**Arrest rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change  
*By charge type*

```{r}

left_join(arrest_yearly_misd_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.5)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1.6, 1.4))+
  facet_wrap2(vars(charge_cat), axes = "x") +
      geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.75) 

```

**Arrest racial disparity rate ratio**  
*By charge type*

```{r}

left_join(arrest_yearly_misd_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%  
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
    guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))




```

```{r}

# heatmap


arrest_ratio_misd_charge <- left_join(arrest_yearly_misd_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  mutate(enforcement = "arrest", .before = charge_cat) %>% 
  rename(variable = charge_cat)



```


**Arrest racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change   
*By charge type*

```{r}

left_join(arrest_yearly_misd_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(Black/White,1),
         `Hispanic/White` = round(Hispanic/White,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, add_plusses = TRUE, accuracy = .1), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  facet_wrap2(vars(charge_cat), axes = "all", 
              nrow = 3) +
  expand_limits(x = c(-18, 12)) +
  scale_x_continuous(labels = NULL)



```

### Felony charge type breakdown


**Total felony arrests**  
*By select charge types*

```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_code, "PL 220") ~ "Felony drug possession",
                                  str_detect(law_code, "PL 155") ~ "Grand larceny",
                                  str_detect(law_code, "PL 16005|PL 16010|PL 16015") ~ "Robbery",
                                  str_detect(law_code, "PL 14020|PL 14025|PL 14030") ~ "Burglary",
                                  str_detect(law_code, "PL 12005|PL 12010") ~ "Felony assault",
                                  str_detect(law_code, "PL 265") ~ "Felony weapon")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
    mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .95, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
  scale_y_continuous(breaks = seq(5000,20000,5000), labels = comma_format()) +
  expand_limits(y = 20000)

```


**Total arrests, %**  
*By felony charge type*

```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_code, "PL 220") ~ "Felony drug possession",
                                  str_detect(law_code, "PL 155") ~ "Grand larceny",
                                  str_detect(law_code, "PL 16005|PL 16010|PL 16015") ~ "Robbery",
                                  str_detect(law_code, "PL 14020|PL 14025|PL 14030") ~ "Burglary",
                                  str_detect(law_code, "PL 12005|PL 12010") ~ "Felony assault",
                                  str_detect(law_code, "PL 265") ~ "Felony weapon")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
         axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) 


```



```{r}


full_pros %>% 
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_charge, "PL220") ~ "Felony drug possession",
                                  str_detect(law_charge, "PL155") ~ "Grand larceny",
                                  str_detect(law_charge, "PL16005|PL16010|PL16015") ~ "Robbery",
                                  str_detect(law_charge, "PL14020|PL14025|PL14030") ~ "Burglary",
                                  str_detect(law_charge, "PL12005|PL12010") ~ "Felony assault",
                                  str_detect(law_charge, "PL265") ~ "Felony weapon")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  filter(!race == "Other") %>% 
  group_by(year, charge_cat, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat, color = race)) +
  geom_point(size = 3) +
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent) +
  scale_x_continuous(breaks = 2013: 2022) +
  theme_classic() +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5), 
        legend.key=element_blank(),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x") 



```


```{r}

arrest_yearly_fel_charge_race <- 
  full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_code, "PL 220") ~ "Felony drug possession",
                                  str_detect(law_code, "PL 155") ~ "Grand larceny",
                                  str_detect(law_code, "PL 16005|PL 16010|PL 16015") ~ "Robbery",
                                  str_detect(law_code, "PL 14020|PL 14025|PL 14030") ~ "Burglary",
                                  str_detect(law_code, "PL 12005|PL 12010") ~ "Felony assault",
                                  str_detect(law_code, "PL 265") ~ "Felony weapon")) %>% 
  filter(race != "Other") %>% 
  count(year, charge_cat, race)

```


**Arrest rate per 100,000 people**  
*By felony charge type*

```{r}

left_join(arrest_yearly_fel_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate) %>%
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                      labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))



```


```{r}

# heatmap

arrest_rate_fel_charge <- left_join(arrest_yearly_fel_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
    mutate(enforcement = "arrest", .before = charge_cat) %>% 
  rename(variable = charge_cat)


```



**Arrest rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change  
*By felony charge type*

```{r}

left_join(arrest_yearly_fel_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1.5, 1.4))+
  facet_wrap2(vars(charge_cat), axes = "x") +
      geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.75) 

```

**Arrest racial disparity rate ratio**  
*By charge type*

```{r}

left_join(arrest_yearly_fel_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 32) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
    guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))




```

```{r}

# heatmap


arrest_ratio_fel_charge <- left_join(arrest_yearly_fel_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  mutate(enforcement = "arrest", .before = charge_cat) %>% 
  rename(variable = charge_cat)



```


**Arrest racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change   
*By charge type*

```{r}

left_join(arrest_yearly_fel_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(Black/White,1),
         `Hispanic/White` = round(Hispanic/White,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -.75, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, add_plusses = TRUE, accuracy = .1), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  facet_wrap2(vars(charge_cat), axes = "all", 
              nrow = 3) +
  expand_limits(x = c(-6, 14)) +
  scale_x_continuous(labels = NULL)



```


```{r}

arrest_rates <- rbind(arrest_rate_boro, 
                    arrest_rate_age,
                    arrest_rate_severity,
                    arrest_rate_misd_charge,
                    arrest_rate_fel_charge)


```


```{r}

arrest_ratios <- rbind(arrest_ratio_boro, 
                     arrest_ratio_age,
                     arrest_ratio_severity,
                     arrest_ratio_misd_charge,
                     arrest_ratio_fel_charge)


```


**Change in arrest rate across subgroups, 2022 vs. 2013**

```{r}

arrest_rates %>% 
  filter(period == "'22 vs '13",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black", "Hispanic", "White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  scale_y_continuous(labels = percent_format(), breaks = c(-1, 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y = 1.2)





```


**Change in arrest rate across subgroups, 2022 vs. 2019**

```{r}

arrest_rates %>% 
  filter(period == "'22 vs '19",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black", "Hispanic", "White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free_y")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  scale_y_continuous(labels = percent_format(), breaks = c(-1, 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y = 1.2)


```



**Change in arrest racial disparity rate ratio across subgroups, 2022 vs 2013**

```{r}

arrest_ratios %>% 
  filter(period == "'22 vs '13",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         value = as.numeric(value),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  theme(axis.text.x = element_text(size = 6)) + 
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(breaks = seq(-6,12,3)) +
  expand_limits(y = c(-6,9))




```

**Change in arrest racial disparity rate ratio across subgroups, 2022 vs 2019**

```{r}

arrest_ratios %>% 
  filter(period == "'22 vs '19",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         value = as.numeric(value),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  theme(axis.text.x = element_text(size = 6)) +
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(breaks = seq(-10,15,5))+
  expand_limits(y = c(-10,10))


```


### Prosecutions by Race, 2013-2022


**Total prosecutions**

```{r}


full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, race) %>% 
  summarise(n = n()) %>% 
  mutate(sum = sum(n)) %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic()+
  theme(legend.background = element_rect(fill = "white"), 
        legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5), 
        legend.key=element_blank())+
  scale_y_continuous(labels = NULL)+
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  scale_x_continuous(breaks = 2013: 2022) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  geom_text(aes(y = sum, label = comma(sum)), vjust = -.85, size = 2.8,  format = comma, check_overlap = TRUE) 

```

**Total prosecutions, %**

```{r}


full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(year, percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  geom_text(aes(label = ifelse(percent > 3, paste0(percent, "%"), "")), size = 3.5, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  geom_text(aes(label = ifelse(percent < 3, paste0(percent, "%"), "")), size = 2.6, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  theme_classic() +
  theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_x_continuous(breaks = 2013: 2022)  +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks"))

```



```{r}

pros_yearly_race <- full_pros %>% 
  filter(race != "Other",
         age > 9) %>% 
  count(year, race)

```

**Prosecution rate per 100,000 people**

```{r}

left_join(pros_yearly_race, OCA_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  select(year, race, rate) %>%
  filter(!year == 2015) %>% 
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3)+
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  scale_y_continuous(labels = comma, breaks = seq(0,10000,2000))+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#C32B30")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))



```

```{r}

# heatmap

pros_rate_all <- left_join(pros_yearly_race, OCA_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1, 6:9) %>% 
  pivot_longer(!race, names_to = "period", values_to = "percent") %>% 
  mutate(percent = as.numeric(percent),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = percent) %>% 
  relocate(Black, .before = Hispanic) %>% 
  mutate(variable = "all", .before = period) %>% 
  mutate(enforcement = "prosecution", .before = variable)

```

**Prosecution rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change

```{r}


left_join(pros_yearly_race, OCA_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1, 5:6) %>% 
  pivot_longer(!race, names_to = "period", values_to = "percent") %>% 
  mutate(percent = as.numeric(percent),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  mutate(vert_just = ifelse(percent > 0, -1, 1.8)) %>% 
  ggplot(aes(percent, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = percent, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  scale_x_continuous(labels = NULL) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = percent(percent, accuracy =1), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3)

```

**Prosecution racial disparity rate ratio**

```{r}

left_join(pros_yearly_race, OCA_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  filter(!year == 2015) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(nhblack/nhwhite,1),
         `Hispanic/White` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  ggplot(aes(year, value, color = race)) +
  geom_line(size = 1, key_glyph = draw_key_point) +
  geom_point(size = 2.5)+
  theme_classic() +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5), 
        legend.key=element_blank()) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(breaks = seq(0,8,2)) +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(y = c(0,8))

```

```{r}

# heatmap


pros_ratio_all <- left_join(pros_yearly_race, OCA_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = nhblack/nhwhite,
         `Hispanic/White` = hispanic/nhwhite) %>% 
  filter(year %in% c(2013,2019,2021,2022)) %>% 
  select(1,5:6) %>% 
  rotate_df() %>% 
  rownames_to_column(var = "race") %>% 
  mutate_at(c('V1', 'V2', 'V3', 'V4'), as.numeric) %>% 
  filter(!row_number() %in% c(1)) %>% 
  mutate(`'21 vs '13`=  V3-V1,
         `'21 vs '19` = V3-V2,
         `'22 vs '13` = V4-V1,
         `'22 vs '19` = V4-V2) %>% 
  select(1, 6:9) %>% 
  pivot_longer(!race, names_to = "period", values_to = "change") %>% 
  mutate(period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = change) %>% 
  mutate(variable = "all", .before = period) %>% 
  mutate(enforcement = "prosecution", .before = variable)



```


**Prosecution racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, % absolute change


```{r}


left_join(pros_yearly_race, OCA_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(nhblack/nhwhite,1),
         `Hispanic/White` = round(hispanic/nhwhite,1)) %>% 
  filter(year %in% c(2013,2019,2022)) %>% 
  select(1,5:6) %>% 
  rotate_df() %>% 
  rownames_to_column(var = "race") %>% 
  mutate_at(c('V1', 'V2', 'V3'), as.numeric) %>% 
  filter(!row_number() %in% c(1)) %>% 
  mutate(`'22 vs '13` = round(V3-V1,1),
         `'22 vs '19` = round(V3-V2,1)) %>% 
  select(1, 5:6) %>% 
  pivot_longer(!race, names_to = "period", values_to = "change") %>% 
  ggplot(aes(change, period)) +
  coord_flip() +
  geom_errorbarh(aes(xmin = 0, xmax = change, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = 1.1) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(change, accuracy = .1, add_plusses = TRUE), group = race), 
            position = position_dodge(width = .9),
            size = 3,
            vjust = -1) +
  scale_x_continuous(labels = NULL)

```

### Borough breakdown

**Total prosecutions**  
*By borough*

```{r}
full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  mutate(county = case_when(county == "BRONX" ~ "Bronx",
                            county == "KINGS" ~ "Brooklyn",
                            county == "NEW YORK" ~ "Manhattan",
                            county == "QUEENS" ~ "Queens",
                            county == "RICHMOND" ~ "Staten Island")) %>% 
  rename(boro = county) %>% 
  group_by(year, boro, race) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .95, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma, breaks = seq(0,100000, 25000)) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(boro), axes = "x", nrow = 2) 

```


**Total prosecutions, %**  
*By borough*

```{r}

full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  mutate(county = case_when(county == "BRONX" ~ "Bronx",
                            county == "KINGS" ~ "Brooklyn",
                            county == "NEW YORK" ~ "Manhattan",
                            county == "QUEENS" ~ "Queens",
                            county == "RICHMOND" ~ "Staten Island")) %>% 
  rename(boro = county) %>%
  group_by(year, boro, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(boro), axes = "x", nrow = 2) 


```




```{r}

OCA_census_boro_race <- census_OCA_projected %>% 
  filter(age_group > 2) %>% 
  mutate(boro = case_when(borough == "bronx" ~ "Bronx",
                          borough == "kings" ~ "Brooklyn",
                          borough == "manhattan" ~ "Manhattan",
                          borough == "queens" ~ "Queens",
                          borough == "si" ~ "Staten Island")) %>% 
  group_by(year, boro, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

pros_yearly_boro_race <- full_pros %>% 
  mutate(county = case_when(county == "BRONX" ~ "Bronx",
                            county == "KINGS" ~ "Brooklyn",
                            county == "NEW YORK" ~ "Manhattan",
                            county == "QUEENS" ~ "Queens",
                            county == "RICHMOND" ~ "Staten Island")) %>% 
  rename(boro = county) %>%
  filter(race != "Other",
         !is.na(boro),
         age > 9) %>% 
  count(year, boro, race)

```

**Prosecution rate per 100,000 people**  
*By borough*

```{r}

left_join(pros_yearly_boro_race, OCA_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, boro, race, rate) %>%
  filter(year != 2015) %>% 
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(boro), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  scale_y_continuous(breaks = seq(5000,25000, 5000), labels = comma_format())

```

```{r}

# heatmap

pros_rate_boro <- left_join(pros_yearly_boro_race, OCA_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic)  %>% 
  rename(variable = boro) %>% 
  mutate(enforcement = "prosecution", .before = variable)
  


```


**Prosecution rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change  
*By borough*

```{r}

left_join(pros_yearly_boro_race, OCA_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = 1)+
  facet_wrap2(vars(boro), axes = "x") +
   geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.75) 

```

**Prosecution racial disparity rate ratio**  
*By borough*

```{r}



left_join(pros_yearly_boro_race, OCA_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, boro, race, rate)  %>%  
  filter(year != 2015) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = nhblack/nhwhite,
         `Hispanic/White` = hispanic/nhwhite) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, boro, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3)+
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(5,20,5)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(boro), axes = "x") +
    guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  expand_limits(y = 20)
  



```

```{r}

# heatmap

pros_ratio_boro <- left_join(pros_yearly_boro_race, OCA_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = nhblack/nhwhite,
         `Hispanic/White` = hispanic/nhwhite) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  rename(variable = boro) %>% 
  mutate(enforcement = "prosecution", .before = variable)

```


**Prosecution racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change    
*By borough*


```{r}

left_join(pros_yearly_boro_race, OCA_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(nhblack/nhwhite,1),
         `Hispanic/White` = round(hispanic/nhwhite,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, accuracy = .1, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  expand_limits(x = c(-3,6))+
  scale_x_continuous(labels = NULL)+
  facet_wrap2(vars(boro), axes = "all") 
  


```


### Age breakdown

**Total prosecutions**  
*By age*

```{r}

full_pros %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 ~ "45+")) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!is.na(age_cat)) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma, breaks = seq(0,175000,25000)) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) 


```

**Total prosecutions, %**  
*By age*

```{r}

full_pros %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 ~ "45+")) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!is.na(age_cat)) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))  +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) 

```



```{r}

OCA_census_age_race <- census_OCA_projected %>% 
  filter(age_group > 2) %>% 
  mutate(age_cat = case_when(age_group >= 3 & age_group <= 5 ~ "<25",
                             age_group >= 6 & age_group <= 9 ~ "25-44",
                             age_group >= 10 ~ "45+")) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

pros_yearly_age_race <- full_pros %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 ~ "45+")) %>% 
  filter(race != "Other",
         !is.na(age_cat)) %>% 
  count(year, age_cat, race)


```

**Prosecution rate per 100,000 people**  
*By age*

```{r}

left_join(pros_yearly_age_race, OCA_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, age_cat, race, rate) %>%
  filter(year != 2015) %>% 
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma) + 
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,15000,2500)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 

```

```{r}

# heatmap

pros_rate_age <- left_join(pros_yearly_age_race, OCA_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
  rename(variable = age_cat) %>% 
  mutate(enforcement = "prosecution", .before = variable)

```


**Prosecution rate per 100,000 people**   
Compared to historic ('13) and recent ('19) baseline, % change   
*By age*

```{r}

left_join(pros_yearly_age_race, OCA_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  expand_limits(x = c(-1.15,1)) +
   geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.75) 

```


**Prosecution racial disparity rate ratio**  
*By age*



```{r}

left_join(pros_yearly_age_race, OCA_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, age_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, age_cat, race, value) %>%
  filter(year != 2015) %>% 
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2, scales = "free") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 



```

```{r}

# heatmap

pros_ratio_age <- left_join(pros_yearly_age_race, OCA_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  rename(variable = age_cat) %>% 
  mutate(enforcement = "prosecution", .before = variable)

```


**Prosecution racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change    
*By age*

```{r}

left_join(pros_yearly_age_race, OCA_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = round(Black/White,1),
         `Hispanic/White` = round(Hispanic/White,1)) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, accuracy = .1, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  expand_limits(x = c(-4,7))+
  scale_x_continuous(labels = NULL)+
  facet_wrap2(vars(age_cat), axes = "all", nrow = 2)


```


### Charge severity breakdown   

**Total prosecutions**  
*By severity*

```{r}

full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  group_by(year, severity, race) %>% 
  summarise(n = n()) %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic()+
  theme(legend.background = element_rect(fill = "white"), 
        legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5), 
        legend.key=element_blank())+
  scale_y_continuous(labels = comma)+
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = 2013: 2022) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(severity), axes = "x")


```

**Total prosecutions, %**  
*By severity*

```{r}


full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  group_by(year, severity, race) %>%  
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(year, percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_y_continuous(labels = percent)  +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = percent_format()) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(severity), axes = "x")

```


```{r}

pros_yearly_severity_race <- full_pros %>% 
 mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(race != "Other",
         !is.na(severity)) %>% 
  count(year, severity, race)

```

**Prosecution rate per 100,000 people**  
*By severity*

```{r}

left_join(pros_yearly_severity_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, severity, race, rate) %>%
  filter(year != 2015) %>% 
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(severity), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                      labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))



```

```{r}

# heatmap 

pros_rate_severity <- left_join(pros_yearly_severity_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, severity, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>%  
  pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
  rename(variable = severity) %>% 
  mutate(enforcement = "prosecution", .before = variable)


```


**Prosecution rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change    
*By severity*

```{r}

left_join(pros_yearly_severity_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, severity, race, rate) %>% 
    filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  expand_limits(x = c(-1,.25)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = 1)+
  facet_wrap2(vars(severity), axes = "x") +
     geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.75) 
```


**Prosecution racial disparity rate ratio**  
*By severity*

```{r}

left_join(pros_yearly_severity_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, severity, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, severity, race, value) %>%
  filter(year != 2015) %>% 
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(breaks = seq(0,10,2)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(severity), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  expand_limits(y = 10)



```

```{r}

# heatmap

pros_ratio_severity <- left_join(pros_yearly_severity_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, severity, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  rename(variable = severity) %>% 
  mutate(enforcement = "prosecution", .before = variable)



```


**Prosecution racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change  
*By severity*

```{r}

left_join(pros_yearly_severity_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, severity, race, rate)  %>%  
 filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1,2.2)) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, accuracy = .1, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  facet_wrap2(vars(severity), axes = "all") +
  scale_x_continuous(labels = NULL)


```

**Total prosecutions**  
*By misdemeanor charge type*

```{r}

full_pros %>% 
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
    mutate(charge_cat = case_when(str_detect(law_charge, "PL15525") ~ "Petit larceny",
                                       str_detect(law_charge, "PL16515") ~ "Theft of services",
                                       str_detect(law_charge, "PL22003") ~ "Misd drug possession",
                                       str_detect(law_charge, "PL220|PL221|PL222") ~ "Marijuana",
                                       str_detect(law_charge, "PL120") & !str_detect(law_charge, "PL12045|PL12055") ~ "Misd assault & related",
                                       str_detect(law_charge, "PL145") ~ "Criminal mischief",
                                       str_detect(law_charge, "VTL511") ~ "Unlicensed driving",
                                       str_detect(law_charge, "PL26501") ~ "Misd weapon",
                                       str_detect(law_charge, "PL14005|PL14010|PL14015") ~ "Trespass")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .95, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) 


```

**Total prosecutions, %**  
*By misdemeanor charge type*

```{r}

full_pros %>% 
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
    mutate(charge_cat = case_when(str_detect(law_charge, "PL15525") ~ "Petit larceny",
                                       str_detect(law_charge, "PL16515") ~ "Theft of services",
                                       str_detect(law_charge, "PL22003") ~ "Misd drug possession",
                                       str_detect(law_charge, "PL220|PL221|PL222") ~ "Marijuana",
                                       str_detect(law_charge, "PL120") & !str_detect(law_charge, "PL12045|PL12055") ~ "Misd assault & related",
                                       str_detect(law_charge, "PL145") ~ "Criminal mischief",
                                       str_detect(law_charge, "VTL511") ~ "Unlicensed driving",
                                       str_detect(law_charge, "PL26501") ~ "Misd weapon",
                                       str_detect(law_charge, "PL14005|PL14010|PL14015") ~ "Trespass")) %>% 
  filter(!is.na(charge_cat)) %>% 
     mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
    mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
         axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) 


```


```{r}

pros_yearly_misd_charge_race <- full_pros %>%
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
    mutate(charge_cat = case_when(str_detect(law_charge, "PL15525") ~ "Petit larceny",
                                       str_detect(law_charge, "PL16515") ~ "Theft of services",
                                       str_detect(law_charge, "PL22003") ~ "Misd drug possession",
                                       str_detect(law_charge, "PL220|PL221|PL222") ~ "Marijuana",
                                       str_detect(law_charge, "PL120") & !str_detect(law_charge, "PL12045|PL12055") ~ "Misd assault & related",
                                       str_detect(law_charge, "PL145") ~ "Criminal mischief",
                                       str_detect(law_charge, "VTL511") ~ "Unlicensed driving",
                                       str_detect(law_charge, "PL26501") ~ "Misd weapon",
                                       str_detect(law_charge, "PL14005|PL14010|PL14015") ~ "Trespass")) %>% 
  filter(race != "Other",
         age > 9,
         !is.na(charge_cat)) %>% 
  count(year, charge_cat, race)

```

**Prosecution rate per 100,000 people**  
*By misdemeanor charge type*

```{r}

left_join(pros_yearly_misd_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate) %>%
  filter(year!=2015) %>% 
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                      labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))



```

```{r}

# heatmap

pros_rate_misd_charge <- left_join(pros_yearly_misd_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
    pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
  rename(variable = charge_cat) %>% 
  mutate(enforcement = "prosecution", .before = variable)




```


**Prosecution rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change  
*By misdemeanor charge type*

```{r}

left_join(pros_yearly_misd_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1.6,1))+
  facet_wrap2(vars(charge_cat), axes = "x") +
   geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.75) 

```

**Prosecution racial disparity rate ratio**  
*By misdemeanor charge type*

```{r}

left_join(pros_yearly_misd_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>%
  filter(year!=2015) %>% 
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma, breaks = seq(0,30,5)) +
  xlab("") +
  expand_limits(y = 30) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
  easy_remove_y_axis(what = c("line", "ticks")) +
    guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))




```

```{r}

# heatmap

pros_ratio_misd_charge <- left_join(pros_yearly_misd_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  rename(variable = charge_cat) %>% 
  mutate(enforcement = "prosecution", .before = variable)



```


**Prosecution racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change  
*By misdemeanor charge type*

```{r}

left_join(pros_yearly_misd_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, accuracy = .1, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  facet_wrap2(vars(charge_cat), axes = "all", 
              nrow = 3)+
  expand_limits(x = c(-10.5,18.9))+
  scale_x_continuous(labels = NULL) 


```


### Felony charge type

**Total prosecutions**  
*By felony charge type*

```{r}

full_pros %>% 
  mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_charge, "PL220") ~ "Felony drug possession",
                                  str_detect(law_charge, "PL155") ~ "Grand larceny",
                                  str_detect(law_charge, "PL16005|PL16010|PL16015") ~ "Robbery",
                                  str_detect(law_charge, "PL14020|PL14025|PL14030") ~ "Burglary",
                                  str_detect(law_charge, "PL12005|PL12010") ~ "Felony assault",
                                  str_detect(law_charge, "PL265") ~ "Felony weapon")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .95, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma, breaks = seq(0,15000,5000)) +
  expand_limits(y = 15000) +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  scale_y_continuous(labels = comma) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) 


```

**Total prosecutions, %**  
*By felony charge type*

```{r}

full_pros %>% 
  mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_charge, "PL220") ~ "Felony drug possession",
                                  str_detect(law_charge, "PL155") ~ "Grand larceny",
                                  str_detect(law_charge, "PL16005|PL16010|PL16015") ~ "Robbery",
                                  str_detect(law_charge, "PL14020|PL14025|PL14030") ~ "Burglary",
                                  str_detect(law_charge, "PL12005|PL12010") ~ "Felony assault",
                                  str_detect(law_charge, "PL265") ~ "Felony weapon")) %>% 
  filter(!is.na(charge_cat)) %>% 
     mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
    mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
         axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#C32B30", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = "line")+
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) 


```


```{r}

pros_yearly_fel_charge_race <- full_pros %>%
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_charge, "PL220") ~ "Felony drug possession",
                                  str_detect(law_charge, "PL155") ~ "Grand larceny",
                                  str_detect(law_charge, "PL16005|PL16010|PL16015") ~ "Robbery",
                                  str_detect(law_charge, "PL14020|PL14025|PL14030") ~ "Burglary",
                                  str_detect(law_charge, "PL12005|PL12010") ~ "Felony assault",
                                  str_detect(law_charge, "PL265") ~ "Felony weapon")) %>% 
  filter(race != "Other",
         age > 9,
         !is.na(charge_cat)) %>% 
  count(year, charge_cat, race)

```

**Prosecution rate per 100,000 people**  
*By felony charge type*

```{r}

left_join(pros_yearly_fel_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate) %>%
  filter(year!=2015) %>% 
  ggplot(aes(year, rate, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 2) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2", "#C32B30")) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                      labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  scale_y_continuous(breaks = seq(0,400,100)) +
  expand_limits(y = 400)



```

```{r}

# heatmap

pros_rate_fel_charge <- left_join(pros_yearly_fel_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = (x2021-x2013)/x2013,
         `'22 vs '13` = (x2022-x2013)/x2013,
         `'21 vs '19` = (x2021-x2019)/x2019,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
    pivot_wider(names_from = race, values_from = value) %>% 
  relocate(Black, .before = Hispanic) %>% 
  rename(variable = charge_cat) %>% 
  mutate(enforcement = "prosecution", .before = variable)




```


**Prosecution rate per 100,000 people**  
Compared to historic ('13) and recent ('19) baseline, % change  
*By felony charge type*

```{r}

left_join(pros_yearly_fel_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
  mutate(rate = round((n/total_pop)*100000)) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = rate)  %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = (x2022-x2013)/x2013,
         `'22 vs '19` = (x2022-x2019)/x2019) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(value = as.numeric(value),
         race = as.factor(race),
         period = as.factor(period),
         period = fct_relevel(period, "'22 vs '13","'22 vs '19")) %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8)) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black", "Hispanic", "White"), values = c("#233267","#2CAAE2", "#C32B30")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(labels = NULL) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  expand_limits(x = c(-1.6,1))+
  facet_wrap2(vars(charge_cat), axes = "x") +
   geom_text(aes(label = signs((value), add_plusses = TRUE, accuracy = 1, format = scales::percent), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 2.75) 

```

**Prosecution racial disparity rate ratio**  
*By felony charge type*

```{r}

left_join(pros_yearly_fel_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>% 
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/White`, `Hispanic/White`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>%
  filter(year!=2015) %>% 
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 6)) +
  scale_y_continuous(labels = comma, breaks = seq(0,30,5)) +
  xlab("") +
  expand_limits(y = c(0,30)) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
  easy_remove_y_axis(what = c("line", "ticks")) +
    guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  expand_limits(y = 31)




```

```{r}

# heatmap

pros_ratio_fel_charge <- left_join(pros_yearly_fel_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2021","2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
  filter(year %in% c("2013", "2019", "2021", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'21 vs '13` = x2021-x2013,
         `'21 vs '19` = x2021-x2019,
         `'22 vs '13` = x2022-x2013,
         `'22 vs '19` = x2022-x2019) %>% 
  select(1:2, 7:10) %>% 
  pivot_longer(cols = c(`'21 vs '13`, `'21 vs '19`, `'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(period = fct_relevel(period, "'21 vs '13", "'22 vs '13", "'21 vs '19", "'22 vs '19")) %>% 
  pivot_wider(names_from = race, values_from = value) %>% 
  rename(variable = charge_cat) %>% 
  mutate(enforcement = "prosecution", .before = variable)



```


**Prosecution racial disparity rate ratio**  
Compared to historic ('13) and recent ('19) baseline, absolute change  
*By felony charge type*

```{r}

left_join(pros_yearly_fel_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%
  mutate(rate = (n/total_pop)*100000) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, charge_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") %>% 
  mutate(vert_just = ifelse(value > 0, -1, 1.8),
         period = fct_relevel(period, "'22 vs '13", "'22 vs '19")) %>% 
  ggplot(aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black/White", "Hispanic/White"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  geom_text(aes(label = signs(value, accuracy = .1, add_plusses = TRUE), vjust = vert_just, group = race), 
            position = position_dodge(width = .9),
            size = 3) +
  facet_wrap2(vars(charge_cat), axes = "all", 
              nrow = 3)+
  expand_limits(x = c(-10.5,18.9))+
  scale_x_continuous(labels = NULL) 


```


```{r}

pros_rates <- rbind(pros_rate_boro, 
                    pros_rate_age,
                    pros_rate_severity,
                    pros_rate_misd_charge,
                    pros_rate_fel_charge)


```


```{r}

pros_ratios <- rbind(pros_ratio_boro, 
                    pros_ratio_age,
                    pros_ratio_severity,
                    pros_ratio_misd_charge,
                    pros_ratio_fel_charge)


```


**Change in prosecution rate across subgroups, 2022 vs. 2013**

```{r}

pros_rates %>% 
  filter(period == "'22 vs '13",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black", "Hispanic", "White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free_y")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  scale_y_continuous(labels = percent_format(), breaks = c( -1, 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y = 1.2)



```


**Change in prosecution rate across subgroups, 2022 vs. 2019**

```{r}

pros_rates %>% 
  filter(period == "'22 vs '19",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black", "Hispanic", "White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free_y")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  scale_y_continuous(labels = percent_format(), breaks = c( -1, 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y = 1.2)


```



**Change in prosecution racial disparity rate ratio across subgroups, 2022 vs 2013**

```{r}

pros_ratios %>% 
  filter(period == "'22 vs '13",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         value = as.numeric(value),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  theme(axis.text.x = element_text(size = 6)) +
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(breaks = seq(-4,12,2)) +
  expand_limits(y = c(-4,12))



```


**Change in prosecution racial disparity rate ratio across subgroups, 2022 vs 2019**

```{r}

pros_ratios %>% 
  filter(period == "'22 vs '19",
         variable != "all",
         variable != "Other") %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  mutate(race = as.factor(race),
         value = as.numeric(value),
         variable = reorder_within(variable, -value, race)) %>% 
  ggplot(aes(variable, value, fill = race))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  facet_wrap(~race, scales = "free")+
  scale_x_reordered()+
  scale_fill_manual(values = c( "#233267", "#2CAAE2", "#C32B30"))+
  geom_hline(lty = 2, yintercept = 0) +
  labs(y = '', x = '') +
  theme(axis.text.y = element_text(size = 6)) +
  theme_classic() +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(breaks = seq(-2,10,2)) +
  expand_limits(y = c(-2,10))


```

