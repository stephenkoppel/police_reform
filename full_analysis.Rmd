---
title: "updated police reform"
author: "Stephen Koppel"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r}

setwd("C:/R Projects/Police Reform/Analysis")

```

## packages

```{r}


library(tidyverse)
library(janitor)
library(lubridate)
library(ggthemes)
library(ggeasy)
library(sjmisc)
library(weights)
library(scales)
library(ggh4x)
library(showtext)
library(extrafont)
library(tidytext)
library(signs)
library(tidymodels)



```

setwd("C:/R Projects/Police Reform/Analysis")

options(scipen=999)

## census data prep

```{r}

census_PD_projected <- read_csv("PD_census_with_projection.csv")

```

```{r}

# excludes below 10

PD_census_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  group_by(year, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

census_OCA_projected <- read_csv("OCA_census_with_projection.csv")

```

```{r}

# excludes below 10

OCA_census_race <- census_OCA_projected %>% 
  filter(age_group > 2) %>% 
  group_by(year, race) %>% 
  summarise(total_pop = sum(value))

```


## SQF data prep

```{r}

sqf_2013 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2013.csv") 


sqf_2013 <- sqf_2013 %>% 
  mutate(hit = if_else(arstmade == "Y"| sumissue == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(arstmade == "Y", "Y","N")) %>% 
  mutate(datestop = mdy(datestop)) %>% 
  select(date = datestop, sex, age, race, boro = city, crimsusp, frisked, searched, hit, arrest_hit, pct) 

sqf_2013 <- sqf_2013 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))


```



```{r}

sqf_2014 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2014.csv") 

sqf_2014 <- sqf_2014 %>% 
  mutate(hit = if_else(arstmade == "Y"| sumissue == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(arstmade == "Y", "Y","N")) %>% 
  mutate(datestop = mdy(datestop)) %>% 
  select(date = datestop, sex, age, race, boro = city, crimsusp, frisked, searched, hit, arrest_hit, pct) 

sqf_2014 <- sqf_2014 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))


```

```{r}

sqf_2015 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2015.csv") 

sqf_2015 <- sqf_2015 %>% 
  mutate(hit = if_else(arstmade == "Y"| sumissue == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(arstmade == "Y", "Y","N")) %>% 
  mutate(datestop = mdy(datestop)) %>% 
  select(date = datestop, sex, age, race, boro = city, crimsusp, frisked, searched, hit, arrest_hit, pct)

sqf_2015 <- sqf_2015 %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))


```

```{r}

sqf_2016 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2016.csv") 

sqf_2016 <- sqf_2016 %>% 
  mutate(hit = if_else(arstmade == "Y"| sumissue == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(arstmade == "Y", "Y","N")) %>% 
  mutate(datestop = mdy(datestop)) %>% 
  select(date = datestop, sex, age, race, boro = city, crimsusp, frisked, searched, hit, arrest_hit, pct)

sqf_2016 <- sqf_2016 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))

```


```{r}

sqf_2017 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2017.csv") 


sqf_2017 <- sqf_2017 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct) 

sqf_2017 <- sqf_2017 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(pct = as.integer(pct))

```

```{r}

sqf_2018 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2018.csv") 

sqf_2018 <- sqf_2018 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>%
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2018 <- sqf_2018 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date, format="%m/%d/%Y")) %>% 
  mutate(date = as.Date(date, format = "%Y/%m/%d")) %>% 
  mutate(pct = as.integer(pct))

```

```{r}

sqf_2019 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2019.csv") 

sqf_2019 <- sqf_2019 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2019 <- sqf_2019 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date, format="%m/%d/%Y")) %>% 
  mutate(date = as.Date(date, format = "%Y/%m/%d")) %>% 
  mutate(pct = as.integer(pct))

```

```{r}

sqf_2020 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2020.csv") 

sqf_2020 <- sqf_2020 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2020 <- sqf_2020 %>% 
  mutate(date = as.Date(date, format="%m/%d/%Y")) %>% 
  mutate(date = as.Date(date, format = "%Y/%m/%d")) %>% 
  mutate(pct = as.integer(pct))


```

```{r}

sqf_2021 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2021.csv") 

sqf_2021 <- sqf_2021 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2021 <- sqf_2021 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(pct = as.integer(pct))

```

```{r}

sqf_2022 <- read_csv("C:/R Projects/Police Reform/SQF/sqf_2022.csv") 

sqf_2022 <- sqf_2022 %>% 
  clean_names() %>% 
  mutate(hit = if_else(suspect_arrested_flag == "Y"| summons_issued_flag == "Y", "Y", "N")) %>% 
  mutate(arrest_hit = if_else(suspect_arrested_flag == "Y", "Y", "N")) %>% 
  select(date = stop_frisk_date, sex = suspect_sex, age = suspect_reported_age, race = suspect_race_description, boro = stop_location_boro_name, crimsusp = suspected_crime_description, frisked = frisked_flag, searched = searched_flag, hit, arrest_hit, pct = stop_location_precinct)

sqf_2022 <- sqf_2022 %>% 
  mutate(age = as.integer(age)) %>% 
  mutate(date = as.Date(date, format="%m/%d/%Y")) %>% 
  mutate(date = as.Date(date, format = "%Y/%m/%d")) %>% 
  mutate(pct = as.integer(pct))

```


```{r}

full_sqf <- bind_rows(sqf_2013, sqf_2014, sqf_2015, sqf_2016, sqf_2017, sqf_2018, sqf_2019, sqf_2020, sqf_2021, sqf_2022)

rm(sqf_2013, sqf_2014, sqf_2015, sqf_2016, sqf_2017, sqf_2018, sqf_2019, sqf_2020, sqf_2021, sqf_2022)

```


```{r}

full_sqf <- full_sqf %>% 
  mutate(year = year(date)) %>% 
  mutate(race = case_when(race %in% c("B", "BLACK") ~ "nhblack",
                          race %in% c("P","Q", "WHITE HISPANIC", "BLACK HISPANIC") ~ "hispanic",
                          race %in% c("W", "WHITE") ~ "nhwhite",
                          TRUE ~ "Other")) %>% 
  mutate(boro = case_when(boro == "BRONX" ~ "Bronx",
                          boro == "BROOKLYN" ~ "Brooklyn",
                          boro == "MANHATTAN" ~ "Manhattan",
                          boro == "QUEENS" ~ "Queens",
                          boro %in% c("STATEN IS", "STATEN ISLAND") ~ "Staten Island")) 

```





## SQF analyses

```{r}

## total stops citywide

full_sqf %>%
  group_by(year) %>%
  summarise(n = n()) %>%
  ggplot(aes(x= year, y = n, fill = year))+
  geom_bar(stat = "identity", fill = "#233267") +
  geom_text(aes(label = scales::comma(n)),
            vjust = -.5, 
            size = 3,
            labels = comma) +
  theme_classic()+
  theme(axis.text = element_text(size = 9),
        legend.background = element_rect(fill = "white"),
        legend.position = "top",
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        legend.key=element_blank())+
  scale_y_continuous(labels = comma)+
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = 2013: 2022) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks"))

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.1.tiff", width = 7, height = 4)


```


```{r}

full_sqf %>%
  filter(!is.na(boro)) %>%
  group_by(year, boro) %>%
  summarise(n = n()) %>%
 ggplot(aes(x= year, y = n, fill = year))+
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap2(vars(boro), axes = "x") +
    geom_text(data = . %>% filter(year %in% c(2013,2022)),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') +
  expand_limits(y = 80000)

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.2.tiff", width = 7, height = 4)


```


```{r}

full_sqf %>% 
  filter(!is.na(boro)) %>% 
  group_by(year, boro) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(boro = fct_relevel(boro, "Staten Island", "Queens", "Manhattan", "Brooklyn", "Bronx")) %>% 
  ggplot(aes(x = year, y = percent, fill = boro)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
   theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#4953a4","#e3800e","#2CAAE2","#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(aes(label = sprintf("%.1f%%", percent)), position = position_fill(vjust = 0.5), size = 3.5, color = "white", fontface = "bold")


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.3.tiff", width = 7, height = 4)

```





```{r}

# note that this part of the analysis we exclude a small number of juveniles younger than 10 

sqf_yearly_race <- full_sqf %>% 
  filter(race != "Other",
         age > 9) %>% 
  count(year, race)

```




**Total pedestrian stops, %**

```{r}


full_sqf %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(year, percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
 geom_text(aes(label = ifelse(percent > 3, sprintf("%.1f%%", percent), "")), size = 3.5, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  geom_text(aes(label = ifelse(percent < 3, sprintf("%.1f%%", percent), "")), size = 2.6, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  theme_classic() +
  theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_x_continuous(breaks = 2013: 2022)  +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks"))




```



**Pedestrian stop rate per 100,000 people**

```{r}

left_join(sqf_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>% 
  select(year, race, rate) %>%
  ggplot(aes(year, rate)) +
    geom_bar(stat = "identity", fill = "#233267") +
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#e3800e")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
   facet_wrap2(vars(race), axes = "x", nrow = 2)+ 
   geom_text(aes(label = scales::comma(rate)),
            vjust = -.5, 
            size = 3) +
  expand_limits(y = 6600)


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.5.tiff", width = 7, height = 4)


```



```{r}


left_join(sqf_yearly_race, PD_census_race,  by = c("race" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race, rate) %>% 
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  ggplot(aes(year, value, color = race, label = sprintf("%.1f", value))) +
  geom_line(size = .5, key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2019, 2022))) +
  theme_classic() +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5), 
        legend.key=element_blank()) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = 2013:2022) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  geom_text_repel(data = . %>% filter(year %in% c(2013, 2019, 2022)),
                  aes(label = sprintf("%.1f", value), color = race),
                  size = 3, color = 'black',
                  min.segment.length = unit(0, 'lines'),
                  point.padding = .1,
                  box.padding = .5, direction = "y") +
  expand_limits(y = 13)

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.6.tiff", width = 7, height = 4)

```



**Total pedestrian stops, %**  
*By borough*

```{r}

full_sqf %>% 
  filter(!is.na(boro)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, boro, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_reorder(race, percent))  %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(boro), axes = "x", nrow = 3) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 2.3, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")
) 


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.7.tiff", width = 7, height = 4)

```



```{r}

PD_census_boro_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  mutate(boro = case_when(borough == "bronx" ~ "Bronx",
                          borough == "kings" ~ "Brooklyn",
                          borough == "manhattan" ~ "Manhattan",
                          borough == "queens" ~ "Queens",
                          borough == "si" ~ "Staten Island")) %>% 
  group_by(year, boro, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

sqf_yearly_boro_race <- full_sqf %>% 
  filter(race != "Other",
         !is.na(boro),
         age > 9) %>% 
  count(year, boro, race)

```


```{r}

sqf_boro <- left_join(sqf_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, boro, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, boro, race, value) %>%
  mutate(nudge_y = ifelse(race == "Black/white", 2.5, -2.5)) 

  ggplot(data = sqf_boro,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(boro), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = sqf_boro$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
  expand_limits(y = 30)


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.8.tiff", width = 7, height = 4)


```



```{r}

full_sqf %>% 
  mutate(sex_cat = case_when(sex == "FEMALE" ~ "Female",
                          sex == "F" ~ "Female",
                          sex == "MALE" ~ "Male",
                          sex == "M" ~ "Male",
                          TRUE ~ "Other")) %>% 
  filter(sex_cat != "Other") %>% 
  group_by(year, sex_cat) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  ggplot(aes(x = year, y = percent, fill = sex_cat)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
   theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#2CAAE2","#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(aes(label = sprintf("%.1f%%", percent)), position = position_fill(vjust = 0.5), size = 3.5, color = "white", fontface = "bold")

  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.9.tiff", width = 7, height = 4)
  

```


**Total stops, %**
*by sex*

```{r}

full_sqf %>%
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
    mutate(sex_cat = case_when(sex == "FEMALE" ~ "Female",
                          sex == "F" ~ "Female",
                          sex == "MALE" ~ "Male",
                          sex == "M" ~ "Male",
                          TRUE ~ "Other")) %>% 
  filter(sex_cat != "Other") %>% 
  group_by(year, sex_cat, race) %>%
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
 theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(sex_cat), axes = "x") +
   geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 3, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.10.tiff", width = 7, height = 4)

```







```{r}

PD_census_sex_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  group_by(year, sex, race) %>% 
  summarise(total_pop = sum(value))


```


```{r}

sqf_yearly_sex_race <- full_sqf %>% 
  mutate(sex = case_when(sex == "FEMALE" ~ "female",
                          sex == "F" ~ "female",
                          sex == "MALE" ~ "male",
                          sex == "M" ~ "male",
                          TRUE ~ "Other")) %>% 
  filter(race != "Other",
         sex != "Other",
         age > 9) %>% 
  count(year, sex, race)

```



```{r}

sqf_sex <- left_join(sqf_yearly_sex_race, PD_census_sex_race,  by = c("year" = "year", "sex" = "sex", "race" = "race")) %>% 
        mutate(sex = case_when(sex == "female" ~ "Women",
                         sex == "male" ~ "Men"))  %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, sex, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, sex, race, value) %>%
  mutate(nudge_y = ifelse(race == "Black/white", .5, -.5)) 

  ggplot(data = sqf_sex,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(sex), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = sqf_sex$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
    expand_limits(y = 15)

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.11.tiff", width = 7, height = 4)

```


```{r}

PD_census_age_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  mutate(age_cat = case_when(age_group >= 3 & age_group <= 5 ~ "<25",
                             age_group >= 6 & age_group <= 9 ~ "25-44",
                             age_group >= 10 ~ "45+")) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

sqf_yearly_age_race <- full_sqf %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 & age <= 98 ~ "45+")) %>% 
  filter(race != "Other",
         !is.na(age_cat)) %>% 
  count(year, age_cat, race)


```




```{r}

full_sqf %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 & age <= 98 ~ "45+")) %>% 
  filter(!is.na(age_cat)) %>% 
  mutate(age_cat = fct_relevel(age_cat, "45+", "25-44","<25")) %>% 
  group_by(year, age_cat) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  ggplot(aes(x = year, y = percent, fill = age_cat)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
   theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#e3800e","#2CAAE2","#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(aes(label = sprintf("%.1f%%", percent)), position = position_fill(vjust = 0.5), size = 3.5, color = "white", fontface = "bold")

  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.12.tiff", width = 7, height = 4)
  

```



```{r}


full_sqf %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 & age <= 98 ~ "45+")) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!is.na(age_cat)) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
 ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 2.8, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.13.tiff", width = 7, height = 4)

```

```{r}

sqf_age <- left_join(sqf_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, age_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, age_cat, race, value) %>%
  mutate(nudge_y = ifelse(race == "Black/white", .7, -.6)) 

  ggplot(data = sqf_age,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(age_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = sqf_age$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
    expand_limits(y = 20.1)

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.14.tiff", width = 7, height = 4)
  
  
```


## sqf suspected offense sorting



```{r}

violent <- c(
  'fe;/aslt',
  '1601',
  '12111',
  '16005',
  '12112 strangulation',
  'aasault',
  'abduction',
  'agg har',
  'agg har - misd',
  'agg harass',
  'agg harassment',
  'agg harr',
  'agg harrasment',
  'agg harrasmetn',
  'agg harrassment',
  'aggravated harassment',
  'aggravated harassment m',
  'aggravated harrassment',
  'asaault',
  'asault',
  'asault 3',
  'asault e',
  'aslt',
  'ass',
  'ass 3',
  'ass2',
  'ass3',
  'assaault',
  'assalt 3',
  'assaltl',
  'assalult',
  'assalut',
  'assasult',
  'assau;t',
  'assauklt',
  'assauklt 3',
  'assaukt',
  'assaul',
  'assaulat',
  'assauly',
  'assauslt female shot',
  'assaut',
  'assautl',
  'asslt',
  'asslt 2',
  'asssault',
  'asssault misd',
  'asssult 3',
  'assualt',
  'assualt 1',
  'assualt 2',
  'assualt 3',
  'assualt avenue',
  'assualt1',
  'assualt3',
  'assult',
  'assult 1/tos',
  'assult 3',
  'assult/misd',
  'att abduction',
  'attemoted robbert',
  'attempted kidnapping',
  'attempted rob',
  'child abductin/kidnapping',
  'child abduction',
  'child abduction (poss)',
  'com rob',
  'crim ob breathe / menacing',
  'fel  / rob',
  'fel / rob',
  'fel ass',
  'fel glfa',
  'fel menacing w/knife',
  'fel possible kidnapping',
  'fel ro',
  'fel/16015',
  'fel/aslt',
  'fel/assualt',
  'fel/att robb',
  'fel/kidnapping',
  'fel/rob',
  'fel/robb',
  'fel/robb (patt #90)',
  'fel/rpobbery',
  'felony- (menacing)',
  'felony/assult',
  'felony/reckless endangerment',
  'felony/robb',
  'felony/robbedry',
  'felony/robber',
  'felony/robberey',
  'felony/robberfy',
  'felony/robberty',
  'felony/robberu',
  'felony/robbry',
  'g/l jostling',
  'gang asault',
  'gang assualt',
  'gang/kidnapping',
  'harasment',
  'harassment',
  'harassment (misd)',
  'harassment (radio run)',
  'harassment/stalking',
  'harr',
  'harrasment',
  'harrasment 1',
  'harrasment 1st',
  'harrassment',
  'inciting riot',
  'jostling',
  'jostling/forcible touching',
  'kiddnapping',
  'kidnap',
  'kidnapping',
  'kidnapping misd',
  'kidnapping/ child abduction',
  'meanacing',
  'meancing',
  'menacing',
  'menacing (criminal mischief',
  'menacing misd',
  'menacing with a dog',
  'menacing/ misdemeanor',
  'menancing',
  'mencaing',
  'mienacing',
  'mis/agg harassment',
  'mis/assaulr',
  'mis/asssault',
  'mis/assualt',
  'mis/assult',
  'mis/menacing',
  'mis/reckless endanger',
  'mis/reckless endangerment',
  'mis/reckless endangermet',
  'mis/recklessvend',
  'misd - (menacing)',
  'misd - (stalking)',
  'misd  / reckless endagerment',
  'misd  / reckless endangerment',
  'misd (stalking)',
  'misd/agg harass',
  'misd/aslt',
  'misd/menacing',
  'misd/reckless',
  'misd/reckless endan',
  'misd/reckless endangerment',
  'misdemeanor crim obstruct bre',
  'mva fatal left scene',
  'obstruction of breathin',
  'phisical fight',
  'physical fight',
  'pl 12000 aslt',
  'pl 160',
  'pl 16015 sub 2',
  'poss asssault',
  'possible child abductio',
  'rbbery',
  'reck',
  'reck end',
  'reck endanger',
  'reckeless endangerment',
  'recklass endangerment',
  'reckless enagerment',
  'reckless endagerment',
  'reckless endanderment felon',
  'reckless endangement',
  'reckless endanger',
  'reckless endangermen',
  'reckless endangerment',
  'reckless endangerment /',
  'reckless endangerment / shots',
  'reckless endangerment misd',
  'reckless endargment',
  'reckless endeangerment',
  'reckless endengerment',
  'recklessendangerment',
  'recless endag',
  'recless endangerment',
  'redkess endangerment',
  'rel/robb',
  'resisting',
  'resisting arrest',
  'rib',
  'riobbery',
  'riot',
  'ro bbery',
  'rob',
  'rob - fel',
  'rob 3 16000',
  'rob pattern',
  'rob/cscs',
  'rob/gl',
  'rob/gun',
  'rob`',
  'robb',
  'robb (fel)',
  'robb/',
  'robbary',
  'robbbery',
  'robber',
  'robber y',
  'robber/gl',
  'robberey',
  'robberies',
  'robberry',
  'robbert',
  'robberty',
  'robberuy',
  'robbety',
  'robbey',
  'robbey (fel)',
  'robbrer',
  'robbrery',
  'robbrey',
  'robbrry',
  'robbry',
  'robbwey',
  'robbwry',
  'robby',
  'robebry',
  'robeery (fel)',
  'roberry',
  'roberry (felony)',
  'robery',
  'robery /w knife',
  'rob-fel',
  'ron',
  'ronnery',
  'roobery',
  'ropb',
  'ropbery',
  'stabbing',
  'stalking',
  'stalking (misd)',
  'stalking (misdemeanor)',
  'stalking/harassment',
  'stalking/sexual abuse',
  'stragulation',
  'strangulation',
  'strangulation-felony',
  'unlawful imprisoment (f)',
  'unlawful imprisonmen',
  'unlawful imprisonment',
  'unlawful imprisonment misd',
  'unlawful imprsonment',
  'unlawfull imprisonment',
  'unlunlawful imprison',
  'vehicular manslaughter',
  'violation oop/menacing w/ w',
  'wanted for menacing po')

```


```{r}

weapon <- c(
  'gravity knife',
  'gun',
  'gun possession',
  'gun run',
  '10-10 man w/a gun',
  '10-10 shots fired',
  '1034 (shooting)',
  '10-34 male shot',
  '34-52 w/knife',
  'c pw',
  'c[w',
  'cpe shots fired',
  'crim poss of wpn',
  'crim poss wpn',
  'crim possession of a w',
  'criminal posession of a weapo',
  'criminal poss wpn',
  'criminal possesion or a wea',
  'criminal possesion weap',
  'criminal possession of a fire',
  'criminal possession of a we',
  'criminal possession of a weap',
  'criminal possession of a weapo',
  'criminal possession of w',
  'criminal possession of weap',
  'criminal possession w',
  'criminal possession wea',
  'criminal possession weaon',
  'crimnal possession of weapo',
  'cw',
  'cwp',
  'cwp (fel)',
  'cwp/robb',
  'fekl',
  'fel   /c pw',
  'fel  /c pw',
  'fel (shots fired)',
  'fel shots fired',
  'fel/cpfi',
  'fel/radio run shots f',
  'felony (shots fired)',
  'felony gun possession',
  'felony gun run',
  'felony/shooting',
  'felony-investigate shots fired',
  'fire arm',
  'investigation in shooting /',
  'male with gun',
  'man w/gun',
  'menacing w/ knife',
  'menacing w/a knife',
  'menacing with gun',
  'menacing with knife',
  'misd/unlawfully dealing w/f',
  'poss fire arm',
  'possession of exposive device',
  'possession of knife',
  'possesssion of explosive devic',
  'pw',
  'shooting',
  'shots fired',
  'shots fired 10-10'
)

```

```{r}

property <- c(
  '1402',
  '1553',
  '1703',
  '14020',
  '14025',
  '15525',
  '15530',
  '16516',
  '16515 (3)',
  '16515(3) misd',
  'arson',
  'birg;aru',
  'bnurg',
  'brug',
  'bug',
  'bugrlary',
  'bur',
  'burb',
  'burblary',
  'burlargy',
  'burlary',
  'burlgary',
  'c/ mischief',
  'chain snatch',
  'check fraud',
  'ciminal mischief',
  'com',
  'counterfeit currency',
  'countifeit currency',
  'cp of stolen property',
  'cpfi',
  'cpfi / cpm',
  'cpfi/gl',
  'cpforged instrument',
  'cpsm',
  'cpsp',
  'cpsp  pl 16540',
  'cpsp (bike)',
  'cpsp(5)',
  'cpsp/bicycle',
  'cpsp/crim mis',
  'cpsp/pet l',
  'cpsp/pl',
  'cpsp`',
  'cpsp5',
  'criiminal mischief',
  'crim  mis',
  'crim  mischief',
  'crim imis',
  'crim mis',
  'crim mis  mis',
  'crim mis  misd',
  'crim mis (felony)',
  'crim mis (misd)',
  'crim mis /felony',
  'crim mis fel',
  'crim mis misd',
  'crim mis misdemeanor petit lar',
  'crim mis misdemenor',
  'crim misachief',
  'crim misc',
  'crim misch',
  'crim mischeif',
  'crim mischief',
  'crim mischief felony',
  'crim mischief/ petit',
  'crim misf',
  'crim misq',
  'crim mmis',
  'crim mtress',
  'crim pos  of stolen p',
  'crim pos stolen property',
  'crim poss forg inst',
  'crim poss forge instrument',
  'crim poss forged inst',
  'crim poss forged instru',
  'crim poss forged instrument',
  'crim poss of a forged i',
  'crim poss of forged inst',
  'crim poss of forged instrum',
  'crim poss of stolen pro',
  'crim poss of stolen prop',
  'crim poss of stolen propert',
  'crim poss of stolen property',
  'crim poss prop',
  'crim poss stolen pro',
  'crim poss stolen prop',
  'crim poss stolen proper',
  'crim poss stolen propert',
  'crim poss stolen property',
  'crim possesion of stolen pr',
  'crim tamp',
  'crim tamper',
  'crim tampering',
  'crim/mis',
  'crimial mischief',
  'crimianal mischief',
  'crimianl mischief',
  'criminal cischief',
  'criminal michief',
  'criminal micshief',
  'criminal miischief',
  'criminal mis',
  'criminal mis/ rec',
  'criminal mis/ reckles',
  'criminal misc',
  'criminal misch',
  'criminal mischeif',
  'criminal mischied (m',
  'criminal mischief',
  'criminal mischief (m',
  'criminal mischief (misd)',
  'criminal mischief / cpcs',
  'criminal mischief 3',
  'criminal mischief felony r',
  'criminal mischief gl',
  'criminal mischief mi',
  'criminal mischief mis',
  'criminal mischief pl',
  'criminal mischief to au',
  'criminal mischief/ass',
  'criminal mischief/petit',
  'criminal mischief/petit lar',
  'criminal mischieff',
  'criminal mischief-mis',
  'criminal mischieft',
  'criminal mischieg',
  'criminal mischif',
  'criminal mischifef',
  'criminal miscief',
  'criminal misf',
  'criminal mishchief',
  'criminal mishcief',
  'criminal msi',
  'criminal poss of forged',
  'criminal poss of forged inst',
  'criminal poss of stolen prop',
  'criminal poss of stolen prope',
  'criminal poss stolen p',
  'criminal poss stolen property',
  'criminal possesion of stole',
  'criminal possession  of stolen',
  'criminal possession forged in',
  'criminal possession of forged',
  'criminal possession of forged instrument',
  'criminal possession of stolen',
  'criminal possession sto',
  'criminal tamp',
  'criminal tampering',
  'criminalmischief',
  'criminial mischief',
  'crimmis',
  'crimmisc',
  'crimnal mis',
  'crimnal mischief',
  'crimnal tampering',
  'crimonal mischielf',
  'crimpossstolen prop',
  'crimtamp',
  'crininal mischief',
  'crm mis',
  'crminal mischief',
  'crom poss stolen property',
  'fel  glfa',
  'fel / forgery',
  'fel glfp',
  'fel plfa',
  'fel/arson',
  'fel/cpsp',
  'fel/crim mis',
  'fel/forgery',
  'fel/g/l',
  'fel/gl',
  'fel/glfa',
  'fel/glfp',
  'felgl',
  'felglfa',
  'felony - lushworker',
  'felony (glfa)',
  'felony (rims)',
  'felony -(rims)',
  'felony cpsp',
  'felony glfa',
  'felony grand from au',
  'felony/buyrg',
  'felony/byrg',
  'felony/cpsp',
  'felony/home invasion',
  'fgrand',
  'forge instrument',
  'forged document',
  'forged instrument',
  'forged instrumnet',
  'forged intrument',
  'forgeed instrument',
  'forgery',
  'forgery of vin',
  'forgery plate',
  'forgery/cpsp',
  'fraud',
  'fraudulent instruments',
  'g l',
  'g/',
  'g/l',
  'g/lg',
  'gal (fel)',
  'garnd',
  'gl',
  'gl (fel)',
  'gl / cpsp',
  'gl lushworker',
  'gl/ cpsp',
  'glla',
  'gls',
  'gpa',
  'gran',
  'gran l;arc',
  'grand',
  'grand alrceny',
  'grand l;arceny',
  'grand la rc',
  'grand laerc',
  'grand lafceny',
  'grand lanceny',
  'grand lar',
  'grand lardceny',
  'grand lareceny',
  'grand larecny',
  'grand lareny',
  'grand larfceny',
  'grand largency',
  'grand lrceny',
  'grand lsarceny',
  'grla',
  'gta',
  'high incident gl & p/c (cas',
  'high incident of g/l  & p/l',
  'high incident of gl & p/l(c',
  'id theft',
  'identity theft',
  'illegal vin possession',
  'jump turnstile - crim t',
  'largeny',
  'larrceny',
  'lushworker',
  'mim mischief',
  'mis tos',
  'mis/cpfi',
  'mis/cpsp',
  'mis/crim  mis',
  'mis/crim mis',
  'mis/plfa',
  'mis/tos',
  'misd  / crim mischief',
  'misd  / theft of service',
  'misd  / theft of sevice',
  'misd - selling swipe',
  'misd (glfa)',
  'misd (plfa)',
  'misd /  poss stolen prop',
  'misd / cpsp',
  'misd / crim mis',
  'misd / criminal misch',
  'misd / criminal mischief',
  'misd / theft of services',
  'misd / tos',
  'misd 16515(3)',
  'misd- 16516 swiping',
  'misd crim mis',
  'misd criminal mischief',
  'misd glfa',
  'misd p/l',
  'misd plfa',
  'misd -swiping 16516',
  'misd(scrap metal)',
  'misd/ theft of service',
  'misd/(scrap metal)',
  'misd/arson',
  'misd/cpsp',
  'misd/crim mis',
  'misd/pl',
  'misd/plfa',
  'misd/tos',
  'misd/unlaw sale fare me',
  'misdemeanor- 16516',
  'misdemeanor cpm',
  'misdemeanor/cpsp',
  'misdemeanor-16516 swiping',
  'misdemeanor-swiping 16516',
  'misd-selling swipes',
  'misd-swiping',
  'misd-swiping 16516',
  'p/l',
  'p/l   swipes',
  'p/l  160',
  'p/l  17025',
  'p/l  swipes',
  'p/l 12015',
  'p/l swipes',
  'p/lp',
  'petit',
  'petit  larfceny',
  'petit ;arceny',
  'petit laceny',
  'petit lafceny',
  'petit lar',
  'petit lardceny',
  'petit larecny',
  'petit larxc',
  'petot',
  'petpt',
  'petti',
  'pl',
  'pl 15525',
  'pl 16515',
  'pl 16515 (3)',
  'pl 16515(3)',
  'pl 16516',
  'pl 17020',
  'pl 47010',
  'pl17030',
  'plfa',
  'plfel',
  'poss forg inst 17025',
  'poss forged inst',
  'poss forged instrument',
  'poss of forged instrument',
  'poss of stolen property',
  'possession of a forge',
  'possession of forged ins',
  'possession of forged instru',
  'possession of forged instrumen',
  'possession of stolen',
  'possession of stolen party',
  'possession of stolen prop',
  'sale of transportation',
  'selling swipe',
  'selling swipes',
  'selling swipes 16516',
  'sellling swipe',
  'spsp',
  'stolen license plate',
  'stolen m/v plate reader',
  'stolen property',
  'suto dtripping',
  'swipe',
  'swiper',
  'swiping',
  'swiping 16515',
  'swiping fare media',
  'swipping',
  'theft  of  service',
  'theft of service',
  'theft of service (cab)',
  'theft of service (mis',
  'theft of services',
  'theft of services(pl 16',
  'theft ofservices',
  'theftt of service',
  'thefty of service',
  'tire/rims',
  'tires/rims',
  'tos',
  'tos / 16515',
  'tos/ criminal tresspass',
  'transit theft of services',
  'unauthorize sale of fare me',
  'unauthorized sale  of f',
  'unauthorized sale fare',
  'unauthorized sale of',
  'unauthorized sale of fa',
  'unauthorized sale of far',
  'unauthorized sale of fare c',
  'unauthorized saqle of fare',
  'usf  / 16516',
  'usfm/crim misc',
  'usfm/gl',
  'misd - 15525'
)

```


```{r}

drug <- c(
  '2203',
  '2211',
  '2214',
  '22003',
  '22006',
  '22010',
  '22016',
  '22039',
  '22105',
  '22110',
  '22135',
  '22140',
  '22039 / 22140',
  '22039 felony',
  '22039 pl',
  '221-10',
  '22110 cpm',
  '22110 misd',
  '22140 misd',
  'ccrim sale cont subs',
  'ciminal sale controlled sub',
  'cp/cs',
  'cpccs',
  'cpcp',
  'cpcs',
  'cpcs  misd',
  'cpcs & cpm',
  'cpcs / cpm',
  'cpcs / cscs',
  'cpcs /cscs',
  'cpcs 5',
  'cpcs 7',
  'cpcs 7 (misd)',
  'cpcs 7 degree',
  'cpcs 7th',
  'cpcs 7th (misd)',
  'cpcs cpm',
  'cpcs fel',
  'cpcs felony',
  'cpcs misd',
  'cpcs misd 22003',
  'cpcs row',
  'cpcs sale',
  'cpcs/cpm',
  'cpcs/cpm misd',
  'cpcs/cscs',
  'cpcs/ct',
  'cpcs/misd',
  'cpcs5',
  'cpcs7',
  'cpcs-7',
  'cpcs7 (misd)',
  'cpcscscs',
  'cpcss/cscs',
  'cpcs-sale',
  'cpcst',
  'cpm',
  'cpm  / csm',
  'cpm  misd',
  'cpm - misd',
  'cpm (misd)',
  'cpm (misdemeanor)',
  'cpm / cpcs',
  'cpm / crim mischief',
  'cpm / criminal mischief',
  'cpm / cscs',
  'cpm / csm',
  'cpm / endanger child',
  'cpm / robber',
  'cpm /cpcs',
  'cpm /misd',
  'cpm 22110',
  'cpm 3',
  'cpm 5',
  'cpm 5 degree',
  'cpm 5 misd',
  'cpm 5th',
  'cpm ct',
  'cpm mis',
  'cpm misd',
  'cpm sale',
  'cpm(plain view)',
  'cpm/ cpcs',
  'cpm/ ct',
  'cpm/ radio run',
  'cpm/c/t',
  'cpm/cpcs',
  'cpm/cpcs misd',
  'cpm/cpfi',
  'cpm/criminal tres',
  'cpm/cscs',
  'cpm/csm',
  'cpm/ct',
  'cpm/graffiti',
  'cpm/oga',
  'cpm/row',
  'cpm/sale',
  'cpm/tamp w/phys evidence',
  'cpm/upm',
  'cpm5',
  'cpm5 m',
  'cpm5/ct',
  'cpmc',
  'cpmcpfi',
  'cpmcpn',
  'cpm-mis',
  'cpm-sale',
  'cpm-tresspass(crim)',
  'cri sale cont sub',
  'crim cont sub',
  'crim poss cont sub',
  'crim poss cont subs1/money ln',
  'crim poss contr sub',
  'crim poss contr subtanc',
  'crim poss control sub',
  'crim poss controlled',
  'crim poss controlled su',
  'crim poss cpn',
  'crim poss marj',
  'crim poss of a controlld su',
  'crim poss of control substa',
  'crim poss of controlled',
  'crim poss of controlled subs',
  'crim poss of mari',
  'crim poss scontr sub',
  'crim possesion of contr',
  'crim sale',
  'crim sale con sub',
  'crim sale con subs',
  'crim sale cont sub',
  'crim sale cont sub/crim',
  'crim sale cont subst',
  'crim sale control sub',
  'crim sale control subst',
  'crim sale controll subs',
  'crim sale controlled',
  'crim sale controlled su',
  'crim sale controlled substa',
  'crim sale cpnt sub',
  'crim sale cs',
  'crim sale dont sub',
  'crim sale marj',
  'crim sale marjuana',
  'crim sale of control',
  'crim sale of controlled',
  'crim sale of controlled sub',
  'crim sale of cs',
  'criminal  possession ma',
  'criminal diversion',
  'criminal diversion sale',
  'criminal poss control subst',
  'criminal poss controlled su',
  'criminal poss of a contr su',
  'criminal poss of contro',
  'criminal possession con',
  'criminal possession control',
  'criminal possession mar',
  'criminal possession of mari',
  'criminal sale',
  'criminal sale  contro',
  'criminal sale  of ma',
  'criminal sale control',
  'criminal sale control s',
  'criminal sale control subst',
  'criminal sale controlle',
  'criminal sale controlled su',
  'criminal sale controlled subst',
  'criminal sale cs',
  'criminal sale of a con-substn',
  'criminal sale of c s',
  'criminal sale of cont',
  'criminal sale of contro',
  'criminal sale of control su',
  'criminal sale of control sub',
  'criminal sale of controlled',
  'criminal sale of controlled su',
  'criminal sale of mar',
  'criminal sale of mari',
  'criminal sell of crimin',
  'crimposs contrl sub fel',
  'crm sale of control s',
  'crp',
  'crpm',
  'crug sales',
  'csc',
  'cscs',
  'cscs  (felony)',
  'cscs  / csm',
  'cscs (felony)',
  'cscs / cpcs',
  'cscs 3',
  'cscs 7',
  'cscs csm',
  'cscs ct',
  'cscs fel',
  'cscs misd',
  'cscs sales',
  'cscs/cpc',
  'cscs/cpcs',
  'cscs/cpm',
  'cscs/ct',
  'cscs/graffiti',
  'cscs`',
  'cscscpcscpm',
  'csm',
  'csm / cpm',
  'csm/cpm',
  'csps',
  'cssp',
  'ct cpcs',
  'ct cpm',
  'ct/cpcs',
  'ct/cpcs7 (misd)',
  'ct/cpm',
  'ctcpcs',
  'ctcpcs 7',
  'ctcpcscscs',
  'ctcpm',
  'ctcscs',
  'cxcs',
  'dug sales',
  'fel  /  cpcs',
  'fel  / cpcs',
  'fel  / cpm5',
  'fel  / cscs',
  'fel/cpcs',
  'fel/cpm',
  'fel/cscs',
  'fel/csm',
  'fel0ny/csm',
  'felony 22039',
  'felony cscs',
  'felony cscs/cpcs',
  'felony/csm',
  'mids/cpm',
  'mis cpm',
  'mis/cpcs',
  'mis/cpm',
  'mis/cscs',
  'mis/csm',
  'miscpm',
  'misd     cpm',
  'misd   / cscs',
  'misd  / ccpm',
  'misd  / cpcs',
  'misd  / cpm',
  'misd  / cscs',
  'misd  // cscs',
  'misd -(cpsp)',
  'misd / 22110 crim pos m',
  'misd / cpcs',
  'misd / cpm',
  'misd / cpm (h2h)',
  'misd / cpm 5',
  'misd / cscs',
  'misd / csm',
  'misd // cscs',
  'misd /cpcs',
  'misd csm',
  'misd/ cpcs',
  'misd/ cpm 5',
  'misd/14015/cpm',
  'misd/cpcs',
  'misd/cpcs/cscs',
  'misd/cpm',
  'misd/cscs',
  'misd/csm',
  'misdemanor-cpm',
  'misdemeanor pl 22003 cpcs',
  'misdemeanor/511',
  'narc sales',
  'nis/cpcs',
  'pl 220',
  'pl 22003 crim poss contr s',
  'pl 22020(8)',
  'pl 22031',
  'pl 22039',
  'pl 22110',
  'pl 22135',
  'pl 22140',
  'pl 22o',
  'pl22020 (2)',
  'pl22031 crimsale of consub',
  'pl22031 cscs',
  'poss ct',
  'poss of controll substa',
  'poss of controlled subs',
  'reckless driving cpsp',
  'sale cpcs',
  'uuv/cpm')

```


```{r}

trespass <- c(
  'felony-(crimtres)',
  '1401',
  '14010',
  '14015',
  '14010 / 49010',
  'ciminal tresspass',
  'cri m tres',
  'cri m tress',
  'cri tres',
  'cri tress',
  'crim  tres',
  'crim  tress',
  'crim  tresss',
  'crim t ress',
  'crim tesspass',
  'crim tr es',
  'crim tre',
  'crim treapass',
  'crim treas',
  'crim treaspass',
  'crim trepass',
  'crim treps',
  'crim trew',
  'crim trews',
  'crim tris',
  'crim trs',
  'crim trses',
  'crim trss',
  'crim tyress',
  'crimal tresspass',
  'crime trepass',
  'crime tress',
  'crimi tress',
  'crimilal tress',
  'crimimnal tress',
  'crimina tres',
  'crimina tresspass / sxm',
  'criminal  tress pass',
  'criminal tespass',
  'criminal traspass',
  'criminal treapass',
  'criminal trepass',
  'criminal treprass',
  'criminal tres',
  'criminal tres misd',
  'criminal tres pass',
  'criminal tress',
  'criminal tress pass',
  'criminal tresspas',
  'criminal tresspass',
  'criminal tresspass cpcs',
  'criminal tresspass misd',
  'criminal tresspass/cp',
  'criminal tresspassing',
  'criminal tresspassing/',
  'criminal tresspasss',
  'criminal tressppass',
  'criminal trspass',
  'criminaltrepass',
  'criminaltresspass',
  'criminial tresspasas',
  'crimininal tresspass',
  'crimintal tresspass',
  'crimj tres',
  'crimnal tress',
  'crimnial tresspass',
  'crimtraps',
  'crimtres',
  'crim-tres',
  'crimtress',
  'crimtrss',
  'crinm tres',
  'crinminal trepass',
  'criom tres',
  'crm tres',
  'crm tress',
  'ct',
  'ct (misd)',
  'ct 14010',
  'ct misd',
  'ct pl 14010',
  'mis/crim tes',
  'misd  /criminal tresspa',
  'misd / criminal traspassing',
  'misd / criminal tres / cpm5',
  'misd / criminal tress',
  'misd / criminal tresspa',
  'misd / tresspassing',
  'misd ct',
  'misd/crim trea',
  'misd/trspass',
  'pl 14010',
  'pl 14010e',
  'pl 14015',
  'traspass',
  'trepass',
  'tres',
  'tres passing criminal',
  'tress',
  'tress pass',
  'tresspass',
  'tresspass criminal',
  'tresspass/cpm',
  'tresspass/graffiti',
  'tresspasscriminal',
  'tresspassing',
  'trspass',
  'trss'
)

```


```{r}

qol <- c(
  '270',
  '14560 making graffiti',
  'aggressive panhandlin',
  'counterfeit trademark',
  'counterfeit/piracy',
  'counterfiet merchandise',
  'crim mis graffiti',
  'crim mis pl 145o0',
  'crim mis/graffiti',
  'crim mis/poss of graffiti i',
  'crim misc/ graffiti',
  'criminal mis/makeing grafitti',
  'criminal mischief graffi',
  'criminal nuisance',
  'dis con',
  'dis con - fighting',
  'discon',
  'disorderly',
  'disorderly conduct',
  'felony/graffiti',
  'fireworks',
  'frad acosting',
  'fraud accosting',
  'fraudlent accosting',
  'fraudulant accosting',
  'fraudulent accostin',
  'fraudulent accosting',
  'fraudulent acosting',
  'gaffiti',
  'gambling',
  'gambling misd',
  'garfitti',
  'gmabling',
  'grafffiti',
  'graffit',
  'graffiti',
  'graffiti instrument',
  'graffiti making',
  'graffiti misd',
  'graffitii',
  'graffitit',
  'graffitt',
  'graffitti',
  'graffitti-felony',
  'graffti',
  'grafiti',
  'grafitti',
  'graggitti',
  'greafitti',
  'griffiti',
  'hnlawful sale of fare media',
  'loit for pros',
  'loitering',
  'loitering for prostitio',
  'loitering for prostitut',
  'make graffiti',
  'makeing graffiti',
  'makin graffitti',
  'making  graffiti',
  'making a false statement',
  'making fraffitti',
  'making graaffiti',
  'making graffit',
  'making graffiti',
  'making graffiti (mis',
  'making graffiti (misd)',
  'making graffiti misd',
  'making graffiti pl 145',
  'making graffitii',
  'making graffitti',
  'making grafifiti',
  'making grafitti',
  'making grafitti (misd',
  'making raffiti',
  'manking graffiti',
  'marking graffiti',
  'mis/frafitti',
  'mis/graffiti',
  'mis/graffitti',
  'mis/grafitti',
  'mis/making graffitti',
  'mis/trademark counterfe',
  'mis/unlawful assembly',
  'misd  / graffiti',
  'misd  / makin grafitti',
  'misd  / making graffiti',
  'misd / graffiti',
  'misd / making graffi',
  'misd / making graffiti',
  'misd / making grafitti',
  'misd / oga/discon',
  'misd 25045 unlawfull s',
  'misd graffiti',
  'misd/ dis con',
  'misd/graffit',
  'misd/graffiti',
  'misd/grafitti',
  'misd/making grafitti',
  'misd/ulw surveilance',
  'misd/unlaw surveilance',
  'misd/unlaw surveliance',
  'misd/unlawful survielance',
  'misd/unlw surveilance',
  'misd/usf media',
  'misd/usfc',
  'misd/usfm',
  'mmaking graffiti',
  'obscenity',
  'obstructing',
  'open container',
  'open container of alcoh',
  'other/unlawful surveillance',
  'pl 25045',
  'pl24020 (2)',
  'posession graffiti tool',
  'poss of graffiti instru',
  'possesion of fireworks',
  'possession of graffiti inst',
  'possession of graffiti instrum',
  'possgraffiti instruments',
  'prohibited sale of alco',
  'promote gambling',
  'promoting',
  'promoting gamblinb',
  'promoting gambling',
  'promotong gambling',
  'proposed gambling',
  'public intox / drinking',
  'sale of counterfeit dvd',
  'sale of fare media (mis',
  'sale of foreworks',
  'sale of untaxed cigarette',
  'sidewalk',
  'solicitation support',
  'trade mark counterfeit',
  'trade market counterf',
  'tradeamark counterfeit',
  'trademaek counterfit',
  'trademark countereiting',
  'trademark counterfei',
  'trademark counterfeit',
  'trademark counterfeitin',
  'trademark counterfeiting',
  'trademark counterffeit',
  'trademark counterfit',
  'trademark countergeiting',
  'tradmark counterfeiti',
  'unauthorized recording',
  'unauthorized recording/photos',
  'unauthorsale of fare m',
  'unlaeful sale of media',
  'unlawful assembley',
  'unlawful assembly',
  'unlawful assemly',
  'unlawful dealing with firework',
  'unlawful poss of fireworks',
  'unlawful possession of firewor',
  'unlawful sale  of fare medi',
  'unlawful sale of fare m',
  'unlawful sale of fare media',
  'unlawful solicitation',
  'unlawful survallance',
  'unlawful surveilance',
  'unlawful surveillanc',
  'unlawful surveillance',
  'unlawful surveillane',
  'unlawful surveillanve',
  'unlawful use fare media',
  'unlawfull surviellance',
  'unlawfully dealing with fir',
  'unlawfulof fare media',
  'unlic general vendor',
  'unlicensed general vending',
  'untaxed cigarette',
  'untaxed cigarettes',
  'unuahtorized sale of',
  'unuathorized sale of',
  'urinating in public',
  'usfc',
  'usfm',
  'usfm['
)


```

```{r}
other <- c(
  '490',
  '511',
  '1034',
  '4901',
  '31-Oct',
  '31-Oct',
  '49010',
  '(fel/misd',
  '(fel/misd)',
  '110 pattern 4l',
  '32 veh',
  '49025 fleony',
  'actual stop on w 154 st  f',
  'agg unlic oprt',
  'ah',
  'apw',
  'bail jumping',
  'c scs',
  'c/t',
  'c[',
  'casing',
  'castro',
  'cel',
  'cerim mis',
  'cfi',
  'child abuse',
  'child endangerment',
  'child neglection',
  'ci harassment',
  'cisd',
  'cla',
  'cmp',
  'coercion',
  'conspiracy',
  'contempt of court',
  'cow',
  'cp',
  'cpe',
  'cpncpm',
  'cppm',
  'cps',
  'cpsc',
  'cpsc7',
  'cpu',
  'crcs',
  'crim',
  'crim comptempt',
  'crim cont',
  'crim contemp',
  'crim contempt',
  'crim contempt court',
  'crim impersonation',
  'crim impersonation of a pol',
  'crim impersontation',
  'crim sex act felony',
  'crim-contempt',
  'crime contempt',
  'crimi',
  'crimial impersoantio',
  'criminal',
  'criminal conduct',
  'criminal contemopt',
  'criminal contempt',
  'criminal contempt / voop',
  'criminal impersination',
  'criminal impersonati',
  'criminal impersonatio',
  'criminal impersonation',
  'criminal impersonation of a p',
  'criminal inpersonati',
  'criminal justice',
  'criminal misd',
  'criminal obstruction of',
  'criminal personation',
  'criminal posession o',
  'criminal possesion o',
  'criminal possesion of a',
  'criminal possesion of g',
  'criminal possesion of s',
  'criminal possession',
  'criminal possession o',
  'criminal possession of',
  'criminal sexual act',
  'csca',
  'cscc',
  'cscp (felony)',
  'custodial interferance',
  'del',
  'delony',
  'destroy/ alter vin plat',
  'dfel',
  'disregarding crime scene',
  'domestic dispute',
  'dui',
  'dwi',
  'efl',
  'eflony',
  'el',
  'elony',
  'end welfare of a child',
  'endang welfare child',
  'endanger the welfare',
  'endanger the welfare of',
  'endanger the welfare of a c',
  'endanger the welfare of child',
  'endanger the welfare ofa ch',
  'endanger welfare',
  'endanger welfare chil',
  'endangering the welfare',
  'endangering the welfare child',
  'endangering welfare',
  'endangering welfare for',
  'endangering welfare of',
  'endangering welfare of a ch',
  'endangering welfare of a child',
  'endangerment of child',
  'escape',
  'escape 2',
  'escape prisoner',
  'escaped prisoner',
  'f',
  'false impersonation',
  'false impersontation',
  'false personation',
  'false report',
  'fe',
  'fe;',
  'fe;pmu',
  'fed',
  'fef',
  'fefl',
  'fek',
  'fekibt',
  'fel  / bench warrant',
  'fel  / fel',
  'fel  / vop',
  'fel ( criminal imperson',
  'fel / misd',
  'fel cp chemical/bio wea',
  'fel crim impersonation',
  'fel criminal impersonat',
  'fel/',
  'fel/ crim imperson of po',
  'fel/ misd',
  'fel/mis',
  'fel/misc',
  'fel/misd',
  'fel/misd)',
  'fel/terrorism',
  'fel;',
  'fel;ony',
  'fel0ny',
  'felc',
  'feld',
  'fele',
  'feleony',
  'feliny',
  'feliony',
  'felk',
  'fell',
  'fellny',
  'fellony',
  'fellury',
  'felm',
  'felnoy',
  'felny',
  'felo',
  'felo ny',
  'felo9ny',
  'felodny',
  'feloiny',
  'felolny',
  'feloly',
  'felomny',
  'felomy',
  'felon',
  'felon y',
  'felonay',
  'felone',
  'feloney',
  'felong',
  'felonhy',
  'felonly',
  'felonny',
  'felonp',
  'felont',
  'felonty',
  'felonu',
  'felonuy',
  'felony   psa #155',
  'felony   psa #156',
  'felony   psa #157',
  'felony - (dwi / lsa)',
  'felony - (rims)',
  'felony - gang',
  'felony  psa #0094',
  'felony  psa #0095',
  'felony -(gang)',
  'felony (impersonation o',
  'felony 49010',
  'felony dwi',
  'felony escape from pris',
  'felony stop',
  'felony suspect',
  'felony tampering with witne',
  'felony(32)',
  'felony-(contempt of court)',
  'felony-(criminal sex act)',
  'felony/crim contempt',
  'felony/dwi',
  'felony/fla',
  'felony/misd',
  'felony`',
  'felony1',
  'felony6',
  'felonyh',
  'felonyq',
  'felonyr',
  'felonyu',
  'felonyy',
  'feloony',
  'felopny',
  'feloy',
  'feloyn',
  'felpny',
  'felq',
  'felrobb',
  'fem',
  'fenoly',
  'feol',
  'feolny',
  'feolony',
  'feonly',
  'feony',
  'fep',
  'fewl',
  'ffel',
  'ffelony',
  'fflony',
  'fgelony',
  'fke',
  'fl',
  'fl;ony',
  'fl=el',
  'fla',
  'fld',
  'fle',
  'fle/glfa',
  'fled',
  'fleeing',
  'fleony',
  'flony',
  'flw',
  'for touch',
  'forc',
  'forc touch',
  'forcible touching',
  'forcible touching (mi',
  'forcible touching/sex a',
  'forcible touhing',
  'forcibly touching',
  'forcibvle touching',
  'foricble touching',
  'frel',
  'g;a',
  'g=fel',
  'ga',
  'gb089-g01a no sec lic (mi',
  'gel',
  'gelony',
  'hindering prostitution',
  'impersonating a po',
  'impersonating a police officer',
  'impersonating police of',
  'impersonation',
  'impersonation of officer',
  'impersonation of police',
  'impersonation ofan offi',
  'intimidating c/v',
  'investigating on a warrant',
  'isd',
  'jumping out of a window to',
  'leaving scene of accide',
  'leaving the scene of accident',
  'lewd conduct',
  'luring a child',
  'luring of a child',
  'm',
  'm/v',
  'matched wanted poster',
  'med',
  'mezz',
  'mfelony',
  'mi',
  'mi8sd',
  'miad',
  'mias',
  'mic',
  'mid',
  'midd',
  'midemeanor',
  'midemeaonr',
  'midf',
  'mids',
  'midsemeanor',
  'mied',
  'miid',
  'miisd',
  'mind',
  'mis',
  'mis sexual mis',
  'mis/animal cruelty',
  'mis/crim contempt',
  'mis/fel',
  'mis/felony',
  'mis/forcible touchin',
  'mis/forcible touching',
  'mis/official miscondu',
  'mis/public lewdness',
  'mis/pw',
  'mis/uuv',
  'misb',
  'misc',
  'misd   psa #0099',
  'misd   psa #158',
  'misd   psa #159',
  'misd - (animal cruel',
  'misd - (dwi)',
  'misd - dwi',
  'misd - leaving the s',
  'misd  psa #0096',
  'misd  psa #100',
  'misd  psa #101',
  'misd  psa 0097',
  'misd  vop criminal contempt',
  'misd ( unlawful evict',
  'misd -(animal cruelt',
  'misd -(violation order of p',
  'misd / vop',
  'misd /bail jumping',
  'misd `',
  'misd 3',
  'misd animal cruelty',
  'misd criminalties',
  'misd force touch',
  'misd- leaving the sc',
  'misd p',
  'misd-(unauthorized u',
  'misd/',
  'misd/ fel',
  'misd/com',
  'misd/crim cont',
  'misd/crim contempt',
  'misd/crim impersonation',
  'misd/fel',
  'misd/felony',
  'misd/forcible touchi',
  'misd/forcible touchin',
  'misd/forcible touching',
  'misd/foricble touchin',
  'misd/other',
  'misd/public lewdness',
  'misd/sexaul abuse',
  'misd/sexual abuse',
  'misd/vtl 511',
  'misd`',
  'misd1',
  'misdc',
  'misdd',
  'misde',
  'misde3meanor',
  'misdeameanor',
  'misdeamenaor',
  'misdeamenor',
  'misdeamer',
  'misdeamnor',
  'misdeamonor',
  'misdeamor',
  'misdeanor',
  'misdemaeanor',
  'misdemaenor',
  'misdemanor',
  'misdemeador',
  'misdemeamor',
  'misdemeandor',
  'misdemeaner',
  'misdemeano',
  'misdemeanoe',
  'misdemeanor- mta impersonation',
  'misdemeanorm',
  'misdemeanr',
  'misdemeaor',
  'misdememanor',
  'misdemenanor',
  'misdemenaor',
  'misdemenor',
  'misdeminor',
  'misdemneaor',
  'misdermeanor',
  'misdf',
  'misdh',
  'misdmeanor',
  'misdp',
  'misdq',
  'mise',
  'misedeamor',
  'misedemanor',
  'misedemeanor',
  'misemeanor',
  'misf',
  'misid',
  'mism',
  'misn',
  'miss',
  'missd',
  'missing',
  'mist',
  'misterminor',
  'mmisd',
  'molestation',
  'mos',
  'msd',
  'msd  psa #0098',
  'msdemeanor',
  'msi',
  'msid',
  'mvm fraud',
  'n/a',
  'NA',
  'nis',
  'nisd',
  'nurg',
  'oga',
  'old post',
  'oop violation',
  'open arest warrant',
  'open warrant',
  'order of protection',
  'osd',
  'othe felony',
  'other (identity theft)',
  'other /identity theft',
  'other felony',
  'other/criminal impersonatio',
  'other/identity theft',
  'parking lot',
  'pat prostitute',
  'patronize prostitution',
  'patronizing a prostit',
  'patronizing a prostitut',
  'patronizing a prostitute',
  'patronizing pros',
  'patronizing prostitu',
  'patronizing prostitut',
  'patronizing prostitute',
  'patronizing prostitution',
  'pcw',
  'penal law felony',
  'pl 21515 felony criminal con',
  'pl 245 endangering welfare',
  'pl 25517',
  'pl 49010',
  'pl 49037',
  'pl fel',
  'pl mis',
  'pl misd',
  'pl15525',
  'pl49010 soliciting',
  'po impersonation',
  'police imperson',
  'police impersonation',
  'possible warrant',
  'prd',
  'prd counter terroris',
  'promoting prostitutio',
  'pros',
  'prostition',
  'prostituion',
  'prostituting',
  'prostitution',
  'prostitution misd',
  'prostitutuion',
  'prostitutution',
  'pub lewd',
  'pubilc lewdness',
  'public lewd',
  'public lewd/sexual misconduct',
  'public lewdenss',
  'public lewdness',
  'public lewdness misd',
  'public lewdnwss',
  'public loudness',
  'publiclewdness',
  'queens transit pattern',
  'radiation detection',
  'raised rap level on prd',
  'reckless',
  'reckless driving',
  'rel',
  'residential',
  'rfelony',
  'row',
  'ses abuse',
  'sex abuse',
  'sex abuse/forcible t',
  'sex abuse/forcible touching',
  'sex/forcible touching',
  'sexual abuse',
  'sexual misconduct',
  'sexualt abuse',
  'solicitating pros',
  'soliciting a prostitute',
  'soliciting prostitution',
  'street',
  'suspected oga',
  'suspected terrorism',
  'suspended license',
  'tampering with evidence',
  'tampering with mvm',
  'tampering with nypd bar',
  'terroism',
  'terrorisim',
  'terrorism',
  'terrorism 49020',
  'terrorism fel',
  'terrorism/casing',
  'terrorism/cpcs',
  'terrorist activity',
  'terrorist threats',
  'terrrorism',
  'tmc',
  'ugv',
  'unat use',
  'unattended suitcases',
  'unauthorized use',
  'unauthorized use of',
  'unauthorized use of a',
  'unauthorized use of a v',
  'unauthorized use of a vehic',
  'unauthorized use of veh',
  'unk',
  'unk/10-85',
  'unlawful eviction',
  'unlawful fleeing pol',
  'unlawful wear bulletproof vest',
  'upm',
  'use of a child in sex perfor',
  'uumv',
  'uuv',
  'v',
  'vel',
  'viol',
  'viol order of protection',
  'violation',
  'violation of order of protect',
  'violation of order pf prot',
  'violation order of protecti',
  'violation order of protection',
  'violaton',
  'void dup',
  'voop',
  'voop-felony (',
  'vop',
  'vtl',
  'vtl 511',
  'vtl violation',
  'wanted on arrest warrant',
  'wanted suspect',
  'warrant',
  'white',
  'witness',
  'crim res',
  'frl',
  'frlony',
  'fwelony',
  'fwl',
  'fwlony'
)


```


```{r}

full_sqf <- full_sqf %>% 
  mutate(crimsusp = str_to_lower(crimsusp)) %>% 
  mutate(crimsusp = str_remove_all(crimsusp, "[.]|[,]|[']")) %>% 
  mutate(charge_cat = case_when(
    str_detect(crimsusp, "homicide") ~ "Violent",
    str_detect(crimsusp, "homocide") ~ "Violent",
    str_detect(crimsusp, "murder") ~ "Violent",
    str_detect(crimsusp, "rape") ~ "Violent",
    str_detect(crimsusp, "robbery") ~ "Violent",
    str_detect(crimsusp, "assault") ~ "Violent",
    crimsusp %in% violent ~ "Violent",
    str_detect(crimsusp, "cpw") ~ "Weapon",
    str_detect(crimsusp, "firearm") ~ "Weapon",
    str_detect(crimsusp, "265") ~ "Weapon",
    str_detect(crimsusp, "weapon") ~ "Weapon",
    crimsusp %in% weapon ~ "Weapon",
    str_detect(crimsusp, "burg") ~ "Property",
    str_detect(crimsusp, "larc") ~ "Property",
    str_detect(crimsusp, "gla") ~ "Property",
    str_detect(crimsusp, "auto") ~ "Property",
    str_detect(crimsusp, "car") ~ "Property",
    str_detect(crimsusp, "vehicle") ~ "Property",
    crimsusp %in% property ~ "Property",
    str_detect(crimsusp, "drug") ~ "Drug",
    str_detect(crimsusp, "marij") ~ "Drug",
    str_detect(crimsusp, "marih") ~ "Drug",
    str_detect(crimsusp, "narco") ~ "Drug",
    str_detect(crimsusp, "substance") ~ "Drug",
    crimsusp %in% drug ~ "Drug",
    str_detect(crimsusp, "trespass") ~ "Trespass/Public Order",
    str_detect(crimsusp, "crim tres") ~ "Trespass/Public Order",
    str_detect(crimsusp, "tresp") ~ "Trespass/Public Order",
    crimsusp %in% trespass ~ "Trespass/Public Order",
    crimsusp %in% qol ~ "Trespass/Public Order",
    crimsusp %in% c("misd", "fel", "felony", "misdemeanor", "other") ~ "Other",
    crimsusp %in% other ~ "Other",
    crimsusp %in% c("10-31", "31-oct", NA) ~ "Other"
  )) 

```






## back to sqf analysis

```{r}

full_sqf %>% 
  mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Trespass/Public Order", "Weapon", "Property", "Drug", "Other")) %>%
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!charge_cat == "Other") %>% 
  group_by(year, charge_cat) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = charge_cat)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
   theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#4953a4","#e3800e","#2CAAE2","#233267", "#B3B3B3"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(aes(label = sprintf("%.1f%%", percent)), position = position_fill(vjust = 0.5), size = 3.5, color = "white", fontface = "bold")



```

```{r}

full_sqf %>%
  filter(!charge_cat == "Other") %>%
  group_by(year, charge_cat) %>%
  summarise(n = n()) %>%
 ggplot(aes(x= year, y = n, fill = year))+
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap(~charge_cat) +
  expand_limits(y = 30000)+
   geom_text(data = . %>% filter(year %in% c(2013,2022)),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') 

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.15.tiff", width = 7, height = 4)

```


```{r}

full_sqf %>% 
  filter(!charge_cat == "Other") %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
    mutate(race = fct_reorder(race, percent))  %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 2.3, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")
) 

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.16.tiff", width = 7, height = 4)

```

```{r}

sqf_yearly_charge_race <- full_sqf %>% 
  filter(race != "Other",
         age > 9) %>% 
  count(year, charge_cat, race)

```


```{r}

sqf_charge <- left_join(sqf_yearly_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(charge_cat != "Other") %>%
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = nhblack/nhwhite,
         `Hispanic/white` = hispanic/nhwhite) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>%
  mutate(nudge_y = ifelse(race == "Black/white", 2.5, -2.4)) 

  ggplot(data = sqf_charge,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
      geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = sqf_charge$nudge_y),
            color = 'black',
            check_overlap = TRUE)


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_2.17.tiff", width = 7, height = 4)


```



## DAT data prep


```{r}

archive <- read.delim("filccdem.csv", header=TRUE,sep = ",", dec = ",") 
   
archive %>% 
  count(GINUMBER) %>% 
  filter(n > 1)



old_dat <- 
archive %>% 
  clean_names() %>%
  transmute(ginumber,
            date = ymd(m2arrd),
            year = year(date),
            dob = ymd(dob), 
            age = interval(dob, date),
            sex,
            race,
            ethnicity,
            county = countyn,
            severity = m1chsev,
            law = m1chlaw,
            charge = m1chcomb,
            hearing_type = arrgnt
            ) %>% 
  distinct(ginumber, .keep_all = TRUE) %>% 
  filter(year >= 2013,
         year <= 2016)
  
  
```


```{r}


ccfiling_2017 <- read.delim("cc_2017.txt", header=TRUE,sep = ",", dec = ",")
ccfiling_2018 <- read.delim("cc_2018.txt", header=TRUE,sep = ",", dec = ",")
ccfiling_2019 <- read.delim("cc_2019.txt", header=TRUE,sep = ",", dec = ",")
ccfiling_2020 <- read.delim("cc_2020.txt", header=TRUE,sep = ",", dec = ",")
ccfiling_2021 <- read.delim("cc_2021.txt", header=TRUE,sep = ",", dec = ",")
ccfiling_2022 <- read.delim("cc_2022.txt", header=TRUE,sep = ",", dec = ",")




recent_dat <- bind_rows(ccfiling_2017, ccfiling_2018, ccfiling_2019, ccfiling_2020, ccfiling_2021)



recent_dat <- 
recent_dat %>% 
  select(-SM2ARRD)

ccfiling_2022 <- 
ccfiling_2022 %>% 
  select(-SM2ARRD)

recent_dat <- bind_rows(recent_dat, ccfiling_2022)


rm(ccfiling_2022)

recent_dat <- 
recent_dat %>% 
  clean_names() %>%
  transmute(ginumber,
            date = ymd(m2arrd),
            year = year(date),
            dob = ym(dob), 
            age = interval(dob, date),
            sex,
            race,
            ethnicity,
            county = countyn,
            severity = m1chsev,
            law = m1chlaw,
            charge = m1chcomb,
            hearing_type = arrgnt
            ) %>% 
  distinct(ginumber, .keep_all = TRUE) %>% 
  filter(year >= 2017,
         year <= 2022)

full_dat <- bind_rows(old_dat, recent_dat)

rm(old_dat, recent_dat)

```


```{r}



full_dat <-  full_dat %>% 
    mutate(age = interval(dob, date) %>% as.numeric('years') %>% round(0)) %>% 
    mutate(race = case_when(race == "B" ~ "Black",
                          race == "W" ~ "White",
                          race == "A" ~ "Asian",
                          race == "I" ~ "Indian",
                          race == "O" ~ "Other",
                          race == "U" ~ "Unknown",
                          TRUE ~ as.character(NA))) %>% 
    mutate(hispanic = if_else(ethnicity == "H", "TRUE", "FALSE")) %>% 
    mutate(sex = case_when(sex == "F" ~ "Female",
                         sex == "M" ~ "Male",
                         TRUE ~ as.character(NA))) %>% 
  mutate(dat = if_else(hearing_type == 1, "TRUE", "FALSE")) %>% 
    mutate(severity_cat = case_when(str_detect(severity, "F") ~ "Felony",
                           str_detect(severity, "M") ~ "Misdemeanor",
                           severity %in% c("I", "V") ~ "Violation/infraction")) %>% 
    mutate(hearing_type = case_when(hearing_type == 0 ~ as.character(NA),
                            hearing_type == 1 ~ "DAT", 
                            hearing_type == 2 ~ "Family Court",
                            hearing_type == 4 ~ "Hospital Arraignment",
                            hearing_type == 10 ~ "Pre-arraignment Deposition",
                            hearing_type == 11 ~ "Regular",
                            hearing_type == 12 ~ "Transferred from Summons Part",
                            hearing_type == 14 ~ "Criminal Summons",
                            hearing_type == 18 ~ "Violation of Probation Transfer from Another County",
                            hearing_type %in% c(19:26) ~ "Domestic Violence Case")) %>% 
  unite("law_charge", c("law","charge"), sep = " ", remove = FALSE) %>% 
  select(-ginumber, -ethnicity, -dob) 


  

```

```{r}

full_dat <- full_dat %>% 
  mutate(year = year(date)) %>% 
  mutate(race = case_when((race == "Black" & hispanic == "FALSE") ~ "nhblack",
                          (race == "White" & hispanic == "FALSE") ~ "nhwhite",
                          hispanic == "TRUE" ~ "hispanic",
                          TRUE ~ "Other"))

```


```{r}

CPL section 150.20

(a) Whenever a police officer is authorized pursuant to section
140.10 of this title to arrest a person without a warrant for an offense
other than a class A, B, C or D felony or a violation of section 130.25,
130.40, 205.10, 205.17, 205.19 or 215.56 of the penal law


```

## DAT figures

```{r}

full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
    mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, race) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n)) %>% 
  mutate(race = fct_reorder(race, n)) %>%
  ggplot(aes(x = year, y = n, fill = race)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic()+
  theme(legend.background = element_rect(fill = "white"),
        legend.position = "top",
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        legend.key=element_blank())+
  scale_y_continuous(labels = comma)+
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = 2013: 2022) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  geom_text(aes(y = sum, label = comma(sum)), vjust = -.85, size = 2.8,  format = comma, check_overlap = TRUE,  fontface = "bold") +
  expand_limits(y = 205000) +
geom_text(aes(x = year, y = n, label = ifelse(race %in% c("Black", "Hispanic", "White"), comma(n), "")), size = 3, position = position_stack(vjust = 0.5), color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("dat_figure_3.1.tiff", width = 7, height = 4)

```


```{r}

city_DAT_rate <- full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
  group_by(year, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  mutate(county = "Citywide", .after = year) %>% 
  ungroup()

boro_DAT_rate <- full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
   mutate(county = case_when(county == "BRONX" ~ "Bronx",
                            county == "KINGS" ~ "Brooklyn",
                            county == "NEW YORK" ~ "Manhattan",
                            county == "QUEENS" ~ "Queens",
                            county == "RICHMOND" ~ "Staten Island")) %>% 
  group_by(year, county, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ungroup()
  
dat_rate_overall <- rbind(city_DAT_rate, boro_DAT_rate)

dat_rate_overall %>% 
  mutate(county = fct_relevel(county, "Citywide", "Bronx", "Brooklyn", "Manhattan","Queens","Staten Island")) %>% 
  select(year, county, percent_dat) %>% 
ggplot(aes(year, percent_dat)) +
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic()+
 theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = percent_format(), breaks = seq(0,.6,.1)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap2(~county, axes = "x", nrow = 3) +
  geom_text(aes(label = paste0(round(percent_dat * 100), "%")), size = 2.7, vjust = 1.5, color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("dat_figure_3.2.tiff", width = 7, height = 4)

```




```{r}

full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
    mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!race == "Other") %>% 
  group_by(year, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat)) +
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic()+
 theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = percent_format(), breaks = seq(0,.6,.1)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap2(~race, axes = "x", nrow = 2) +
  geom_text(aes(label = paste0(round(percent_dat * 100), "%")), size = 2.7, vjust = 1.5, color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("dat_figure_3.3.tiff", width = 7, height = 4)


```



```{r}



dat_change_all <- full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "Black", "Hispanic", "White")) %>% 
  filter(!race == "Other") %>% 
  group_by(year, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  select(year, percent_dat) %>% 
  pivot_wider(names_from = race, values_from = percent_dat) %>% 
    mutate(`Black-White Gap` = (White - Black),
         `Hispanic-White Gap` = (White - Hispanic)) %>% 
   select(1,5:6) %>% 
  pivot_longer(cols = c("Black-White Gap", "Hispanic-White Gap"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,3),
         `'22 vs '19` = round(x2022-x2019,3)) %>% 
  select(1, 5:6) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period")


ggplot(dat_change_all,
         aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black-White Gap", "Hispanic-White Gap"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
 geom_text(aes(label = ifelse(value >= 0, paste("+", scales::percent(value)), scales::percent(value)),
                group = race),
            vjust = ifelse(dat_change_all$value > 0, -1, 1.8),
                            position = position_dodge(width = .9),
                             size = 3) +
  scale_x_continuous(labels = NULL, expand = c(-.1,.01))

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("dat_change_all.tiff", width = 7, height = 4)

```

```{r}

# gender disparity figure

full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
  mutate(sex = case_when(sex == "Female" ~ "Women",
                         sex == "Male" ~ "Men")) %>%
  filter(!is.na(sex)) %>% 
  group_by(year, sex, dat) %>% 
   summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat))


```




```{r}


full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White",
                          TRUE ~ "Other")) %>% 
  filter(race != "Other") %>% 
  mutate(sex = case_when(sex == "Female" ~ "Women",
                         sex == "Male" ~ "Men")) %>%
  filter(!is.na(sex)) %>% 
  group_by(year, sex, race, dat) %>% 
   summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat, color = race)) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent) +
  scale_x_continuous(breaks = 2013: 2022) +
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#e3800e")) +
  expand_limits(y = .41)+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(sex), axes = "x") +
  expand_limits(y = .5)


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("dat_figure_3.5.tiff", width = 7, height = 4)


```

```{r}

# figures for age differences

full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >= 25 & age <= 44 ~ "25-44",
                             age > 44 ~ "45+")) %>% 
  filter(!is.na(age_cat)) %>%
  filter(!race == "Other") %>% 
  group_by(year, age_cat, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) 



```




```{r}


full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >= 25 & age <= 44 ~ "25-44",
                             age > 44 ~ "45+")) %>% 
  filter(!is.na(age_cat)) %>%
  filter(!race == "Other") %>% 
  group_by(year, age_cat, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat, color = race)) +
  geom_point(data = . %>% filter(year %in% c(2013,  2022))) +  
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent, breaks = seq(0,.6,.1)) +
  scale_x_continuous(breaks = 2013: 2022) +
  theme_classic() +
  theme(legend.position = "top", plot.background = element_rect(fill = "white"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major.y = element_line(linetype = "solid", size = .5), legend.key=element_blank()) +
  xlab("") +
  expand_limits(y = c(0,.60)) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#e3800e")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) 
  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("dat_figure_3.6.tiff", width = 7, height = 4)

```

```{r}

## charge_cat figures

full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
 mutate(charge_cat = case_when(str_detect(charge, "221.10") ~ "Marijuana (5th)",
                                       str_detect(charge, "155.25") ~ "Petit larceny",
                                       str_detect(charge, "220.03") ~ "Poss. of controlled substance (7th)",
                                       str_detect(charge, "120.00") ~ "Assault (3rd)",
                                       str_detect(charge, "165.15") ~ "Theft of services",
                                       str_detect(charge, "511") & !str_detect(charge, "02511|05110|0511D") ~ "Aggravated unlicensed driving",
                                        str_detect(charge, "145.00") ~ "Criminal mischief",
                                       str_detect(charge, "140.10") ~ "Criminal trespass",
                                       str_detect(charge, "265.01") ~ "Weapon possession (4th)")) %>% 
 filter(!is.na(charge_cat)) %>% 
  group_by(year, charge_cat, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n))



```



```{r}



full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>% 
  filter(!hearing_type == "Domestic Violence Case") %>% 
 mutate(charge_cat = case_when(str_detect(charge, "221.10") ~ "Marijuana (5th)",
                                       str_detect(charge, "155.25") ~ "Petit larceny",
                                       str_detect(charge, "220.03") ~ "Poss. of controlled substance (7th)",
                                       str_detect(charge, "120.00") ~ "Assault (3rd)",
                                       str_detect(charge, "165.15") ~ "Theft of services",
                                       str_detect(charge, "511") & !str_detect(charge, "02511|05110|0511D") ~ "Aggravated unlicensed driving",
                                        str_detect(charge, "145.00") ~ "Criminal mischief",
                                       str_detect(charge, "140.10") ~ "Criminal trespass",
                                       str_detect(charge, "265.01") ~ "Weapon possession (4th)")) %>% 
 filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "Black", "Hispanic", "White")) %>% 
  filter(!race == "Other") %>% 
  group_by(year, charge_cat, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  ggplot(aes(year, percent_dat, color = race)) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  geom_point(data = . %>% filter(year %in% c(2013, 2021), charge_cat == "Marijuana (5th)")) +
  geom_line(key_glyph = draw_key_point) +
  scale_y_continuous(labels = percent, breaks = seq(0,.8,.2)) +
  scale_x_continuous(breaks = 2013: 2022) +
  theme_classic() +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5), 
        legend.key=element_blank(),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  xlab("") +
  expand_limits(y = c(0,.87)) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2","#e3800e")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) 


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("dat_figure3.7.tiff", width = 7, height = 6)


```


```{r}

# charge cat descriptive

full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>%
  filter(!hearing_type == "Domestic Violence Case") %>% 
 mutate(charge_cat = case_when(str_detect(charge, "155.25") ~ "Petit larceny",
                                       str_detect(charge, "220.03") ~ "Poss. of controlled subs. (7th)",
                                       str_detect(charge, "120.00") ~ "Assault (3rd)",
                                       str_detect(charge, "165.15") ~ "Theft of services",
                                       str_detect(charge, "511") & !str_detect(charge, "02511|05110|0511D") ~ "Aggravated unlicensed driving",
                                        str_detect(charge, "145.00") ~ "Criminal mischief",
                                       str_detect(charge, "140.10") ~ "Criminal trespass",
                                       str_detect(charge, "265.01") ~ "Weapon possession (4th)")) %>% 
 filter(!is.na(charge_cat)) %>% 
  group_by(year, charge_cat, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  filter(year %in% c("2013", "2022")) %>% 
  select(year, charge_cat, percent_dat) %>% 
  pivot_wider(names_from = year, values_from = percent_dat) %>% 
  mutate(difference = round(`2022` - `2013`,2))
  



```



```{r}

dat_charge <- full_dat %>% 
  filter(severity %in% c("I","V","AM", "BM", "EF","M","UM")) %>% 
  filter(!charge %in% c("130.25", "130.40", "205.10", "205.17", "205.19", "215.56")) %>%
  filter(!hearing_type == "Domestic Violence Case") %>% 
 mutate(charge_cat = case_when(str_detect(charge, "155.25") ~ "Petit larceny",
                                       str_detect(charge, "220.03") ~ "Poss. of controlled subs. (7th)",
                                       str_detect(charge, "120.00") ~ "Assault (3rd)",
                                       str_detect(charge, "165.15") ~ "Theft of services",
                                       str_detect(charge, "511") & !str_detect(charge, "02511|05110|0511D") ~ "Aggravated unlicensed driving",
                                        str_detect(charge, "145.00") ~ "Criminal mischief",
                                       str_detect(charge, "140.10") ~ "Criminal trespass",
                                       str_detect(charge, "265.01") ~ "Weapon possession (4th)")) %>% 
 filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "Black", "Hispanic", "White")) %>% 
  filter(!race == "Other") %>% 
  group_by(year, charge_cat, race, dat) %>% 
  summarise(n = n()) %>% 
  mutate(percent_dat = n/sum(n)) %>% 
  filter(dat == "TRUE") %>% 
  mutate(percent_dat = as.numeric(percent_dat)) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  select(year, charge_cat, percent_dat) %>% 
  pivot_wider(names_from = race, values_from = percent_dat) %>% 
    mutate(`Black-White Gap` = (White - Black),
         `Hispanic-White Gap` = (White - Hispanic)) %>% 
   select(1:2,6:7) %>% 
  pivot_longer(cols = c("Black-White Gap", "Hispanic-White Gap"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,3),
         `'22 vs '19` = round(x2022-x2019,3)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period")


ggplot(dat_charge,
         aes(value, period)) +
  geom_errorbarh(aes(xmin = 0, xmax = value, color = race),
                 height = 0,
                 position = position_dodge(width = .9),
                 key_glyph = draw_key_point) +
  geom_point(aes(color = race),
             position = position_dodge(width = .9), 
             size = 3,
             key_glyph = draw_key_point) +
  geom_vline(lty = 2, 
             xintercept = 0) +
  theme_classic()+
  scale_color_manual(name = NULL, labels = c("Black-White Gap", "Hispanic-White Gap"), values = c("#233267","#2CAAE2")) +
  coord_flip() +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.background  = element_rect(fill = "white", color = NA), 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 6))+
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
 geom_text(aes(label = ifelse(value >= 0, paste("+", scales::percent(value, accuracy = 0.1)), scales::percent(value, accuracy = 0.1)),
                group = race),
            vjust = ifelse(dat_change_sev$value > 0, -1, 1.8),
                            position = position_dodge(width = .9),
                             size = 3) +
  scale_x_continuous(labels = NULL)+
  expand_limits(x = c(-.5,.35))+
  facet_wrap2(vars(charge_cat), axes = "all")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("dat_figure_3.8.tiff", width = 7, height = 4)


```



## Arrest prep



```{r}

pd <- read_csv("historic_arrest.csv")

pd_2022 <- read_csv("arrest_2022.csv")


```


```{r}

pd <- pd %>% 
  clean_names %>% 
  select(arrest_date:perp_race)

pd_2022 <- pd_2022 %>% 
  clean_names %>% 
  select(arrest_date: perp_race)

full_pd <- bind_rows(pd, pd_2022)

rm(pd, pd_2022)

full_pd <- full_pd %>% 
  mutate(race = case_when(perp_race == "WHITE" ~ "nhwhite",
                          perp_race == "BLACK" ~ "nhblack",
                          perp_race %in% c("BLACK HISPANIC", "WHITE HISPANIC") ~ "hispanic")) %>% 
  mutate(arrest_date = mdy(arrest_date)) %>%
  mutate(year = year(arrest_date)) %>% 
  filter(year >= 2013)



```




## Arrest figures

```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Felony","Misdemeanor or less")) %>% 
  filter(!is.na(severity)) %>% 
  group_by(year, severity) %>%   
 summarise(n = n()) %>%
  mutate(sum = sum(n)) %>% 
  ggplot(aes(x = year, y = n, fill = severity)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic()+
  theme(legend.background = element_rect(fill = "white"),
        legend.position = "top",
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        legend.key=element_blank())+
  scale_y_continuous(labels = comma)+
  scale_fill_manual(values = c("#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = 2013: 2022) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  geom_text(aes(y = sum, label = comma(sum)), vjust = -.85, size = 2.8,  format = comma, check_overlap = TRUE, fontface = "bold") +
  expand_limits(y = 410000) +
geom_text(aes(x = year, y = n, label =  comma(n)), size = 3, position = position_stack(vjust = 0.5), color = "white", fontface = "bold")


  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.1.tiff", width = 7, height = 4)


```


```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony",)) %>% 
    rename(boro = arrest_boro) %>% 
  mutate(boro = case_when(boro == "K" ~ "Brooklyn",
                          boro == "B" ~ "Bronx",
                          boro == "M" ~ "Manhattan",
                          boro == "Q" ~ "Queens",
                          boro == "S" ~ "Staten Island")) %>% 
  filter(!is.na(severity)) %>% 
  group_by(year, boro, severity) %>%   
 summarise(n = n()) %>% 
 ggplot(aes(year, n, color = boro, label = n)) +
  geom_line(key_glyph = draw_key_point, size = .75) +
geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma,
                     breaks = scales::pretty_breaks(n = 5)) +
  scale_colour_manual(values = c("#233267","#2CAAE2","#B3B3B3","#F9C31F","#e3800e")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(severity), axes = "x", scales = "free") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels =c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.2.tiff", width = 7, height = 4)

```




```{r}

full_pd %>% 
  rename(boro = arrest_boro) %>% 
  mutate(boro = case_when(boro == "K" ~ "Brooklyn",
                          boro == "B" ~ "Bronx",
                          boro == "M" ~ "Manhattan",
                          boro == "Q" ~ "Queens",
                          boro == "S" ~ "Staten Island")) %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
    mutate(boro = fct_relevel(boro, "Staten Island", "Queens", "Manhattan", "Brooklyn", "Bronx")) %>% 
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony",)) %>% 
    filter(!is.na(severity)) %>% 
   group_by(year, boro, severity) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = boro)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
   theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#4953a4","#e3800e","#2CAAE2","#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(aes(label = sprintf("%d%%", percent)), position = position_fill(vjust = 0.5), size = 2.5, color = "white", fontface = "bold")+
    facet_wrap2(vars(severity), axes = "x")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.3.tiff", width = 7, height = 4)


```



```{r}


full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, severity, race) %>%  
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(year, percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_y_continuous(labels = percent)  +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(severity), axes = "x") +
   geom_text(aes(label = sprintf("%d%%", percent)), position = position_fill(vjust = 0.5), size = 2.5, color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.4.tiff", width = 7, height = 4)

```


```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, severity, race) %>%  
  summarise(n = n()) %>% 
  filter(year %in% c("2013","2022"), severity == "Misdemeanor or less") %>% 
  pivot_wider(names_from = year, values_from = n) %>% 
  mutate(diff = (`2013` - `2022`),
         percent_change = (diff/`2013`))

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, severity, race) %>%  
  summarise(n = n()) %>% 
  filter(year %in% c("2013","2022"), severity == "Felony") %>% 
  pivot_wider(names_from = year, values_from = n) %>% 
  mutate(diff = (`2013` - `2022`),
         percent_change = (diff/`2013`))

```


```{r}


arrest_yearly_severity_race <- full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(race != "Other",
         !is.na(severity)) %>% 
  count(year, severity, race)

```


*By charge severity*

```{r}

left_join(arrest_yearly_severity_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, severity, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = Black/White,
         `Hispanic/white` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, severity, race, value) %>%
  ggplot(aes(year, value, color = race)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(size = 3) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), panel.background = element_rect(fill = "white"), axis.ticks.x = element_blank(), plot.title = element_text(size = 12), panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        axis.text = element_text(size = 8)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = c(0,9.25)) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,9,3)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
    guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(severity), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) 



arrest_sev <- left_join(arrest_yearly_severity_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, severity, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, severity, race, value) %>%
  mutate(nudge_y = ifelse(race == "Black/white", .4, -.4)) 

  ggplot(data = arrest_sev,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +  
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma,
                      breaks = scales::pretty_breaks(n = 5)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(severity), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = arrest_sev$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
    expand_limits(y = 10)


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.5.tiff", width = 7, height = 4)

```


```{r}


full_pd %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  rename(boro = arrest_boro) %>% 
  mutate(boro = case_when(boro == "K" ~ "Brooklyn",
                          boro == "B" ~ "Bronx",
                          boro == "M" ~ "Manhattan",
                          boro == "Q" ~ "Queens",
                          boro == "S" ~ "Staten Island")) %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
  group_by(year, boro, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 7)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(boro), axes = "x", nrow = 3) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 2.8, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.6.tiff", width = 7, height = 4)



```



```{r}

# for appendix A1

full_pd %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  rename(boro = arrest_boro) %>% 
  mutate(boro = case_when(boro == "K" ~ "Brooklyn",
                          boro == "B" ~ "Bronx",
                          boro == "M" ~ "Manhattan",
                          boro == "Q" ~ "Queens",
                          boro == "S" ~ "Staten Island")) %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  group_by(year, boro, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 7)) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(boro), axes = "x", nrow = 3) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 2.8, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_A1.tiff", width = 7, height = 4)


```


```{r}

arrest_yearly_boro_misd_race <-
  full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
  rename(boro = arrest_boro) %>% 
    mutate(boro = case_when(boro == "K" ~ "Brooklyn",
                          boro == "B" ~ "Bronx",
                          boro == "M" ~ "Manhattan",
                          boro == "Q" ~ "Queens",
                          boro == "S" ~ "Staten Island")) %>% 
  filter(!is.na(race),
         !is.na(boro)) %>% 
  count(year, boro, race)

```

```{r}

sqf_boro_misd <- left_join(arrest_yearly_boro_misd_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>%
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, boro, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = nhblack/nhwhite,
         `Hispanic/white` = hispanic/nhwhite) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, boro, race, value) %>% 
    mutate(nudge_y = ifelse(race == "Black/white", 1, -1)) 

  ggplot(data = sqf_boro_misd,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
    geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(boro), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = sqf_boro_misd$nudge_y),
            color = 'black',
            check_overlap = TRUE)
  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.7.tiff", width = 7, height = 4)

```


```{r}

# figures for table on misd disparities by boro


left_join(arrest_yearly_boro_misd_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>%
   mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, boro, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") 



```




```{r}

arrest_yearly_boro_fel_race <-
  full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  rename(boro = arrest_boro) %>% 
    mutate(boro = case_when(boro == "K" ~ "Brooklyn",
                          boro == "B" ~ "Bronx",
                          boro == "M" ~ "Manhattan",
                          boro == "Q" ~ "Queens",
                          boro == "S" ~ "Staten Island")) %>% 
  filter(!is.na(race),
         !is.na(boro)) %>% 
  count(year, boro, race)

```

```{r}

sqf_boro_fel <- left_join(arrest_yearly_boro_fel_race, PD_census_boro_race,  by = c("year" = "year", "boro" = "boro", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, boro, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = nhblack/nhwhite,
         `Hispanic/white` = hispanic/nhwhite) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, boro, race, value) %>% 
    mutate(nudge_y = ifelse(race == "Black/white", 1.7, -1.7)) 

  ggplot(data = sqf_boro_fel,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(boro), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = sqf_boro_fel$nudge_y),
            color = 'black',
            check_overlap = TRUE)+
    expand_limits(y = 25)
  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.8.tiff", width = 7, height = 4)

```

```{r}



full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
  mutate(sex = case_when(perp_sex == "F" ~ "Female",
                         perp_sex == "M" ~ "Male")) %>% 
  group_by(year, sex) %>% 
  summarise(n = n()) %>% 
  filter(year %in% c("2013", "2022")) %>% 
  pivot_wider(names_from = year, values_from = n) %>% 
  mutate(diff = `2013` - `2022`,
         percent_change = diff/`2013`)
 

```


```{r}

full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(sex = case_when(perp_sex == "F" ~ "Female",
                         perp_sex == "M" ~ "Male")) %>% 
  group_by(year, sex) %>% 
  summarise(n = n()) %>% 
  filter(year %in% c("2013", "2022")) %>% 
  pivot_wider(names_from = year, values_from = n) %>% 
  mutate(diff = `2013` - `2022`,
         percent_change = diff/`2013`)


```


```{r}

full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  mutate(sex = case_when(perp_sex == "F" ~ "Women",
                         perp_sex == "M" ~ "Men")) %>% 
  mutate(sex = fct_relevel(sex, "Women", "Men")) %>% 
    mutate(severity = fct_relevel(severity,  "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  group_by(year, severity, sex) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
 ggplot(aes(x = year, y = percent, fill = sex)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
   theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#2CAAE2","#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(aes(label = sprintf("%d%%", percent)), position = position_fill(vjust = 0.5), size = 3, color = "white", fontface = "bold") +
    facet_wrap2(vars(severity), axes = "x") 

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.9.tiff", width = 7, height = 4)

```


```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
  mutate(sex = case_when(perp_sex == "F" ~ "Women",
                         perp_sex == "M" ~ "Men")) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  group_by(year, sex, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
 theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(sex), axes = "x") +
   geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic", "White"), sprintf("%d%%", percent), "")), size = 3, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_4.10.tiff", width = 7, height = 4)



```


```{r}

arrest_yearly_sex_misd_race <-
  full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
mutate(sex = case_when(perp_sex == "F" ~ "female",
                         perp_sex == "M" ~ "male")) %>%
  filter(!is.na(race),
         !is.na(sex)) %>% 
  count(year, sex, race)

```


```{r}

arrest_sex_misd <- left_join(arrest_yearly_sex_misd_race, PD_census_sex_race,  by = c("year" = "year", "sex" = "sex", "race" = "race")) %>% 
        mutate(sex = case_when(sex == "female" ~ "Women",
                         sex == "male" ~ "Men"))  %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, sex, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, sex, race, value) %>%
  mutate(nudge_y = ifelse(race == "Black/white", .3, -.3)) 

  ggplot(data = arrest_sex_misd,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
    geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,8,2)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(sex), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = arrest_sex_misd$nudge_y),
            color = 'black',
            check_overlap = TRUE)+
    expand_limits(y = 8)

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_4.10.tiff", width = 7, height = 4)

```

```{r}

arrest_yearly_sex_fel_race <-
  full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
mutate(sex = case_when(perp_sex == "F" ~ "female",
                         perp_sex == "M" ~ "male")) %>%
  filter(!is.na(race),
         !is.na(sex)) %>% 
  count(year, sex, race)

```


```{r}

arrest_sex_fel <- left_join(arrest_yearly_sex_fel_race, PD_census_sex_race,  by = c("year" = "year", "sex" = "sex", "race" = "race")) %>% 
        mutate(sex = case_when(sex == "female" ~ "Women",
                         sex == "male" ~ "Men"))  %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, sex, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, sex, race, value) %>%
  mutate(nudge_y = ifelse(race == "Black/white", .3, -.4)) 

  ggplot(data = arrest_sex_fel,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,10,2)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(sex), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = arrest_sex_fel$nudge_y),
            color = 'black',
            check_overlap = TRUE)+
    expand_limits(y = 10.1)

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_4.11.tiff", width = 7, height = 4)

```



```{r}

# figures for table on misd disparities by sex


left_join(arrest_yearly_sex_misd_race, PD_census_sex_race,  by = c("year" = "year", "sex" = "sex", "race" = "race")) %>% 
        mutate(sex = case_when(sex == "female" ~ "Women",
                         sex == "male" ~ "Men"))  %>%
   mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, sex, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") 



```


```{r}

# figures for table on fel disparities by sex


left_join(arrest_yearly_sex_fel_race, PD_census_sex_race,  by = c("year" = "year", "sex" = "sex", "race" = "race")) %>% 
        mutate(sex = case_when(sex == "female" ~ "Women",
                         sex == "male" ~ "Men"))  %>%
   mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, sex, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") 



```


```{r}


full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
    mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
  group_by(year, age_cat) %>% 
  summarise(n = n()) %>% 
  filter(year %in% c("2013", "2022")) %>% 
  pivot_wider(names_from = year, values_from = n) %>% 
  mutate(diff = `2013` - `2022`,
         percent_change = diff/`2013`)


```

```{r}


full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
    mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
  group_by(year, age_cat) %>% 
  summarise(n = n()) %>% 
  filter(year %in% c("2013", "2022")) %>% 
  pivot_wider(names_from = year, values_from = n) %>% 
  mutate(diff = `2013` - `2022`,
         percent_change = diff/`2013`)


```


```{r}

full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
    mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
    mutate(severity = fct_relevel(severity,  "Misdemeanor or less", "Felony")) %>% 
      mutate(age_cat = fct_relevel(age_cat, "45+","25-44","<25")) %>% 
  filter(!is.na(severity)) %>% 
  group_by(year, severity, age_cat) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
 ggplot(aes(x = year, y = percent, fill = age_cat)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
   theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
    scale_fill_manual(values = c("#e3800e","#2CAAE2","#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = percent_format()) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(aes(label = sprintf("%d%%", percent)), position = position_fill(vjust = 0.5), size = 3, color = "white", fontface = "bold") +
    facet_wrap2(vars(severity), axes = "x") 

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.12.tiff", width = 7, height = 4)



```

```{r}


full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
      mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
    mutate(severity = fct_relevel(severity,  "Misdemeanor or less", "Felony")) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
 theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
   geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic", "White"), sprintf("%d%%", percent), "")), size = 3, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_4.13.tiff", width = 7, height = 4)


```



```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
      mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
 theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 2) +
   geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic", "White"), sprintf("%d%%", percent), "")), size = 3, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_appendix_2.tiff", width = 7, height = 4)


```

```{r}

PD_census_age_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  mutate(age_cat = case_when(age_group >= 3 & age_group <= 5 ~ "<25",
                             age_group >= 6 & age_group <= 9 ~ "25-44",
                             age_group >= 10 ~ "45+")) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(total_pop = sum(value))

```

```{r}

arrest_yearly_age_race_misd <- full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
  mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
  filter(race != "Other",
         !is.na(age_cat)) %>% 
  count(year, age_cat, race)


```


```{r}

arrest_yearly_age_race_fel <- full_pd %>% 
    mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(age_cat = case_when(age_group %in% c("<18", "18-24") ~ "<25",
                             age_group == "25-44" ~ "25-44",
                             age_group %in% c("45-64", "65+") ~ "45+")) %>% 
  filter(race != "Other",
         !is.na(age_cat)) %>% 
  count(year, age_cat, race)


```


```{r}

arrest_age_misd <- left_join(arrest_yearly_age_race_misd, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, age_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, age_cat, race, value) %>%
  mutate(nudge_y = ifelse(race == "Black/white", .3, -.4)) 

  ggplot(data = arrest_age_misd,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,8,2)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(age_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = arrest_age_misd$nudge_y),
            color = 'black',
            check_overlap = TRUE)+
    expand_limits(y = 8)

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_4.14.tiff", width = 7, height = 4)



```


```{r}

# figures for table on misd disparities by age


left_join(arrest_yearly_age_race_misd, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
   mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") 

```


```{r}

# figures for table on fel disparities by age


left_join(arrest_yearly_age_race_fel, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
   mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  clean_names() %>% 
  mutate(`'22 vs '13` = round(x2022-x2013,1),
         `'22 vs '19` = round(x2022-x2019,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period") 

```






```{r}

arrest_age_fel <- left_join(arrest_yearly_age_race_fel, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, age_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, age_cat, race, value) %>%
  mutate(nudge_y = ifelse(race == "Black/white", .7, -.7)) 

  ggplot(data = arrest_age_fel,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,18,2)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(age_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = arrest_age_fel$nudge_y),
            color = 'black',
            check_overlap = TRUE)+
    expand_limits(y = 8)

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_4.15.tiff", width = 7, height = 4)

```


```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Misdemeanor or less") %>% 
  mutate(charge_cat = case_when(str_detect(law_code, "PL 15525") ~ "Petit larceny",
                                       str_detect(law_code, "PL 16515") ~ "Theft of services",
                                       str_detect(law_code, "PL 22003") ~ "Misd drug possession",
                                       str_detect(law_code, "PL 221|PL 222") ~ "Marijuana",
                                       str_detect(law_code, "PL 120") & !str_detect(law_code, "PL 12045|PL 12055") ~ "Misd assault & related",
                                       str_detect(law_code, "PL 145") ~ "Criminal mischief",
                                       str_detect(law_code, "VTL0511") ~ "Unlicensed driving",
                                       str_detect(law_code, "PL 26501") ~ "Misd weapon",
                                       str_detect(law_code, "PL 14005|PL 14010|PL 14015") ~ "Trespass")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
    mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat) %>% 
  summarise(n = n()) %>% 
 ggplot(aes(x= year, y = n, fill = year))+
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap(~charge_cat) +
  expand_limits(y = 42000)+
   geom_text(data = . %>% filter(year %in% c(2013,2022),
                                 !charge_cat %in% c("Petit larceny", "Marijuana")),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') +
     geom_text(data = . %>% filter(year %in% c(2013,2020),
                                 charge_cat %in% c("Marijuana")),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') +
     geom_text(data = . %>% filter(year %in% c(2013),
                                 charge_cat %in% c("Petit larceny")),
                  aes(label = scales::comma(n)),
             vjust = -.5,
             hjust = .65,
                  size = 2.5,
            color = 'black') +
     geom_text(data = . %>% filter(year %in% c(2022),
                                 charge_cat %in% c("Petit larceny")),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') 

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.16.tiff", width = 7, height = 4)


```


```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Misdemeanor or less") %>% 
  mutate(charge_cat = case_when(str_detect(law_code, "PL 15525") ~ "Petit larceny",
                                       str_detect(law_code, "PL 16515") ~ "Theft of services",
                                       str_detect(law_code, "PL 22003") ~ "Misd drug possession",
                                       str_detect(law_code, "PL 221|PL 222") ~ "Marijuana",
                                       str_detect(law_code, "PL 120") & !str_detect(law_code, "PL 12045|PL 12050") ~ "Misd assault & related",
                                       str_detect(law_code, "PL 145") ~ "Criminal mischief",
                                       str_detect(law_code, "VTL0511") ~ "Unlicensed driving",
                                       str_detect(law_code, "PL 26501") ~ "Misd weapon",
                                       str_detect(law_code, "PL 14005|PL 14010|PL 14015") ~ "Trespass")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 2.1, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_4.17.tiff", width = 7, height = 4)

```



```{r}

arrest_yearly_misd_charge_race <- 
  full_pd %>% 
   mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Misdemeanor or less") %>% 
mutate(charge_cat = case_when(str_detect(law_code, "PL 15525") ~ "Petit larceny",
                                       str_detect(law_code, "PL 16515") ~ "Theft of services",
                                       str_detect(law_code, "PL 22003") ~ "Misd drug possession",
                                       str_detect(law_code, "PL 221|PL 222") ~ "Marijuana",
                                       str_detect(law_code, "PL 120") & !str_detect(law_code, "PL 12045|PL 12050") ~ "Misd assault & related",
                                       str_detect(law_code, "PL 145") ~ "Criminal mischief",
                                       str_detect(law_code, "VTL0511") ~ "Unlicensed driving",
                                       str_detect(law_code, "PL 26501") ~ "Misd weapon",
                                       str_detect(law_code, "PL 14005|PL 14010|PL 14015") ~ "Trespass")) %>% 
  filter(race != "Other") %>% 
  count(year, charge_cat, race)

```


```{r}

left_join(arrest_yearly_misd_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%  
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = Black/White,
         `Hispanic/white` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>% 
  filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_wider(names_from = year, values_from = value)  %>% 
  mutate(`'22 vs '13` = round(`2022`-`2013`,1),
         `'22 vs '19` = round(`2022`-`2019`,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period")


left_join(arrest_yearly_age_race_fel, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race" = "race")) %>% 
   mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, age_cat, race, rate)  %>%  
  filter(year %in% c("2013", "2019", "2022")) %>%
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/White` = Black/White,
         `Hispanic/White` = Hispanic/White) %>% 
  select(1:2,6:7) %>% 
 filter(year %in% c("2013", "2019", "2022")) %>% 
  pivot_longer(cols = c("Black/White", "Hispanic/White"), names_to = "race") %>% 
  pivot_wider(names_from = year, values_from = value) %>% 
  mutate(`'22 vs '13` = round(`2022`-`2013`,1),
         `'22 vs '19` = round(`2022`-`2019`,1)) %>% 
  select(1:2, 6:7) %>% 
  pivot_longer(cols = c(`'22 vs '13`, `'22 vs '19` ), names_to = "period")


```



```{r}


arrest_charge_misd <- left_join(arrest_yearly_misd_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
    mutate(charge_cat = fct_relevel(charge_cat, "Violent", "Weapon", "Property", "Drug", "Trespass/Public Order", "Other")) %>%  
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = Black/White,
         `Hispanic/white` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>% 
  mutate(nudge_y = ifelse(race == "Black/white", 3.0, -2.0)) 

  ggplot(data = arrest_charge_misd,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022),
                                !charge_cat == "Marijuana"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = arrest_charge_misd$nudge_y),
            color = 'black') +
      geom_text(data = . %>% filter(year %in% c(2013),
                                charge_cat == "Marijuana"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = arrest_charge_misd$nudge_y),
            color = 'black') +
      geom_text(data = . %>% filter(year %in% c(2020),
                                charge_cat == "Marijuana",
                                race == "Black/white"),
                vjust = -1.5,
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5,
            color = 'black') +
          geom_text(data = . %>% filter(year %in% c(2020),
                                charge_cat == "Marijuana",
                                race == "Hispanic/white"),
                vjust = 1,
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5,
            color = 'black') 
  
  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("arrest_figure_4.18.tiff", width = 7, height = 4)

```



```{r}

arrest_yearly_fel_charge_race <- 
  full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_code, "PL 220") ~ "Felony drug possession",
                                  str_detect(law_code, "PL 155") ~ "Grand larceny",
                                  str_detect(law_code, "PL 16005|PL 16010|PL 16015") ~ "Robbery",
                                  str_detect(law_code, "PL 14020|PL 14025|PL 14030") ~ "Burglary",
                                  str_detect(law_code, "PL 12005|PL 12010") ~ "Felony assault",
                                  str_detect(law_code, "PL 265") ~ "Felony weapon")) %>% 
  filter(race != "Other") %>% 
  count(year, charge_cat, race)

```

```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_code, "PL 220") ~ "Felony drug possession",
                                  str_detect(law_code, "PL 155") ~ "Grand larceny",
                                  str_detect(law_code, "PL 16005|PL 16010|PL 16015") ~ "Robbery",
                                  str_detect(law_code, "PL 14020|PL 14025|PL 14030") ~ "Burglary",
                                  str_detect(law_code, "PL 12005|PL 12010") ~ "Felony assault",
                                  str_detect(law_code, "PL 265") ~ "Felony weapon")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
    mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat) %>% 
  summarise(n = n()) %>% 
 ggplot(aes(x= year, y = n, fill = year))+
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap(~charge_cat) +
  expand_limits(y = 42000)+
   geom_text(data = . %>% filter(year %in% c(2013,2022),
                                 !charge_cat == "Grand larceny"),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') +
     geom_text(data = . %>% filter(year %in% c(2013),
                                 charge_cat %in% c("Grand larceny")),
                  aes(label = scales::comma(n)),
             vjust = -.5,
             hjust = .65,
                  size = 2.5,
            color = 'black') +
     geom_text(data = . %>% filter(year %in% c(2022),
                                 charge_cat %in% c("Grand larceny")),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') 

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_4.19.tiff", width = 7, height = 4)

```



```{r}


arrest_charge_fel <- left_join(arrest_yearly_fel_charge_race, PD_census_race,  by = c("year" = "year", "race" = "race")) %>%
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = Black/White,
         `Hispanic/white` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>% 
  mutate(nudge_y = ifelse(race == "Black/white", 1.9, -1.9)) 

  ggplot(data = arrest_charge_fel,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
    geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022),
                                !charge_cat == "Felony weapon"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = arrest_charge_fel$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
      geom_text(data = . %>% filter(year %in% c(2013),
                                charge_cat == "Felony weapon"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = arrest_charge_misd$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
      geom_text(data = . %>% filter(year %in% c(2022),
                                charge_cat == "Felony weapon"),
                hjust = .7,
                vjust = 1.5,
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5,
            color = 'black',
            check_overlap = TRUE) 
          
  
  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_figure_4.21.tiff", width = 7, height = 4)



```

```{r}

full_pd %>% 
  mutate(severity = case_when(law_cat_cd == "F" ~ "Felony",
                              law_cat_cd %in% c("I","M","V") ~ "Misdemeanor or less")) %>% 
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_code, "PL 220") ~ "Felony drug possession",
                                  str_detect(law_code, "PL 155") ~ "Grand larceny",
                                  str_detect(law_code, "PL 16005|PL 16010|PL 16015") ~ "Robbery",
                                  str_detect(law_code, "PL 14020|PL 14025|PL 14030") ~ "Burglary",
                                  str_detect(law_code, "PL 12005|PL 12010") ~ "Felony assault",
                                  str_detect(law_code, "PL 265") ~ "Felony weapon")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 2.1, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("sqf_appendix_3.tiff", width = 7, height = 4)


```


##Prosecution


```{r}

full_pros <- read_csv("prosecutions_decade.csv")


```


```{r}

full_pros <- full_pros %>% 
  mutate(year = year(date)) %>% 
  mutate(race = case_when((race == "Black" & hispanic == "FALSE") ~ "nhblack",
                          (race == "White" & hispanic == "FALSE") ~ "nhwhite",
                          hispanic == "TRUE" ~ "hispanic",
                          TRUE ~ "Other")) 

```


```{r}

full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  group_by(year, severity) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x= year, y = n, fill = year))+
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 7.5)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap(~severity) +
  expand_limits(y = 42000)+
   geom_text(data = . %>% filter(year %in% c(2013,2020,2022)),
                  aes(label = scales::comma(n)),
             vjust = -.3,
                  size = 2.5,
            color = 'black') 

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("pros_figure_5.1.tiff", width = 7, height = 4)

```

```{r}

full_pros %>% 
  mutate(county = case_when(county == "BRONX" ~ "Bronx",
                            county == "KINGS" ~ "Brooklyn",
                            county == "NEW YORK" ~ "Manhattan",
                            county == "QUEENS" ~ "Queens",
                            county == "RICHMOND" ~ "Staten Island")) %>% 
  rename(boro = county) %>% 
  group_by(year, boro) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x= year, y = n, fill = year))+
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 7.5)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma, breaks = seq(0,120000,20000)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap2(vars(boro), axes = "x") +
  expand_limits(y = 120000)+
   geom_text(data = . %>% filter(year %in% c(2013,2022)),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') 

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("pros_figure_5.2.tiff", width = 7, height = 4)

```

```{r}

full_pros %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(!is.na(severity)) %>% 
  group_by(year, severity, race) %>%  
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_reorder(race, percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
 theme(axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(severity), axes = "x") +
   geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic", "White"), sprintf("%d%%", percent), "")), size = 3, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")
  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("pros_figure_5.3.tiff", width = 7, height = 4)


```



```{r}

pros_yearly_severity_race <- full_pros %>% 
 mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  mutate(severity = fct_relevel(severity, "Misdemeanor or less", "Felony")) %>% 
  filter(race != "Other",
         !is.na(severity)) %>% 
  count(year, severity, race)

```

```{r}


pros_sev <- left_join(pros_yearly_severity_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>% 
  mutate(race = case_when(race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          race == "nhwhite" ~ "White")) %>%  
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, severity, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = Black/White,
         `Hispanic/white` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, severity, race, value) %>%
  filter(year != 2015) %>% 
    mutate(nudge_y = ifelse(race == "Black/white", .3, -.3)) 

  ggplot(data = pros_sev,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7.5),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = comma, breaks = seq(0,10,2)) +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(severity), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022)),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = pros_sev$nudge_y),
            color = 'black',
            check_overlap = TRUE)+
    expand_limits(y = 10.1)

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("pros_figure_5.4.tiff", width = 7, height = 4)

```





```{r}

# sort prosecuted charges into charge categories

full_pros <- full_pros %>% 
  mutate(law_charge = str_replace(law_charge, '`', '')) %>% 
  mutate(law_charge = str_replace(law_charge, ' ', '')) %>% 
  mutate(law_charge = str_replace(law_charge, "'", '')) %>% 
  mutate(law_charge = str_replace(law_charge, '[.]', '')) 

```

```{r}

pros_yearly_misd_charge_race <- full_pros %>%
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
    mutate(charge_cat = case_when(str_detect(law_charge, "PL15525") ~ "Petit larceny",
                                       str_detect(law_charge, "PL16515") ~ "Theft of services",
                                       str_detect(law_charge, "PL22003") ~ "Misd drug possession",
                                       str_detect(law_charge, "PL221|PL222") ~ "Marijuana",
                                       str_detect(law_charge, "PL120") & !str_detect(law_charge, "PL12045|PL12055") ~ "Misd assault & related",
                                       str_detect(law_charge, "PL145") ~ "Criminal mischief",
                                       str_detect(law_charge, "VTL511") ~ "Unlicensed driving",
                                       str_detect(law_charge, "PL26501") ~ "Misd weapon",
                                       str_detect(law_charge, "PL14005|PL14010|PL14015") ~ "Trespass")) %>% 
  filter(race != "Other",
         age > 9,
         !is.na(charge_cat)) %>% 
  count(year, charge_cat, race)

```


```{r}

pros_misd_charge <- left_join(pros_yearly_misd_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = Black/White,
         `Hispanic/white` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>%
  filter(year!=2015) %>% 
    mutate(nudge_y = ifelse(race == "Black/white", 2, -.9)) 

  ggplot(data = pros_misd_charge,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 7.5),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma,
                     breaks = scales::pretty_breaks(n = 5)) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022),
                                !charge_cat == "Marijuana"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = pros_misd_charge$nudge_y),
            color = 'black') +
    geom_text(data = . %>% filter(year %in% c(2013, 2022),
                                charge_cat == "Marijuana",
                                year == 2013),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = pros_misd_charge$nudge_y),
            color = 'black') +
      geom_text(data = . %>% filter(year %in% c(2013, 2020),
                                charge_cat == "Marijuana",
                                race == "Black/white",
                                year == 2020),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             vjust = 2.2,
             hjust = .65,
            color = 'black') +
      geom_text(data = . %>% filter(year %in% c(2013, 2020),
                                charge_cat == "Marijuana",
                                race == "Hispanic/white",
                                year == 2020),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             vjust = 1.5,
            color = 'black') 

setwd("C:/R Projects/Police Reform/Graphs")
ggsave("pros_figure_5.5.tiff", width = 7, height = 4)

```



```{r}

pros_yearly_fel_charge_race <- full_pros %>%
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_charge, "PL220") ~ "Felony drug possession",
                                  str_detect(law_charge, "PL155") ~ "Grand larceny",
                                  str_detect(law_charge, "PL16005|PL16010|PL16015") ~ "Robbery",
                                  str_detect(law_charge, "PL14020|PL14025|PL14030") ~ "Burglary",
                                  str_detect(law_charge, "PL12005|PL12010") ~ "Felony assault",
                                  str_detect(law_charge, "PL265") ~ "Felony weapon")) %>% 
  filter(race != "Other",
         age > 9,
         !is.na(charge_cat)) %>% 
  count(year, charge_cat, race)

```

```{r}

pros_fel_charge <- left_join(pros_yearly_fel_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = Black/White,
         `Hispanic/white` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>%
  filter(year!=2015) %>% 
   mutate(nudge_y = ifelse(race == "Black/white", 1.4, -1.4)) 

  ggplot(data = pros_fel_charge,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 7.5),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma,
                     breaks = scales::pretty_breaks(n = 5)) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022),
                                !charge_cat == "Felony weapon"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = pros_fel_charge$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
      geom_text(data = . %>% filter(year %in% c(2013),
                                charge_cat == "Felony weapon"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = pros_fel_charge$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
      geom_text(data = . %>% filter(year %in% c(2022),
                                charge_cat == "Felony weapon",
                                race == "Hispanic/white"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = pros_fel_charge$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
      geom_text(data = . %>% filter(year %in% c(2022),
                                charge_cat == "Felony weapon",
                                race == "Black/white"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             vjust = 1.1,
            color = 'black',
            check_overlap = TRUE) 
  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("pros_figure_5.6.tiff", width = 7, height = 4)
  

```


```{r}

pros_fel_charge <- left_join(pros_yearly_fel_charge_race, OCA_census_race,  by = c("year" = "year", "race" = "race")) %>%
  mutate(race = case_when(race == "hispanic" ~ "Hispanic",
                          race == "nhblack" ~ "Black",
                          race == "nhwhite" ~ "White")) %>% 
   mutate(rate = (n/total_pop)*100000) %>% 
  select(year, charge_cat, race, rate)  %>%  
  pivot_wider(names_from = race, values_from = rate) %>% 
  mutate(`Black/white` = Black/White,
         `Hispanic/white` = Hispanic/White) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, charge_cat, race, value) %>%
  filter(year!=2015) %>% 
   mutate(nudge_y = ifelse(race == "Black/white", 2.0, -2.0)) 

  ggplot(data = pros_fel_charge,
         aes(year, value, color = race, label = value)) +
  geom_line(key_glyph = draw_key_point) +
  geom_point(data = . %>% filter(year %in% c(2013, 2022))) +
  theme_classic() +
  theme(axis.text = element_text(size = 7.5),
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "white"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 12), 
        panel.grid.major = element_blank()) +
  theme(plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        axis.ticks.x = element_blank(), 
        plot.title = element_text(size = 15, face = "bold"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top", 
        panel.grid.major.y = element_line(linetype = "solid", size = .5)) +
  scale_y_continuous(labels = comma,
                     breaks = scales::pretty_breaks(n = 5)) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '') +
  scale_colour_manual(values = c("#233267", "#2CAAE2")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5))) +
  facet_wrap2(vars(charge_cat), axes = "x") +
  easy_remove_y_axis(what = c("line", "ticks")) +
   scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  geom_text(data = . %>% filter(year %in% c(2013, 2022),
                                !charge_cat == "Felony weapon"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = pros_fel_charge$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
      geom_text(data = . %>% filter(year %in% c(2013),
                                charge_cat == "Felony weapon"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = pros_fel_charge$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
      geom_text(data = . %>% filter(year %in% c(2022),
                                charge_cat == "Felony weapon",
                                race == "Hispanic/white"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             position = position_nudge(y = pros_fel_charge$nudge_y),
            color = 'black',
            check_overlap = TRUE) +
      geom_text(data = . %>% filter(year %in% c(2022),
                                charge_cat == "Felony weapon",
                                race == "Black/white"),
                  aes(label = sprintf("%.1f", value)),
                  size = 2.5, 
             vjust = 1.5,
            color = 'black',
            check_overlap = TRUE) 
  
setwd("C:/R Projects/Police Reform/Graphs")
ggsave("pros_figure_5.6.tiff", width = 7, height = 4)



```


```{r}


full_pros %>%
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
    mutate(charge_cat = case_when(str_detect(law_charge, "PL15525") ~ "Petit larceny",
                                       str_detect(law_charge, "PL16515") ~ "Theft of services",
                                       str_detect(law_charge, "PL22003") ~ "Misd drug possession",
                                       str_detect(law_charge, "PL221|PL222") ~ "Marijuana",
                                       str_detect(law_charge, "PL120") & !str_detect(law_charge, "PL12045|PL12055") ~ "Misd assault & related",
                                       str_detect(law_charge, "PL145") ~ "Criminal mischief",
                                       str_detect(law_charge, "VTL511") ~ "Unlicensed driving",
                                       str_detect(law_charge, "PL26501") ~ "Misd weapon",
                                       str_detect(law_charge, "PL14005|PL14010|PL14015") ~ "Trespass")) %>% 
  filter(!is.na(charge_cat)) %>% 
  group_by(year, charge_cat) %>% 
  summarise(n = n()) %>% 
 ggplot(aes(x= year, y = n, fill = year))+
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap(~charge_cat) +
  expand_limits(y = 45000)+
   geom_text(data = . %>% filter(year %in% c(2013,2022),
                                 !charge_cat == "Unlicensed driving"),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') +
       geom_text(data = . %>% filter(year %in% c(2013),
                                 charge_cat %in% c("Unlicensed driving")),
                  aes(label = scales::comma(n)),
             vjust = -.5,
             hjust = .65,
                  size = 2.5,
            color = 'black') +
     geom_text(data = . %>% filter(year %in% c(2022),
                                 charge_cat %in% c("Unlicensed driving")),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') 



setwd("C:/R Projects/Police Reform/Graphs")
ggsave("pros_appendix_misd.tiff", width = 7, height = 4)


```

```{r}

full_pros %>%
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Misdemeanor or less") %>% 
    mutate(charge_cat = case_when(str_detect(law_charge, "PL15525") ~ "Petit larceny",
                                       str_detect(law_charge, "PL16515") ~ "Theft of services",
                                       str_detect(law_charge, "PL22003") ~ "Misd drug possession",
                                       str_detect(law_charge, "PL221|PL222") ~ "Marijuana",
                                       str_detect(law_charge, "PL120") & !str_detect(law_charge, "PL12045|PL12055") ~ "Misd assault & related",
                                       str_detect(law_charge, "PL145") ~ "Criminal mischief",
                                       str_detect(law_charge, "VTL511") ~ "Unlicensed driving",
                                       str_detect(law_charge, "PL26501") ~ "Misd weapon",
                                       str_detect(law_charge, "PL14005|PL14010|PL14015") ~ "Trespass")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 2.1, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("appendix_pros_misd_race.tiff", width = 7, height = 4)


```

```{r}

full_pros %>%
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_charge, "PL220") ~ "Felony drug possession",
                                  str_detect(law_charge, "PL155") ~ "Grand larceny",
                                  str_detect(law_charge, "PL16005|PL16010|PL16015") ~ "Robbery",
                                  str_detect(law_charge, "PL14020|PL14025|PL14030") ~ "Burglary",
                                  str_detect(law_charge, "PL12005|PL12010") ~ "Felony assault",
                                  str_detect(law_charge, "PL265") ~ "Felony weapon")) %>% 
  filter(!is.na(charge_cat)) %>% 
  group_by(year, charge_cat) %>% 
  summarise(n = n()) %>% 
 ggplot(aes(x= year, y = n, fill = year))+
  geom_bar(stat = "identity", fill = "#233267") +
  theme_classic() +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "white"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 6)) +
  theme(plot.background = element_rect(fill = "NA"),
        panel.background = element_rect(fill = "NA"),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 15, face = "bold"),
        legend.background  = element_rect(fill = "white", color = NA),
        legend.position = "top",
        panel.grid.major.y = element_line(linetype = "solid", size = .5, color = "grey")) +
  scale_y_continuous(labels = comma) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
   scale_x_continuous(breaks = seq(2013,2022,1),
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22"))+
  facet_wrap(~charge_cat) +
  expand_limits(y = 15000)+
   geom_text(data = . %>% filter(year %in% c(2013,2022)),
                  aes(label = scales::comma(n)),
             vjust = -.5,
                  size = 2.5,
            color = 'black') 


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("appendix_pros_fel.tiff", width = 7, height = 4)

```

```{r}

full_pros %>%
    mutate(severity = case_when(severity == "Felony" ~ "Felony",
                              severity %in% c("Misdemeanor","Violation/infraction") ~ "Misdemeanor or less")) %>%
  filter(severity == "Felony") %>% 
  mutate(charge_cat = case_when  (str_detect(law_charge, "PL220") ~ "Felony drug possession",
                                  str_detect(law_charge, "PL155") ~ "Grand larceny",
                                  str_detect(law_charge, "PL16005|PL16010|PL16015") ~ "Robbery",
                                  str_detect(law_charge, "PL14020|PL14025|PL14030") ~ "Burglary",
                                  str_detect(law_charge, "PL12005|PL12010") ~ "Felony assault",
                                  str_detect(law_charge, "PL265") ~ "Felony weapon")) %>% 
  filter(!is.na(charge_cat)) %>% 
  mutate(race = case_when(race == "nhwhite" ~ "White",
                          race == "nhblack" ~ "Black",
                          race == "hispanic" ~ "Hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(race = fct_relevel(race, "Other", "White", "Hispanic", "Black")) %>% 
  group_by(year, charge_cat, race) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 6),
        axis.ticks.x = element_blank(), 
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "top") +
  scale_fill_manual(values = c("#B3B3B3","#e3800e", "#2CAAE2", "#233267"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(charge_cat), axes = "x", nrow = 3) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic"), sprintf("%d%%", percent), "")), size = 2.6, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")


setwd("C:/R Projects/Police Reform/Graphs")
ggsave("appendix_pros_fel_race.tiff", width = 7, height = 4)



```

